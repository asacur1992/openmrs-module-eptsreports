package org.openmrs.module.eptsreports.reporting.library.queries;

public interface TxTbPrevQueriesInterface {

  class QUERY {
    public static final String findPatientWhoStartedTpi =
        "select inicio_tpi.patient_id from ( "
            + "select p.patient_id,min(o.value_datetime) data_inicio_tpi from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and p.voided=0 and o.value_datetime between :startDate - interval 6 month and :endDate - interval 6 month and "
            + "o.voided=0 and o.concept_id=6128 and e.encounter_type in (6,9,53) and e.location_id=:location "
            + "group by p.patient_id "
            + "union  "
            + "select p.patient_id,min(e.encounter_datetime) data_inicio_tpi "
            + "from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and p.voided=0 and e.encounter_datetime between :startDate - interval 6 month and :endDate - interval 6 month and "
            + "o.voided=0 and o.concept_id=6122 and o.value_coded=1256 and e.encounter_type=6 and  e.location_id=:location group by p.patient_id) inicio_tpi ";

    public static final String findPatientsWhoStartedArtAndTpiNewDessagragation =
        "select inicio_tpi.patient_id from ( "
            + "select patient_id, min(data_inicio_tpi) data_inicio_tpi from ( "
            + "select p.patient_id,min(o.value_datetime) data_inicio_tpi from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and p.voided=0 and o.value_datetime between :startDate - interval 6 month and :endDate - interval 6 month and "
            + "o.voided=0 and o.concept_id=6128 and e.encounter_type in (6,9,53) and e.location_id=:location group by p.patient_id "
            + "union "
            + "select p.patient_id,min(e.encounter_datetime) data_inicio_tpi from  patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and p.voided=0 and e.encounter_datetime between :startDate - interval 6 month and :endDate - interval 6 month and "
            + "o.voided=0 and o.concept_id=6122 and o.value_coded=1256 and e.encounter_type=6 and  e.location_id=:location group by p.patient_id) startTPI group by patient_id) inicio_tpi "
            + "inner join (Select patient_id,min(data_inicio) data_inicio from( "
            + "select p.patient_id,min(e.encounter_datetime) data_inicio from  patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and o.voided=0 and p.voided=0 and  e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and e.encounter_datetime<=:endDate and e.location_id=:location group by p.patient_id "
            + "union "
            + "select p.patient_id,min(value_datetime) data_inicio from  patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and  o.concept_id=1190 and o.value_datetime is not null and  o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id "
            + "union "
            + "select pg.patient_id,min(date_enrolled) data_inicio from patient p "
            + "inner join patient_program pg on p.patient_id=pg.patient_id "
            + "where pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate and location_id=:location group by pg.patient_id "
            + "union "
            + "SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio FROM patient p "
            + "inner join encounter e on p.patient_id=e.patient_id WHERE "
            + "p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location GROUP BY  p.patient_id "
            + "union "
            + "select p.patient_id,min(value_datetime) data_inicio from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=:location2 and "
            + "o.concept_id=23866 and o.value_datetime is not null and  o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id) inicio_real group by patient_id) "
            + "inicioTarv on inicioTarv.patient_id=inicio_tpi.patient_id and inicio_tpi.data_inicio_tpi <= DATE_ADD(inicioTarv.data_inicio, INTERVAL 6 MONTH) ";

    public static final String findPatientsWhoStartedArtAndTpiPreviouslyDessagragation =
        "select inicio_tpi.patient_id from ( "
            + "select patient_id, min(data_inicio_tpi) data_inicio_tpi from ( "
            + "select p.patient_id,min(o.value_datetime) data_inicio_tpi from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and p.voided=0 and o.value_datetime between :startDate - interval 6 month and :endDate - interval 6 month and "
            + "o.voided=0 and o.concept_id=6128 and e.encounter_type in (6,9,53) and e.location_id=:location group by p.patient_id "
            + "union "
            + "select p.patient_id,min(e.encounter_datetime) data_inicio_tpi from  patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and p.voided=0 and e.encounter_datetime between :startDate - interval 6 month and :endDate - interval 6 month and "
            + "o.voided=0 and o.concept_id=6122 and o.value_coded=1256 and e.encounter_type=6 and  e.location_id=:location group by p.patient_id) startTPI group by patient_id) inicio_tpi "
            + "inner join (Select patient_id,min(data_inicio) data_inicio from( "
            + "select p.patient_id,min(e.encounter_datetime) data_inicio from  patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and o.voided=0 and p.voided=0 and  e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and e.encounter_datetime<=:endDate and e.location_id=:location group by p.patient_id "
            + "union "
            + "select p.patient_id,min(value_datetime) data_inicio from  patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and  o.concept_id=1190 and o.value_datetime is not null and  o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id "
            + "union "
            + "select pg.patient_id,min(date_enrolled) data_inicio from patient p "
            + "inner join patient_program pg on p.patient_id=pg.patient_id "
            + "where pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate and location_id=:location group by pg.patient_id "
            + "union "
            + "SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio FROM patient p "
            + "inner join encounter e on p.patient_id=e.patient_id WHERE "
            + "p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location GROUP BY  p.patient_id "
            + "union "
            + "select p.patient_id,min(value_datetime) data_inicio from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=:location2 and "
            + "o.concept_id=23866 and o.value_datetime is not null and  o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id) inicio_real group by patient_id) "
            + "inicioTarv on inicioTarv.patient_id=inicio_tpi.patient_id and inicio_tpi.data_inicio_tpi > DATE_ADD(inicioTarv.data_inicio, INTERVAL 6 MONTH) ";

    public static final String findPatientsWhoStartedTpi6MonthsAgoAndWhoEndedTpi =
        "select inicio_tpi.patient_id from ( "
            + "select patient_id, min(data_inicio_tpi) data_inicio_tpi from( "
            + "select p.patient_id,min(o.value_datetime) data_inicio_tpi from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and p.voided=0 and o.value_datetime between :startDate - interval 6 month and :endDate - interval 6 month and "
            + "o.voided=0 and o.concept_id=6128 and e.encounter_type in (6,9,53) and e.location_id=:location group by p.patient_id "
            + "union "
            + "select p.patient_id,min(e.encounter_datetime) data_inicio_tpi from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and p.voided=0 and e.encounter_datetime between :startDate - interval 6 month and :endDate - interval 6 month and "
            + "o.voided=0 and o.concept_id=6122 and o.value_coded=1256 and e.encounter_type=6 and  e.location_id=:location group by p.patient_id) startTPI group by patient_id ) inicio_tpi "
            + "inner join ("
            + "select patient_id, max(data_final_tpi) data_final_tpi from ( "
            + "select p.patient_id,max(o.value_datetime) data_final_tpi from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and p.voided=0 and o.value_datetime between :startDate - interval 6 month and :endDate and "
            + "o.voided=0 and o.concept_id=6129 and e.encounter_type in (6,9,53) and e.location_id=:location group by p.patient_id "
            + "union  "
            + "select p.patient_id,max(e.encounter_datetime) data_final_tpi from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and p.voided=0 and e.encounter_datetime between :startDate - interval 6 month and :endDate and o.voided=0 and o.concept_id=6122 and o.value_coded=1267 and e.encounter_type=6 and  e.location_id=:location group by p.patient_id) endTPI "
            + "group by patient_id) termino_tpi on inicio_tpi.patient_id=termino_tpi.patient_id and termino_tpi.data_final_tpi>=inicio_tpi.data_inicio_tpi + interval 173 day "
            + "union "
            + "select inicio_tpi.patient_id from ( "
            + "select patient_id, min(data_inicio_tpi) data_inicio_tpi from ( "
            + "select p.patient_id,min(o.value_datetime) data_inicio_tpi from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and p.voided=0 and o.value_datetime between :startDate - interval 6 month and :endDate - interval 6 month and o.voided=0 and o.concept_id=6128 and e.encounter_type in (6,9,53) and e.location_id=:location "
            + "group by p.patient_id  "
            + "union  "
            + "select p.patient_id,min(e.encounter_datetime) data_inicio_tpi from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and p.voided=0 and e.encounter_datetime between :startDate - interval 6 month and :endDate - interval 6 month and "
            + "o.voided=0 and o.concept_id=6122 and o.value_coded=1256 and e.encounter_type=6 and  e.location_id=:location group by p.patient_id) startTPI group by patient_id) inicio_tpi "
            + "inner join encounter e on e.patient_id=inicio_tpi.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.encounter_type in (6,9) and e.voided=0 and e.encounter_datetime > data_inicio_tpi and e.encounter_datetime<=data_inicio_tpi + interval 7 month and "
            + "o.concept_id=6122 and o.value_coded in (1257,1065) and o.voided=0 and e.location_id=:location "
            + "group by inicio_tpi.patient_id having count(*)>=5 ";

    public static final String findPatientsTransferredOut =
        "select transferidopara.patient_id from ( "
            + "select patient_id,max(data_transferidopara) data_transferidopara from ( "
            + "select pg.patient_id,max(ps.start_date) data_transferidopara from patient p "
            + "inner join patient_program pg on p.patient_id=pg.patient_id "
            + "inner join patient_state ps on pg.patient_program_id=ps.patient_program_id "
            + "where pg.voided=0 and ps.voided=0 and p.voided=0 and  pg.program_id=2 and ps.state=7 and ps.end_date is null and ps.start_date>=:startDate - interval 6 month and  ps.start_date<=:endDate and location_id=:location group by p.patient_id "
            + "union "
            + "select p.patient_id,max(e.encounter_datetime) data_transferidopara from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id where  e.voided=0 and p.voided=0 and e.encounter_datetime >=:startDate - interval 6 month and e.encounter_datetime<=:endDate and "
            + "o.voided=0 and o.concept_id=2016 and o.value_coded in (1706,23863) and e.encounter_type=21 and  e.location_id=:location group by p.patient_id "
            + "union "
            + "select p.patient_id,max(o.obs_datetime) data_transferidopara from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where  e.voided=0 and p.voided=0 and o.obs_datetime>=:startDate - interval 6 month  and o.obs_datetime<=:endDate and "
            + "o.voided=0 and o.concept_id=6272 and o.value_coded=1706 and e.encounter_type=53 and  e.location_id=:location group by p.patient_id "
            + "union "
            + "select p.patient_id,max(e.encounter_datetime) data_transferidopara from  patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and p.voided=0 and e.encounter_datetime>=:startDate - interval 6 month and e.encounter_datetime<=:endDate and "
            + "o.voided=0 and o.concept_id=6273 and o.value_coded=1706 and e.encounter_type=6 and  e.location_id=:location group by p.patient_id) transferido group by patient_id) transferidopara "
            + "inner join (select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
            + "inner join encounter e on e.patient_id=p.patient_id "
            + "where p.voided=0 and e.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location and e.encounter_type in (18,6,9) group by p.patient_id "
            + "union "
            + "select p.patient_id,max(value_datetime) encounter_datetime "
            + "from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and o.concept_id=23866 and o.value_datetime is not null and o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id "
            + " ) consultaOuARV on transferidopara.patient_id=consultaOuARV.patient_id "
            + "where consultaOuARV.encounter_datetime<=transferidopara.data_transferidopara ";
  }
}
