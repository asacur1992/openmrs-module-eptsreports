/** */
package org.openmrs.module.eptsreports.reporting.library.queries;

/** @author St√©lio Moiane */
public interface PatientsWhoMissedAndPickedUpDrugsQueries {

  class QUERY {
    public static final String patientsScheduledToPickUpART =
        "	select marcado.patient_id\n"
            + "	from\n"
            + "	\n"
            + "		(\n"
            + "			select patient_id, data_consulta,max(data_proxima_consulta) data_proxima_consulta\n"
            + "			from \n"
            + "			(\n"
            + "				Select  p.patient_id,e.encounter_datetime data_consulta,o.value_datetime data_proxima_consulta\n"
            + "				from    patient p \n"
            + "						inner join encounter e on p.patient_id=e.patient_id \n"
            + "						inner join obs o on o.encounter_id=e.encounter_id\n"
            + "				where 	e.voided=0 and p.voided=0 and o.voided=0 and o.concept_id=5096 and e.encounter_type=18 and  \n"
            + "						o.value_datetime between :startDate and :endDate and e.location_id=:location and e.encounter_datetime<=:endDate\n"
            + "				\n"
            + "				\n"
            + "				UNION\n"
            + "\n"
            + "				Select 	p.patient_id,o.value_datetime data_consulta,(o.value_datetime + INTERVAL 30 day) data_proxima_consulta\n"
            + "				from 	patient p\n"
            + "						inner join encounter e on p.patient_id=e.patient_id\n"
            + "						inner join obs o on e.encounter_id=o.encounter_id\n"
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and \n"
            + "						o.concept_id=23866 and o.value_datetime is not null and \n"
            + "						o.value_datetime<=:endDate and e.location_id=:location and \n"
            + "						(o.value_datetime + interval 30 day) between :startDate and :endDate \n"
            + "					\n"
            + "			) consultaRecepcao\n"
            + "			group by patient_id			\n"
            + "		) marcado\n"
            + "		left join	\n"
            + "		(\n"
            + "			select patient_id,data_consulta, max(proximo_levantamento) proximo_levantamento,(max(proximo_levantamento) + interval 7 day) data_falta\n"
            + "			from \n"
            + "			(		\n"
            + "				-- Get Scheduled date on last Fila\n"
            + "				select maxFila.patient_id,maxFila.data_consulta,o.value_datetime  proximo_levantamento\n"
            + "				from\n"
            + "				(\n"
            + "					-- Get max fila for each patient\n"
            + "					Select  p.patient_id,max(e.encounter_datetime) data_consulta\n"
            + "					from    patient p \n"
            + "							inner join encounter e on p.patient_id=e.patient_id \n"
            + "					where 	e.voided=0 and p.voided=0 and e.encounter_type=18 and  \n"
            + "							e.encounter_datetime<=:endDate and e.location_id=:location \n"
            + "					GROUP BY p.patient_id\n"
            + "				) maxFila \n"
            + "				inner join obs o on o.person_id=maxFila.patient_id\n"
            + "				where 	o.obs_datetime=maxFila.data_consulta and o.concept_id=5096 and o.voided=0	\n"
            + "				\n"
            + "				UNION\n"
            + "\n"
            + "				-- Get Max recepcao levantou ARV and max recepcao + 30 days as scheduled date\n"
            + "				Select 	p.patient_id,max(value_datetime) data_consulta,(max(value_datetime) + INTERVAL 30 day) proximo_levantamento\n"
            + "				from 	patient p\n"
            + "						inner join encounter e on p.patient_id=e.patient_id\n"
            + "						inner join obs o on e.encounter_id=o.encounter_id\n"
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and \n"
            + "						o.concept_id=23866 and o.value_datetime is not null and \n"
            + "						o.value_datetime<=:endDate and e.location_id=:location\n"
            + "				group by p.patient_id	\n"
            + "			) consultaRecepcao\n"
            + "			group by patient_id\n"
            + "			having date_add(max(proximo_levantamento), INTERVAL 7 day )<:endDate \n"
            + "		) faltoso on faltoso.patient_id=marcado.patient_id	\n"
            + "		left join \n"
            + "		(\n"
            + "			select allSaida.patient_id,max(data_estado) data_estado\n"
            + "			from \n"
            + "				(\n"
            + "					/*Estado no programa*/\n"
            + "					select 	pg.patient_id,\n"
            + "							max(ps.start_date) data_estado\n"
            + "					from 	patient p \n"
            + "							inner join patient_program pg on p.patient_id=pg.patient_id\n"
            + "							inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
            + "					where 	pg.voided=0 and ps.voided=0 and p.voided=0 and \n"
            + "							pg.program_id=2 and ps.state in (7,8,10) and ps.end_date is null and \n"
            + "							ps.start_date<=:endDate and location_id=:location\n"
            + "					group by pg.patient_id\n"
            + "					\n"
            + "					union\n"
            + "					\n"
            + "					/*Estado no estado de permanencia da Ficha Resumo, Ficha Clinica*/\n"
            + "					select 	p.patient_id,\n"
            + "							max(o.obs_datetime) data_estado\n"
            + "					from 	patient p \n"
            + "							inner join encounter e on p.patient_id=e.patient_id\n"
            + "							inner join obs  o on e.encounter_id=o.encounter_id\n"
            + "					where 	e.voided=0 and o.voided=0 and p.voided=0 and \n"
            + "							e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and  \n"
            + "							o.obs_datetime<=:endDate and e.location_id=:location\n"
            + "					group by p.patient_id\n"
            + "					\n"
            + "					union\n"
            + "					\n"
            + "					/*Obito demografico*/\n"
            + "					\n"
            + "					select person_id as patient_id,death_date as data_estado\n"
            + "					from person \n"
            + "					where dead=1 and death_date is not null and death_date<=:endDate\n"
            + "							\n"
            + "					union\n"
            + "					\n"
            + "					/*Obito na ficha de busca*/\n"
            + "					select 	p.patient_id,\n"
            + "							max(obsObito.obs_datetime) data_estado\n"
            + "					from 	patient p \n"
            + "							inner join encounter e on p.patient_id=e.patient_id\n"
            + "							inner join obs obsObito on e.encounter_id=obsObito.encounter_id\n"
            + "					where 	e.voided=0 and p.voided=0 and obsObito.voided=0 and \n"
            + "							e.encounter_type in (21,36,37) and  e.encounter_datetime<=:endDate and  e.location_id=:location and \n"
            + "							obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366	\n"
            + "					group by p.patient_id\n"
            + "					\n"
            + "					\n"
            + "					\n"
            + "				) allSaida\n"
            + "				inner join\n"
            + "				( 	select patient_id,max(encounter_datetime) encounter_datetime \n"
            + "					from( \n"
            + "							select 	p.patient_id,max(e.encounter_datetime) encounter_datetime \n"
            + "							from  	patient p \n"
            + "									inner join encounter e on e.patient_id=p.patient_id \n"
            + "							where  	p.voided=0 and e.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location and e.encounter_type in (18,6,9) \n"
            + "							group by p.patient_id \n"
            + "							\n"
            + "							union \n"
            + "							\n"
            + "							Select 	p.patient_id,max(value_datetime) encounter_datetime \n"
            + "							from  	patient p \n"
            + "									inner join encounter e on p.patient_id=e.patient_id \n"
            + "									inner join obs o on e.encounter_id=o.encounter_id \n"
            + "							where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and o.concept_id=23866 and \n"
            + "									o.value_datetime is not null and o.value_datetime<=:endDate and e.location_id=:location \n"
            + "							group by p.patient_id\n"
            + "						) consultaLev group by patient_id\n"
            + "				) consultaOuARV on allSaida.patient_id=consultaOuARV.patient_id \n"
            + "				where consultaOuARV.encounter_datetime <= allSaida.data_estado\n"
            + "			group by allSaida.patient_id			\n"
            + "		) saida on marcado.patient_id=saida.patient_id\n"
            + "		 where saida.data_estado is null;";

    public static final String patientsWhoMissedARTPickUp =
        "	select 	marcado.patient_id\n"
            + "	from\n"
            + "	\n"
            + "		(\n"
            + "			select patient_id, data_consulta,max(data_proxima_consulta) data_proxima_consulta\n"
            + "			from \n"
            + "			(\n"
            + "				Select  p.patient_id,e.encounter_datetime data_consulta,o.value_datetime data_proxima_consulta\n"
            + "				from    patient p \n"
            + "						inner join encounter e on p.patient_id=e.patient_id \n"
            + "						inner join obs o on o.encounter_id=e.encounter_id\n"
            + "				where 	e.voided=0 and p.voided=0 and o.voided=0 and o.concept_id=5096 and e.encounter_type=18 and  \n"
            + "						o.value_datetime between :startDate and :endDate and e.location_id=:location and e.encounter_datetime<=:endDate\n"
            + "				\n"
            + "				\n"
            + "				UNION\n"
            + "\n"
            + "				Select 	p.patient_id,o.value_datetime data_consulta,(o.value_datetime + INTERVAL 30 day) data_proxima_consulta\n"
            + "				from 	patient p\n"
            + "						inner join encounter e on p.patient_id=e.patient_id\n"
            + "						inner join obs o on e.encounter_id=o.encounter_id\n"
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and \n"
            + "						o.concept_id=23866 and o.value_datetime is not null and \n"
            + "						o.value_datetime<=:endDate and e.location_id=:location and \n"
            + "						(o.value_datetime + interval 30 day) between :startDate and :endDate \n"
            + "					\n"
            + "			) consultaRecepcao\n"
            + "			group by patient_id			\n"
            + "		) marcado\n"
            + "		left join	\n"
            + "		(\n"
            + "			select patient_id,data_consulta, max(proximo_levantamento) proximo_levantamento,(max(proximo_levantamento) + interval 7 day) data_falta\n"
            + "			from \n"
            + "			(		\n"
            + "				-- Get Scheduled date on last Fila\n"
            + "				select maxFila.patient_id,maxFila.data_consulta,o.value_datetime  proximo_levantamento\n"
            + "				from\n"
            + "				(\n"
            + "					-- Get max fila for each patient\n"
            + "					Select  p.patient_id,max(e.encounter_datetime) data_consulta\n"
            + "					from    patient p \n"
            + "							inner join encounter e on p.patient_id=e.patient_id \n"
            + "					where 	e.voided=0 and p.voided=0 and e.encounter_type=18 and  \n"
            + "							e.encounter_datetime<=:endDate and e.location_id=:location \n"
            + "					GROUP BY p.patient_id\n"
            + "				) maxFila \n"
            + "				inner join obs o on o.person_id=maxFila.patient_id\n"
            + "				where 	o.obs_datetime=maxFila.data_consulta and o.concept_id=5096 and o.voided=0	\n"
            + "				\n"
            + "				UNION\n"
            + "\n"
            + "				-- Get Max recepcao levantou ARV and max recepcao + 30 days as scheduled date\n"
            + "				Select 	p.patient_id,max(value_datetime) data_consulta,(max(value_datetime) + INTERVAL 30 day) proximo_levantamento\n"
            + "				from 	patient p\n"
            + "						inner join encounter e on p.patient_id=e.patient_id\n"
            + "						inner join obs o on e.encounter_id=o.encounter_id\n"
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and \n"
            + "						o.concept_id=23866 and o.value_datetime is not null and \n"
            + "						o.value_datetime<=:endDate and e.location_id=:location\n"
            + "				group by p.patient_id	\n"
            + "			) consultaRecepcao\n"
            + "			group by patient_id\n"
            + "			having date_add(max(proximo_levantamento), INTERVAL 7 day )<:endDate \n"
            + "		) faltoso on faltoso.patient_id=marcado.patient_id	\n"
            + "		left join \n"
            + "		(\n"
            + "			select allSaida.patient_id,max(data_estado) data_estado\n"
            + "			from \n"
            + "				(\n"
            + "					/*Estado no programa*/\n"
            + "					select 	pg.patient_id,\n"
            + "							max(ps.start_date) data_estado\n"
            + "					from 	patient p \n"
            + "							inner join patient_program pg on p.patient_id=pg.patient_id\n"
            + "							inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
            + "					where 	pg.voided=0 and ps.voided=0 and p.voided=0 and \n"
            + "							pg.program_id=2 and ps.state in (7,8,10) and ps.end_date is null and \n"
            + "							ps.start_date<=:endDate and location_id=:location\n"
            + "					group by pg.patient_id\n"
            + "					\n"
            + "					union\n"
            + "					\n"
            + "					/*Estado no estado de permanencia da Ficha Resumo, Ficha Clinica*/\n"
            + "					select 	p.patient_id,\n"
            + "							max(o.obs_datetime) data_estado\n"
            + "					from 	patient p \n"
            + "							inner join encounter e on p.patient_id=e.patient_id\n"
            + "							inner join obs  o on e.encounter_id=o.encounter_id\n"
            + "					where 	e.voided=0 and o.voided=0 and p.voided=0 and \n"
            + "							e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and  \n"
            + "							o.obs_datetime<=:endDate and e.location_id=:location\n"
            + "					group by p.patient_id\n"
            + "					\n"
            + "					union\n"
            + "					\n"
            + "					/*Obito demografico*/\n"
            + "					\n"
            + "					select person_id as patient_id,death_date as data_estado\n"
            + "					from person \n"
            + "					where dead=1 and death_date is not null and death_date<=:endDate\n"
            + "							\n"
            + "					union\n"
            + "					\n"
            + "					/*Obito na ficha de busca*/\n"
            + "					select 	p.patient_id,\n"
            + "							max(obsObito.obs_datetime) data_estado\n"
            + "					from 	patient p \n"
            + "							inner join encounter e on p.patient_id=e.patient_id\n"
            + "							inner join obs obsObito on e.encounter_id=obsObito.encounter_id\n"
            + "					where 	e.voided=0 and p.voided=0 and obsObito.voided=0 and \n"
            + "							e.encounter_type in (21,36,37) and  e.encounter_datetime<=:endDate and  e.location_id=:location and \n"
            + "							obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366	\n"
            + "					group by p.patient_id\n"
            + "					\n"
            + "					\n"
            + "					\n"
            + "				) allSaida\n"
            + "				inner join\n"
            + "				( 	select patient_id,max(encounter_datetime) encounter_datetime \n"
            + "					from( \n"
            + "							select 	p.patient_id,max(e.encounter_datetime) encounter_datetime \n"
            + "							from  	patient p \n"
            + "									inner join encounter e on e.patient_id=p.patient_id \n"
            + "							where  	p.voided=0 and e.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location and e.encounter_type in (18,6,9) \n"
            + "							group by p.patient_id \n"
            + "							\n"
            + "							union \n"
            + "							\n"
            + "							Select 	p.patient_id,max(value_datetime) encounter_datetime \n"
            + "							from  	patient p \n"
            + "									inner join encounter e on p.patient_id=e.patient_id \n"
            + "									inner join obs o on e.encounter_id=o.encounter_id \n"
            + "							where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and o.concept_id=23866 and \n"
            + "									o.value_datetime is not null and o.value_datetime<=:endDate and e.location_id=:location \n"
            + "							group by p.patient_id\n"
            + "						) consultaLev group by patient_id\n"
            + "				) consultaOuARV on allSaida.patient_id=consultaOuARV.patient_id \n"
            + "				where consultaOuARV.encounter_datetime <= allSaida.data_estado\n"
            + "			group by allSaida.patient_id			\n"
            + "		) saida on marcado.patient_id=saida.patient_id\n"
            + "		where saida.data_estado is null and faltoso.data_falta is not null;\n"
            + "";
  }
}
