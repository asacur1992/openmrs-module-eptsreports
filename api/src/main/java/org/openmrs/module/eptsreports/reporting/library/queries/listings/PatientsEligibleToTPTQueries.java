/** */
package org.openmrs.module.eptsreports.reporting.library.queries.listings;

/** @author St√©lio Moiane */
public interface PatientsEligibleToTPTQueries {

  class QUERY {
    public static final String findPatientsEligibleToTPT =
        "SELECT p.patient_id, pi.identifier, CONCAT(pn.given_name, ' ', COALESCE(pn.middle_name, ''), ' ', pn.family_name) name, pe.gender, (YEAR( :endDate) - YEAR(pe.birthdate)) age,\n"
            + "       art_start_date, last_follow_up_date, next_follow_up_date, last_pickup_date, next_pickup_date, tpi_start_date, tpi_ends_date, IF(pregnant_date IS NULL,  '', 'S') pregnant,\n"
            + "       IF(breastfeeding_date IS NULL,  '', 'S') breastfeeding FROM patient p\n"
            + "    INNER JOIN patient_identifier pi ON p.patient_id = pi.patient_id\n"
            + "	INNER JOIN person_name pn ON pn.person_id = p.patient_id\n"
            + "	INNER JOIN person pe ON pe.person_id = p.patient_id\n"
            + "    INNER JOIN\n"
            + "    (\n"
            + "        SELECT patient_id, MIN(art_start_date) art_start_date FROM\n"
            + "            (	\n"
            + "				SELECT p.patient_id,MIN(e.encounter_datetime) art_start_date FROM patient p \n"
            + "					INNER JOIN encounter e ON p.patient_id=e.patient_id	\n"
            + "					INNER JOIN obs o ON o.encounter_id=e.encounter_id \n"
            + "						WHERE e.voided=0 AND o.voided=0 AND p.voided=0 \n"
            + "						AND e.encounter_type IN (18,6,9) AND o.concept_id=1255 AND o.value_coded=1256 \n"
            + "						AND e.encounter_datetime <= :endDate AND e.location_id = :location\n"
            + "							GROUP BY p.patient_id\n"
            + "				UNION\n"
            + "		\n"
            + "				SELECT p.patient_id,MIN(value_datetime) art_start_date FROM patient p\n"
            + "					INNER JOIN encounter e ON p.patient_id=e.patient_id\n"
            + "					INNER JOIN obs o ON e.encounter_id=o.encounter_id\n"
            + "						WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND e.encounter_type in (18,6,9,53) \n"
            + "						AND o.concept_id=1190 AND o.value_datetime is NOT NULL \n"
            + "						AND o.value_datetime <= :endDate AND e.location_id = :location\n"
            + "							GROUP BY p.patient_id\n"
            + "				\n"
            + "				UNION\n"
            + "\n"
            + "				SELECT pg.patient_id,MIN(date_enrolled) art_start_date FROM patient p \n"
            + "					INNER JOIN patient_program pg ON p.patient_id=pg.patient_id\n"
            + "						WHERE pg.voided=0 AND p.voided=0 AND program_id=2 AND date_enrolled <= :endDate AND pg.location_id = :location\n"
            + "							GROUP BY pg.patient_id\n"
            + "				\n"
            + "				UNION\n"
            + "				\n"
            + "				SELECT e.patient_id, MIN(e.encounter_datetime) AS art_start_date FROM patient p\n"
            + "					INNER JOIN encounter e ON p.patient_id=e.patient_id\n"
            + "				  		WHERE p.voided=0 and e.encounter_type=18 AND e.voided=0 AND e.encounter_datetime <= :endDate AND e.location_id = :location\n"
            + "				  			GROUP BY p.patient_id\n"
            + "			  \n"
            + "				UNION\n"
            + "				\n"
            + "				SELECT p.patient_id,MIN(value_datetime) art_start_date FROM patient p\n"
            + "					INNER JOIN encounter e ON p.patient_id=e.patient_id\n"
            + "					INNER JOIN obs o ON e.encounter_id=o.encounter_id\n"
            + "						WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND e.encounter_type=52 \n"
            + "						AND o.concept_id=23866 and o.value_datetime is NOT NULL \n"
            + "						AND o.value_datetime <= :endDate AND e.location_id = :location\n"
            + "							GROUP BY p.patient_id	\n"
            + "	\n"
            + "		)min_art_start_date GROUP BY min_art_start_date.patient_id\n"
            + "	)start_art ON start_art.patient_id = p.patient_id\n"
            + "    INNER JOIN\n"
            + "    (\n"
            + "        SELECT last_tb_screen.patient_id FROM \n"
            + "        (\n"
            + "            SELECT e.patient_id, MAX(e.encounter_datetime) last_tb_screen_date FROM encounter e\n"
            + "                INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                AND e.encounter_datetime <= :endDate AND e.location_id = :location  \n"
            + "                AND o.concept_id = 23758 \n"
            + "                    GROUP BY e.patient_id\n"
            + "        )last_tb_screen\n"
            + "        INNER JOIN\n"
            + "        (\n"
            + "            SELECT o.person_id patient_id, o.obs_datetime tb_screen_date FROM obs o\n"
            + "                WHERE o.concept_id = 23758 AND o.value_coded = 1066\n"
            + "        )last_tb_screen_negative ON last_tb_screen.patient_id = last_tb_screen_negative.patient_id AND last_tb_screen.last_tb_screen_date = last_tb_screen_negative.tb_screen_date\n"
            + "        LEFT JOIN \n"
            + "        (\n"
            + "            SELECT last_tb_diagnosis.patient_id, last_tb_diagnosis_value FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tb_diagnosis_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location  \n"
            + "                    AND o.concept_id = 23761 \n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tb_diagnosis\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tb_diagnosis_date, o.value_coded last_tb_diagnosis_value FROM obs o\n"
            + "                    WHERE o.concept_id = 23761\n"
            + "            )last_tb_diagnosis_negative ON last_tb_diagnosis.patient_id = last_tb_diagnosis_negative.patient_id AND last_tb_diagnosis.last_tb_diagnosis_date = tb_diagnosis_date\n"
            + "        )tb_diagnosis ON tb_diagnosis.patient_id = last_tb_screen.patient_id\n"
            + "        LEFT JOIN \n"
            + "        (\n"
            + "            SELECT last_tb_treatment.patient_id, last_tb_treatment_date, last_tb_treatment_value FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tb_treatment_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location\n"
            + "                    AND o.concept_id = 1268 \n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tb_treatment\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tb_treatment_date, o.value_coded last_tb_treatment_value FROM obs o\n"
            + "                    WHERE o.concept_id = 1268\n"
            + "            )last_tb_treatment_end ON last_tb_treatment_end.patient_id = last_tb_treatment.patient_id AND last_tb_treatment.last_tb_treatment_date = last_tb_treatment_end.tb_treatment_date\n"
            + "        )tb_treatment ON tb_treatment.patient_id = last_tb_screen.patient_id\n"
            + "        LEFT JOIN (\n"
            + "            SELECT last_tpi_prophilaxis.patient_id, last_tpi_prophilaxis_date, tpi_prophilaxis_value FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tpi_prophilaxis_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location  \n"
            + "                    AND o.concept_id = 6122\n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tpi_prophilaxis\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tpi_prophilaxis_date, o.value_coded tpi_prophilaxis_value FROM obs o\n"
            + "                    WHERE o.concept_id = 6122\n"
            + "            )tpi_prophilaxis_value ON tpi_prophilaxis_value.patient_id = last_tpi_prophilaxis.patient_id AND last_tpi_prophilaxis.last_tpi_prophilaxis_date = tpi_prophilaxis_value.tpi_prophilaxis_date\n"
            + "        )tpi_prophilaxis ON tpi_prophilaxis.patient_id = last_tb_screen.patient_id\n"
            + "        LEFT JOIN\n"
            + "        (\n"
            + "            SELECT last_tpi_start.patient_id, last_tpi_start_date, tpi_start_date FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tpi_start_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location\n"
            + "                    AND o.concept_id = 6128 \n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tpi_start\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tpi_start_value_date, o.value_datetime tpi_start_date FROM obs o\n"
            + "                    WHERE o.concept_id = 6128\n"
            + "            )tpi_start_value ON last_tpi_start.patient_id = last_tpi_start.patient_id AND last_tpi_start.last_tpi_start_date = tpi_start_value.tpi_start_value_date\n"
            + "        )tpi_start ON tpi_start.patient_id = last_tb_screen.patient_id\n"
            + "        WHERE (tb_treatment.last_tb_treatment_value IN (1267, 1066, 1260) OR tb_treatment.last_tb_treatment_value IS NULL) \n"
            + "        AND (tb_diagnosis.last_tb_diagnosis_value = 1066 OR tb_diagnosis.last_tb_diagnosis_value IS NULL)\n"
            + "        AND (tpi_prophilaxis.tpi_prophilaxis_value = 1066 OR tpi_prophilaxis.tpi_prophilaxis_value IS NULL)\n"
            + "        AND tpi_start.tpi_start_date IS NULL\n"
            + "            GROUP BY last_tb_screen.patient_id\n"
            + "\n"
            + "        UNION\n"
            + "\n"
            + "        SELECT last_tb_screen.patient_id FROM \n"
            + "        (\n"
            + "            SELECT e.patient_id, MAX(e.encounter_datetime) last_tb_screen_date FROM encounter e\n"
            + "                INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                AND e.encounter_datetime <= :endDate AND e.location_id = :location  \n"
            + "                AND o.concept_id = 23758 \n"
            + "                    GROUP BY e.patient_id\n"
            + "        )last_tb_screen\n"
            + "        INNER JOIN\n"
            + "        (\n"
            + "            SELECT o.person_id patient_id, o.obs_datetime tb_screen_date FROM obs o\n"
            + "                WHERE o.concept_id = 23758 AND o.value_coded = 1066\n"
            + "        )last_tb_screen_negative ON last_tb_screen.patient_id = last_tb_screen_negative.patient_id AND last_tb_screen.last_tb_screen_date = last_tb_screen_negative.tb_screen_date\n"
            + "        LEFT JOIN \n"
            + "        (\n"
            + "            SELECT last_tb_diagnosis.patient_id, last_tb_diagnosis_value FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tb_diagnosis_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location  \n"
            + "                    AND o.concept_id = 23761 \n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tb_diagnosis\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tb_diagnosis_date, o.value_coded last_tb_diagnosis_value FROM obs o\n"
            + "                    WHERE o.concept_id = 23761\n"
            + "            )last_tb_diagnosis_negative ON last_tb_diagnosis.patient_id = last_tb_diagnosis_negative.patient_id AND last_tb_diagnosis.last_tb_diagnosis_date = tb_diagnosis_date\n"
            + "        )tb_diagnosis ON tb_diagnosis.patient_id = last_tb_screen.patient_id\n"
            + "        LEFT JOIN \n"
            + "        (\n"
            + "            SELECT last_tb_treatment.patient_id, last_tb_treatment_date, last_tb_treatment_value FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tb_treatment_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location\n"
            + "                    AND o.concept_id = 1268 \n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tb_treatment\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tb_treatment_date, o.value_coded last_tb_treatment_value FROM obs o\n"
            + "                    WHERE o.concept_id = 1268\n"
            + "            )last_tb_treatment_end ON last_tb_treatment_end.patient_id = last_tb_treatment.patient_id AND last_tb_treatment.last_tb_treatment_date = last_tb_treatment_end.tb_treatment_date\n"
            + "        )tb_treatment ON tb_treatment.patient_id = last_tb_screen.patient_id\n"
            + "        LEFT JOIN (\n"
            + "            SELECT last_tpi_prophilaxis.patient_id, last_tpi_prophilaxis_date, tpi_prophilaxis_value FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tpi_prophilaxis_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location  \n"
            + "                    AND o.concept_id = 6122\n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tpi_prophilaxis\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tpi_prophilaxis_date, o.value_coded tpi_prophilaxis_value FROM obs o\n"
            + "                    WHERE o.concept_id = 6122\n"
            + "            )tpi_prophilaxis_value ON tpi_prophilaxis_value.patient_id = last_tpi_prophilaxis.patient_id AND last_tpi_prophilaxis.last_tpi_prophilaxis_date = tpi_prophilaxis_value.tpi_prophilaxis_date\n"
            + "        )tpi_prophilaxis ON tpi_prophilaxis.patient_id = last_tb_screen.patient_id\n"
            + "        LEFT JOIN\n"
            + "        (\n"
            + "            SELECT last_tpi_start.patient_id, last_tpi_start_date, tpi_start_date FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tpi_start_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location\n"
            + "                    AND o.concept_id = 6128 \n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tpi_start\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tpi_start_value_date, o.value_datetime tpi_start_date FROM obs o\n"
            + "                    WHERE o.concept_id = 6128\n"
            + "            )tpi_start_value ON last_tpi_start.patient_id = last_tpi_start.patient_id AND last_tpi_start.last_tpi_start_date = tpi_start_value.tpi_start_value_date\n"
            + "        )tpi_start ON tpi_start.patient_id = last_tb_screen.patient_id\n"
            + "        LEFT JOIN\n"
            + "        (\n"
            + "        	SELECT last_tpi_ends.patient_id, last_tpi_ends_date, tpi_ends_date FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tpi_ends_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location\n"
            + "                    AND o.concept_id = 6129 \n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tpi_ends\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tpi_ends_value_date, o.value_datetime tpi_ends_date FROM obs o\n"
            + "                    WHERE o.concept_id = 6129\n"
            + "            )tpi_ends_value ON last_tpi_ends.patient_id = last_tpi_ends.patient_id AND last_tpi_ends.last_tpi_ends_date = tpi_ends_value.tpi_ends_value_date\n"
            + "        )tpi_ends ON tpi_ends.patient_id = last_tb_screen.patient_id\n"
            + "        WHERE (tb_treatment.last_tb_treatment_value IN (1267, 1066, 1260) OR tb_treatment.last_tb_treatment_value IS NULL) \n"
            + "        AND (tb_diagnosis.last_tb_diagnosis_value = 1066 OR tb_diagnosis.last_tb_diagnosis_value IS NULL)\n"
            + "        AND (tpi_prophilaxis.tpi_prophilaxis_value = 1066 OR tpi_prophilaxis.tpi_prophilaxis_value IS NULL)\n"
            + "        AND tpi_start.tpi_start_date IS NOT NULL AND DATEDIFF( :endDate, tpi_start.tpi_start_date) > 240\n"
            + "        AND tpi_ends.tpi_ends_date IS NULL\n"
            + "            GROUP BY last_tb_screen.patient_id\n"
            + "        \n"
            + "        UNION\n"
            + "\n"
            + "        SELECT last_tb_screen.patient_id FROM \n"
            + "        (\n"
            + "            SELECT e.patient_id, MAX(e.encounter_datetime) last_tb_screen_date FROM encounter e\n"
            + "                INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                AND e.encounter_datetime <= :endDate AND e.location_id = :location  \n"
            + "                AND o.concept_id = 23758 \n"
            + "                    GROUP BY e.patient_id\n"
            + "        )last_tb_screen\n"
            + "        INNER JOIN\n"
            + "        (\n"
            + "            SELECT o.person_id patient_id, o.obs_datetime tb_screen_date FROM obs o\n"
            + "                WHERE o.concept_id = 23758 AND o.value_coded = 1066\n"
            + "        )last_tb_screen_negative ON last_tb_screen.patient_id = last_tb_screen_negative.patient_id AND last_tb_screen.last_tb_screen_date = last_tb_screen_negative.tb_screen_date\n"
            + "        LEFT JOIN \n"
            + "        (\n"
            + "            SELECT last_tb_diagnosis.patient_id, last_tb_diagnosis_value FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tb_diagnosis_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location  \n"
            + "                    AND o.concept_id = 23761 \n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tb_diagnosis\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tb_diagnosis_date, o.value_coded last_tb_diagnosis_value FROM obs o\n"
            + "                    WHERE o.concept_id = 23761\n"
            + "            )last_tb_diagnosis_negative ON last_tb_diagnosis.patient_id = last_tb_diagnosis_negative.patient_id AND last_tb_diagnosis.last_tb_diagnosis_date = tb_diagnosis_date\n"
            + "        )tb_diagnosis ON tb_diagnosis.patient_id = last_tb_screen.patient_id\n"
            + "        LEFT JOIN \n"
            + "        (\n"
            + "            SELECT last_tb_treatment.patient_id, last_tb_treatment_date, last_tb_treatment_value FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tb_treatment_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location\n"
            + "                    AND o.concept_id = 1268 \n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tb_treatment\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tb_treatment_date, o.value_coded last_tb_treatment_value FROM obs o\n"
            + "                    WHERE o.concept_id = 1268\n"
            + "            )last_tb_treatment_end ON last_tb_treatment_end.patient_id = last_tb_treatment.patient_id AND last_tb_treatment.last_tb_treatment_date = last_tb_treatment_end.tb_treatment_date\n"
            + "        )tb_treatment ON tb_treatment.patient_id = last_tb_screen.patient_id\n"
            + "        LEFT JOIN (\n"
            + "            SELECT last_tpi_prophilaxis.patient_id, last_tpi_prophilaxis_date, tpi_prophilaxis_value FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tpi_prophilaxis_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location  \n"
            + "                    AND o.concept_id = 6122\n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tpi_prophilaxis\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tpi_prophilaxis_date, o.value_coded tpi_prophilaxis_value FROM obs o\n"
            + "                    WHERE o.concept_id = 6122\n"
            + "            )tpi_prophilaxis_value ON tpi_prophilaxis_value.patient_id = last_tpi_prophilaxis.patient_id AND last_tpi_prophilaxis.last_tpi_prophilaxis_date = tpi_prophilaxis_value.tpi_prophilaxis_date\n"
            + "        )tpi_prophilaxis ON tpi_prophilaxis.patient_id = last_tb_screen.patient_id\n"
            + "        LEFT JOIN\n"
            + "        (\n"
            + "            SELECT last_tpi_start.patient_id, last_tpi_start_date, tpi_start_date FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tpi_start_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location\n"
            + "                    AND o.concept_id = 6128 \n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tpi_start\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tpi_start_value_date, o.value_datetime tpi_start_date FROM obs o\n"
            + "                    WHERE o.concept_id = 6128\n"
            + "            )tpi_start_value ON last_tpi_start.patient_id = last_tpi_start.patient_id AND last_tpi_start.last_tpi_start_date = tpi_start_value.tpi_start_value_date\n"
            + "        )tpi_start ON tpi_start.patient_id = last_tb_screen.patient_id\n"
            + "        LEFT JOIN\n"
            + "        (\n"
            + "        	  SELECT last_tpi_ends.patient_id, last_tpi_ends_date, tpi_ends_date FROM \n"
            + "            (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_tpi_ends_date FROM encounter e\n"
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location\n"
            + "                    AND o.concept_id = 6129 \n"
            + "                        GROUP BY e.patient_id\n"
            + "            )last_tpi_ends\n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.obs_datetime tpi_ends_value_date, o.value_datetime tpi_ends_date FROM obs o\n"
            + "                    WHERE o.concept_id = 6129\n"
            + "            )tpi_ends_value ON last_tpi_ends.patient_id = last_tpi_ends.patient_id AND last_tpi_ends.last_tpi_ends_date = tpi_ends_value.tpi_ends_value_date\n"
            + "        )tpi_ends ON tpi_ends.patient_id = last_tb_screen.patient_id\n"
            + "        WHERE (tb_treatment.last_tb_treatment_value IN (1267, 1066, 1260) OR tb_treatment.last_tb_treatment_value IS NULL) \n"
            + "        AND (tb_diagnosis.last_tb_diagnosis_value = 1066 OR tb_diagnosis.last_tb_diagnosis_value IS NULL)\n"
            + "        AND (tpi_prophilaxis.tpi_prophilaxis_value = 1066 OR tpi_prophilaxis.tpi_prophilaxis_value IS NULL)\n"
            + "        AND tpi_start.tpi_start_date IS NOT NULL AND tpi_ends.tpi_ends_date IS NOT NULL\n"
            + "        AND tpi_ends.tpi_ends_date > tpi_start.tpi_start_date\n"
            + "        AND DATEDIFF(tpi_ends.tpi_ends_date, tpi_start.tpi_start_date) <= 173\n"
            + "            GROUP BY last_tb_screen.patient_id\n"
            + "    )tpt_eligible ON tpt_eligible.patient_id = p.patient_id\n"
            + "    LEFT JOIN \n"
            + "    (    \n"
            + "        SELECT patient_id, MAX(state_date) state_date FROM \n"
            + "        (\n"
            + "            SELECT pg.patient_id, MAX(ps.start_date) state_date FROM patient p \n"
            + "                INNER JOIN patient_program pg ON p.patient_id=pg.patient_id \n"
            + "                INNER JOIN patient_state ps ON pg.patient_program_id=ps.patient_program_id \n"
            + "                    WHERE pg.voided=0 AND ps.voided=0 AND p.voided=0 AND pg.program_id=2 \n"
            + "                    AND ps.state in (7,8,10) AND ps.end_date IS NULL \n"
            + "                    AND ps.start_date <= :endDate AND pg.location_id = :location \n"
            + "                        GROUP BY pg.patient_id           \n"
            + "            UNION \n"
            + "                        \n"
            + "            SELECT p.patient_id, MAX(o.obs_datetime) state_date FROM patient p \n"
            + "                INNER JOIN encounter e ON p.patient_id=e.patient_id \n"
            + "                INNER JOIN obs o ON e.encounter_id=o.encounter_id \n"
            + "                    WHERE e.voided=0 AND o.voided=0 AND p.voided=0 AND e.encounter_type IN (53,6) \n"
            + "                    AND o.concept_id IN (6272,6273) AND o.value_coded IN (1706,1366,1709) \n"
            + "                    AND o.obs_datetime <= :endDate AND e.location_id = :location \n"
            + "                        GROUP BY p.patient_id                   \n"
            + "            UNION\n"
            + "\n"
            + "            SELECT person_id as patient_id,death_date as state_date FROM person \n"
            + "                WHERE dead=1 AND death_date IS NOT NULL AND death_date <= :endDate \n"
            + "            \n"
            + "            UNION \n"
            + "            \n"
            + "            SELECT p.patient_id, MAX(o.obs_datetime) state_date FROM patient p \n"
            + "                INNER JOIN encounter e ON p.patient_id=e.patient_id \n"
            + "                INNER JOIN obs o ON e.encounter_id=o.encounter_id \n"
            + "                    WHERE e.voided=0 AND p.voided=0 AND o.voided=0 AND e.encounter_type=21 \n"
            + "                    AND e.encounter_datetime <= :endDate AND e.location_id = :location \n"
            + "                    AND o.concept_id IN (2031, 23944, 23945) AND o.value_coded=1366 \n"
            + "                        GROUP BY p.patient_id\n"
            + "        ) max_exits GROUP BY patient_id\n"
            + "    )exits ON exits.patient_id = p.patient_id\n"
            + "    LEFT JOIN\n"
            + "    (\n"
            + "        SELECT max_expected.patient_id,MAX(last_encounter_date) last_encounter_date ,MAX(expected_date) expected_date FROM \n"
            + "        (\n"
            + "            SELECT last_encounter.patient_id, last_encounter_date, expected_follow_up.expected_date FROM  \n"
            + "	        (\n"
            + "                SELECT MAX(e.encounter_datetime) last_encounter_date, e.patient_id FROM encounter e\n"
            + "                    WHERE e.encounter_type IN(6,9)\n"
            + "                        AND e.voided = 0 AND e.location_id = :location AND e.encounter_datetime <= :endDate\n"
            + "                            GROUP BY e.patient_id\n"
            + "            ) last_encounter\n"
            + "            LEFT JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.value_datetime expected_date, o.obs_datetime FROM obs o\n"
            + "                        INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "                            WHERE o.concept_id = 1410 AND e.encounter_type IN(6,9) \n"
            + "                            AND o.voided = 0 AND e.voided = 0\n"
            + "            ) expected_follow_up ON expected_follow_up.patient_id = last_encounter.patient_id AND expected_follow_up.obs_datetime = last_encounter.last_encounter_date \n"
            + "\n"
            + "            UNION\n"
            + "\n"
            + "            SELECT last_pickup.patient_id, last_encounter_date, expected_pickup.expected_date FROM  \n"
            + "	        (\n"
            + "                SELECT MAX(e.encounter_datetime) last_encounter_date, e.patient_id FROM encounter e\n"
            + "                    WHERE e.encounter_type = 18\n"
            + "                        AND e.voided = 0 AND e.location_id = :location AND e.encounter_datetime <= :endDate\n"
            + "                            GROUP BY e.patient_id\n"
            + "            ) last_pickup\n"
            + "            LEFT JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.value_datetime expected_date, o.obs_datetime FROM obs o\n"
            + "                        INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "                            WHERE o.concept_id = 5096 AND e.encounter_type = 18\n"
            + "                            AND o.voided = 0 AND e.voided = 0\n"
            + "            ) expected_pickup ON expected_pickup.patient_id = last_pickup.patient_id AND expected_pickup.obs_datetime = last_pickup.last_encounter_date \n"
            + "\n"
            + "            UNION\n"
            + "\n"
            + "            SELECT last_filt_pickup.patient_id, last_encounter_date, expected_filt_pickup.expected_date FROM  \n"
            + "	        (\n"
            + "                SELECT MAX(e.encounter_datetime) last_encounter_date, e.patient_id FROM encounter e\n"
            + "                    WHERE e.encounter_type = 60\n"
            + "                        AND e.voided = 0 AND e.location_id = :location AND e.encounter_datetime <= :endDate\n"
            + "                            GROUP BY e.patient_id\n"
            + "            ) last_filt_pickup\n"
            + "            LEFT JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.value_datetime expected_date, o.obs_datetime FROM obs o\n"
            + "                        INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "                            WHERE o.concept_id = 23988 AND e.encounter_type = 60\n"
            + "                            AND o.voided = 0 AND e.voided = 0\n"
            + "            ) expected_filt_pickup ON expected_filt_pickup.patient_id = last_filt_pickup.patient_id AND expected_filt_pickup.obs_datetime = last_filt_pickup.last_encounter_date\n"
            + "\n"
            + "            UNION\n"
            + "\n"
            + "            SELECT o.person_id patient_id, MAX(o.value_datetime) as last_encounter_date, MAX((o.value_datetime + INTERVAL 30 DAY)) expected_date FROM obs o\n"
            + "                INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE o.concept_id = 23866 AND e.encounter_type = 52 \n"
            + "                    AND o.voided = 0 AND e.voided = 0 AND o.location_id = :location AND o.value_datetime <= :endDate\n"
            + "                        GROUP BY o.person_id\n"
            + "        )max_expected GROUP BY max_expected.patient_id\n"
            + "    )expected ON expected.patient_id = p.patient_id\n"
            + "    LEFT JOIN (\n"
            + "        SELECT last_encounter.patient_id, last_follow_up_date, next_follow_up.next_follow_up_date FROM  \n"
            + "	        (\n"
            + "                SELECT MAX(e.encounter_datetime) last_follow_up_date, e.patient_id FROM encounter e\n"
            + "                    WHERE e.encounter_type IN(6,9)\n"
            + "                        AND e.voided = 0 AND e.location_id = :location AND e.encounter_datetime <= :endDate\n"
            + "                            GROUP BY e.patient_id\n"
            + "            ) last_encounter\n"
            + "            LEFT JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.value_datetime next_follow_up_date, o.obs_datetime FROM obs o\n"
            + "                        INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "                            WHERE o.concept_id = 1410 AND e.encounter_type IN(6,9) \n"
            + "                            AND o.voided = 0 AND e.voided = 0\n"
            + "            ) next_follow_up ON next_follow_up.patient_id = last_encounter.patient_id AND next_follow_up.obs_datetime = last_encounter.last_follow_up_date \n"
            + "    )last_encounter_and_follow_up ON last_encounter_and_follow_up.patient_id = p.patient_id\n"
            + "    LEFT JOIN \n"
            + "    (\n"
            + "        SELECT last_pickup.patient_id, MAX(last_pickup_date) last_pickup_date, MAX(next_pickup_date) next_pickup_date FROM  \n"
            + "	        (\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_pickup_date FROM encounter e\n"
            + "                    WHERE e.encounter_type = 18\n"
            + "                        AND e.voided = 0 AND e.location_id = :location AND e.encounter_datetime <= :endDate\n"
            + "                            GROUP BY e.patient_id\n"
            + "\n"
            + "                UNION\n"
            + "\n"
            + "                SELECT e.patient_id, MAX(e.encounter_datetime) last_encounter_date FROM encounter e\n"
            + "                    WHERE e.encounter_type = 60\n"
            + "                        AND e.voided = 0 AND e.location_id = :location AND e.encounter_datetime <= :endDate\n"
            + "                            GROUP BY e.patient_id\n"
            + "\n"
            + "            ) last_pickup\n"
            + "            LEFT JOIN \n"
            + "            (\n"
            + "                SELECT o.person_id patient_id, o.value_datetime next_pickup_date, o.obs_datetime FROM obs o\n"
            + "                        INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "                            WHERE o.concept_id = 5096 AND e.encounter_type = 18\n"
            + "                            AND o.voided = 0 AND e.voided = 0\n"
            + "\n"
            + "                UNION\n"
            + "\n"
            + "                SELECT o.person_id patient_id, o.value_datetime next_pickup_date, o.obs_datetime FROM obs o\n"
            + "                        INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "                            WHERE o.concept_id = 23988 AND e.encounter_type = 60\n"
            + "                            AND o.voided = 0 AND e.voided = 0\n"
            + "\n"
            + "            ) next_pickup ON next_pickup.patient_id = last_pickup.patient_id AND next_pickup.obs_datetime = last_pickup.last_pickup_date \n"
            + "\n"
            + "            UNION\n"
            + "\n"
            + "            SELECT o.person_id patient_id, MAX(o.value_datetime) as last_pickup_date, MAX((o.value_datetime + INTERVAL 30 DAY)) next_pickup_date FROM obs o\n"
            + "                INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "                    WHERE o.concept_id = 23866 AND e.encounter_type = 52 \n"
            + "                    AND o.voided = 0 AND e.voided = 0 AND o.location_id = :location AND o.value_datetime <= :endDate\n"
            + "                        GROUP BY o.person_id\n"
            + "    )last_and_next_pickup ON last_and_next_pickup.patient_id = p.patient_id\n"
            + "    LEFT JOIN\n"
            + "    (\n"
            + "        SELECT last_tpi_start.patient_id, tpi_start_date FROM \n"
            + "        (\n"
            + "            SELECT e.patient_id, MAX(e.encounter_datetime) last_tpi_start_date FROM encounter e\n"
            + "                INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                AND e.encounter_datetime <= :endDate AND e.location_id = :location\n"
            + "                AND o.concept_id = 6128 \n"
            + "                    GROUP BY e.patient_id\n"
            + "        )last_tpi_start\n"
            + "        INNER JOIN \n"
            + "        (\n"
            + "            SELECT o.person_id patient_id, o.obs_datetime tpi_start_value_date, o.value_datetime tpi_start_date FROM obs o\n"
            + "                WHERE o.concept_id = 6128\n"
            + "        )tpi_start_value ON last_tpi_start.patient_id = last_tpi_start.patient_id AND last_tpi_start.last_tpi_start_date = tpi_start_value.tpi_start_value_date\n"
            + "    )tpi_start ON tpi_start.patient_id = p.patient_id\n"
            + "    LEFT JOIN\n"
            + "    (\n"
            + "        SELECT last_tpi_ends.patient_id, tpi_ends_date FROM \n"
            + "        (\n"
            + "            SELECT e.patient_id, MAX(e.encounter_datetime) last_tpi_ends_date FROM encounter e\n"
            + "                INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "                WHERE e.voided  = 0 AND o.voided = 0\n"
            + "                AND e.encounter_datetime <= :endDate AND e.location_id = :location\n"
            + "                AND o.concept_id = 6129 \n"
            + "                    GROUP BY e.patient_id\n"
            + "        )last_tpi_ends\n"
            + "        INNER JOIN \n"
            + "        (\n"
            + "            SELECT o.person_id patient_id, o.obs_datetime tpi_ends_value_date, o.value_datetime tpi_ends_date FROM obs o\n"
            + "                WHERE o.concept_id = 6129\n"
            + "        )tpi_ends_value ON last_tpi_ends.patient_id = last_tpi_ends.patient_id AND last_tpi_ends.last_tpi_ends_date = tpi_ends_value.tpi_ends_value_date\n"
            + "    )tpi_ends ON tpi_ends.patient_id = p.patient_id\n"
            + "    LEFT JOIN\n"
            + "    (\n"
            + "        SELECT patient_id, Max(pregnant_date) pregnant_date FROM\n"
            + "        (\n"
            + "            SELECT p.patient_id, MAX(e.encounter_datetime) pregnant_date FROM patient p \n"
            + "                INNER JOIN encounter e on p.patient_id=e.patient_id \n"
            + "                INNER JOIN obs o on e.encounter_id=o.encounter_id \n"
            + "                WHERE p.voided=0 AND e.voided=0 \n"
            + "                    AND o.voided=0 AND concept_id=1982 AND value_coded=1065 \n"
            + "                    AND e.encounter_type in (5,6,53) AND e.encounter_datetime BETWEEN :startDate AND :endDate AND e.location_id = :location\n"
            + "                    GROUP BY p.patient_id\n"
            + "\n"
            + "            UNION \n"
            + "\n"
            + "            SELECT p.patient_id, MAX(e.encounter_datetime) pregnant_date FROM patient p \n"
            + "                INNER JOIN encounter e on p.patient_id=e.patient_id \n"
            + "                INNER JOIN obs o on e.encounter_id=o.encounter_id \n"
            + "                WHERE p.voided=0 AND e.voided=0 AND o.voided=0 \n"
            + "                    AND concept_id=1279 AND e.encounter_type in (5,6) \n"
            + "                    AND e.encounter_datetime between :startDate AND :endDate AND e.location_id = :location \n"
            + "                    GROUP BY p.patient_id\n"
            + "            UNION\n"
            + "\n"
            + "            SELECT 	p.patient_id, MAX(e.encounter_datetime) pregnant_date FROM patient p \n"
            + "                INNER JOIN encounter e on p.patient_id=e.patient_id \n"
            + "                INNER JOIN obs o on e.encounter_id=o.encounter_id \n"
            + "                    WHERE p.voided=0 AND e.voided=0 AND o.voided=0 \n"
            + "                    AND concept_id=1600 AND e.encounter_type in (5,6) AND e.encounter_datetime BETWEEN :startDate \n"
            + "                    AND :endDate AND e.location_id = :location \n"
            + "                    GROUP BY p.patient_id\n"
            + "            UNION\n"
            + "\n"
            + "            SELECT pp.patient_id,MAX(pp.date_enrolled) pregnant_date FROM patient_program pp \n"
            + "                WHERE pp.program_id=8 AND pp.voided=0 AND pp.date_enrolled BETWEEN :startDate AND :endDate \n"
            + "                    AND pp.location_id = :location\n"
            + "                    GROUP BY pp.patient_id\n"
            + "\n"
            + "            UNION\n"
            + "\n"
            + "            SELECT p.patient_id, MAX(o.value_datetime) pregnant_date FROM patient p \n"
            + "                INNER JOIN encounter e on p.patient_id=e.patient_id \n"
            + "                INNER JOIN obs o on e.encounter_id=o.encounter_id \n"
            + "                WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND o.concept_id=1465 \n"
            + "                    AND e.encounter_type=6 AND o.value_datetime BETWEEN :startDate AND :endDate \n"
            + "                    AND e.location_id = :location\n"
            + "                    GROUP BY p.patient_id\n"
            + "            \n"
            + "            UNION\n"
            + "\n"
            + "            SELECT p.patient_id, MAX(e.encounter_datetime) pregnant_date FROM patient p \n"
            + "                INNER JOIN encounter e on p.patient_id=e.patient_id \n"
            + "                INNER JOIN obs o on e.encounter_id=o.encounter_id \n"
            + "                WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id=6334 AND value_coded=6331 \n"
            + "                AND e.encounter_type in (5,6) AND e.encounter_datetime BETWEEN :startDate AND :endDate \n"
            + "                AND e.location_id = :location\n"
            + "                GROUP BY p.patient_id\n"
            + "\n"
            + "        )max_pregnant GROUP BY max_pregnant.patient_id \n"
            + "    )pregnant ON pregnant.patient_id = p.patient_id\n"
            + "    LEFT JOIN\n"
            + "    (\n"
            + "        SELECT patient_id, MAX(breastfeeding_date) breastfeeding_date FROM\n"
            + "        (\n"
            + "            SELECT p.patient_id,o.value_datetime breastfeeding_date FROM patient p \n"
            + "                INNER JOIN encounter e on p.patient_id=e.patient_id \n"
            + "                INNER JOIN obs o on e.encounter_id=o.encounter_id \n"
            + "                    WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id=5599 \n"
            + "                        AND e.encounter_type in (5,6) AND o.value_datetime BETWEEN :startDate AND :endDate \n"
            + "                        AND e.location_id = :location\n"
            + "                        GROUP BY p.patient_id\n"
            + "            UNION \n"
            + "\n"
            + "            SELECT p.patient_id, e.encounter_datetime breastfeeding_date FROM patient p \n"
            + "                INNER JOIN encounter e on p.patient_id=e.patient_id \n"
            + "                INNER JOIN obs o on e.encounter_id=o.encounter_id \n"
            + "                    WHERE p.voided=0 AND e.voided=0 AND o.voided=0 \n"
            + "                    AND concept_id=6332 AND value_coded=1065 \n"
            + "                    AND e.encounter_type=6 AND e.encounter_datetime BETWEEN :startDate AND :endDate \n"
            + "                    AND e.location_id = :location\n"
            + "                    GROUP BY p.patient_id\n"
            + "\n"
            + "            UNION \n"
            + "                SELECT p.patient_id, e.encounter_datetime breastfeeding_date FROM patient p \n"
            + "                    INNER JOIN encounter e on p.patient_id=e.patient_id \n"
            + "                    INNER JOIN obs o on e.encounter_id=o.encounter_id \n"
            + "                        WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id=6334 \n"
            + "                        AND value_coded=6332 AND e.encounter_type in (5,6) AND e.encounter_datetime BETWEEN :startDate AND :endDate \n"
            + "                            AND e.location_id = :location\n"
            + "                            GROUP BY p.patient_id\n"
            + "            UNION \n"
            + "                SELECT pg.patient_id,ps.start_date breastfeeding_date FROM patient p \n"
            + "                    INNER JOIN patient_program pg on p.patient_id=pg.patient_id \n"
            + "                        INNER JOIN patient_state ps on pg.patient_program_id=ps.patient_program_id \n"
            + "                        WHERE pg.voided=0 AND ps.voided=0 AND p.voided=0 AND pg.program_id=8 AND ps.state=27 \n"
            + "                            AND ps.end_date IS NULL AND ps.start_date BETWEEN :startDate AND :endDate \n"
            + "                            AND location_id = :location\n"
            + "                            GROUP BY p.patient_id\n"
            + "\n"
            + "        )max_breastfeeding GROUP BY max_breastfeeding.patient_id\n"
            + "    )breastfeeding ON breastfeeding.patient_id = p.patient_id\n"
            + "WHERE (exits.state_date IS NULL OR (exits.state_date IS NOT NULL AND expected.last_encounter_date > exits.state_date))\n"
            + "AND (next_pickup_date + INTERVAL 28 DAY) >= :endDate\n"
            + "    GROUP BY p.patient_id\n"
            + "    ORDER BY pi.identifier";
  }
}
