/** */
package org.openmrs.module.eptsreports.reporting.library.queries.listings;

/** @author Stélio Moiane */
public interface SerachedPatientQueries {

  class QUERY {
    public static final String findSearchedPatientsList =
        "SELECT p.patient_id, pi.identifier, CONCAT(pn.given_name, ' ', COALESCE(pn.middle_name, ''), ' ', pn.family_name)name, pe.gender, (YEAR( :endDate) - YEAR(pe.birthdate)) age, patient_contact, pa.address1, pa.address3, pa.address5, sector, type_of_visit, start_art.art_start_date, expected_date, IF(type_of_visit = 'Visita Preventiva' OR type_of_visit = 'Visita aos Casos Especiais','NA', IF(last_encounter.encounter_date = 'NULL', DATEDIFF(NOW(), expected_date), DATEDIFF(last_encounter.encounter_date, expected_date))) missing_days, patients_found.last_visit, last_encounter.encounter_date, volunteer, agreed_date FROM patient p\n"
            + "            	INNER JOIN patient_identifier pi ON p.patient_id = pi.patient_id\n"
            + "            	INNER JOIN person_name pn ON pn.person_id = p.patient_id\n"
            + "            	INNER JOIN person pe ON pe.person_id = p.patient_id\n"
            + "            	INNER JOIN person_address pa ON pa.person_id = p.patient_id\n"
            + "            \n"
            + "            INNER JOIN \n"
            + "            (\n"
            + "            	SELECT patient_id, MIN(art_start_date) art_start_date FROM\n"
            + "                        (	\n"
            + "            				SELECT p.patient_id,MIN(e.encounter_datetime) art_start_date FROM patient p \n"
            + "            					INNER JOIN encounter e ON p.patient_id=e.patient_id	\n"
            + "            					INNER JOIN obs o on o.encounter_id=e.encounter_id \n"
            + "            						WHERE e.voided=0 AND o.voided=0 AND p.voided=0 \n"
            + "            						AND e.encounter_type IN (18,6,9) AND o.concept_id=1255 AND o.value_coded=1256 \n"
            + "            						AND e.encounter_datetime<= :endDate AND e.location_id = :location\n"
            + "            							GROUP BY p.patient_id\n"
            + "            				UNION\n"
            + "            		\n"
            + "            				SELECT p.patient_id,MIN(value_datetime) art_start_date FROM patient p\n"
            + "            					INNER JOIN encounter e ON p.patient_id=e.patient_id\n"
            + "            					INNER JOIN obs o ON e.encounter_id=o.encounter_id\n"
            + "            						WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND e.encounter_type in (18,6,9,53) \n"
            + "            						AND o.concept_id=1190 AND o.value_datetime is NOT NULL \n"
            + "            						AND o.value_datetime<= :endDate AND e.location_id = :location\n"
            + "            							GROUP BY p.patient_id\n"
            + "            				\n"
            + "            				UNION\n"
            + "            \n"
            + "            				SELECT pg.patient_id,MIN(date_enrolled) art_start_date FROM patient p \n"
            + "            					INNER JOIN patient_program pg ON p.patient_id=pg.patient_id\n"
            + "            						WHERE pg.voided=0 AND p.voided=0 AND program_id=2 AND date_enrolled<= :endDate AND pg.location_id = :location\n"
            + "            							GROUP BY pg.patient_id\n"
            + "            				\n"
            + "            				UNION\n"
            + "            				\n"
            + "            				SELECT e.patient_id, MIN(e.encounter_datetime) AS art_start_date FROM patient p\n"
            + "            					INNER JOIN encounter e ON p.patient_id=e.patient_id\n"
            + "            				  		WHERE p.voided=0 and e.encounter_type=18 AND e.voided=0 AND e.encounter_datetime<= :endDate AND e.location_id = :location\n"
            + "            				  			GROUP BY p.patient_id\n"
            + "            			  \n"
            + "            				UNION\n"
            + "            				\n"
            + "            				SELECT p.patient_id,MIN(value_datetime) art_start_date FROM patient p\n"
            + "            					INNER JOIN encounter e ON p.patient_id=e.patient_id\n"
            + "            					INNER JOIN obs o ON e.encounter_id=o.encounter_id\n"
            + "            						WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND e.encounter_type=52 \n"
            + "            						AND o.concept_id=23866 and o.value_datetime is NOT NULL \n"
            + "            						AND o.value_datetime<= :endDate AND e.location_id = :location\n"
            + "            							GROUP BY p.patient_id	\n"
            + "            	\n"
            + "            		)min_art_start_date GROUP BY min_art_start_date.patient_id\n"
            + "            	\n"
            + "            )start_art ON start_art.patient_id = p.patient_id\n"
            + "            \n"
            + "            INNER JOIN\n"
            + "            (\n"
            + "            	SELECT patient_id, MAX(visit_date) last_visit, encounter_id FROM(\n"
            + "            			SELECT p.patient_id, MAX(e.encounter_datetime) visit_date, e.encounter_id FROM patient p\n"
            + "            				INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "            				INNER JOIN obs o ON o.encounter_id = e.encounter_id\n"
            + "            					WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND encounter_type = 21 \n"
            + "            						AND o.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "            						AND e.location_id = :location AND e.encounter_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "            							GROUP BY p.patient_id\n"
            + "            						\n"
            + "            		UNION\n"
            + "            	\n"
            + "            		SELECT p.patient_id, MAX(o.value_datetime) visit_date, e.encounter_id FROM patient p\n"
            + "            			INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "            			INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "            			INNER JOIN obs obs_found ON obs_found.encounter_id = e.encounter_id\n"
            + "            				WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND obs_found.voided = 0\n"
            + "            					AND encounter_type = 21 AND o.concept_id = 6254 AND obs_found.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "            					AND o.value_datetime IS NOT NULL AND e.location_id = :location AND o.value_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "            						GROUP BY p.patient_id\n"
            + "            		\n"
            + "            		UNION\n"
            + "            	\n"
            + "            		SELECT p.patient_id, MAX(o.value_datetime) visit_date, e.encounter_id FROM patient p\n"
            + "            			INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "            			INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "            			INNER JOIN obs obs_found ON obs_found.encounter_id = e.encounter_id\n"
            + "            				WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND obs_found.voided = 0\n"
            + "            					AND encounter_type = 21 AND o.concept_id = 6255 AND obs_found.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "            					AND o.value_datetime IS NOT NULL AND e.location_id = :location AND o.value_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "            						GROUP BY p.patient_id\n"
            + "            						\n"
            + "            	)patient_last_visit GROUP BY patient_id\n"
            + "            )patients_found ON patients_found.patient_id = p.patient_id\n"
            + "            \n"
            + "            LEFT JOIN\n"
            + "            (\n"
            + "				SELECT p.patient_id, MIN(e.encounter_datetime) encounter_date FROM patient p\n"
            + "						INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "						INNER JOIN\n"
            + "						(\n"
            + "								SELECT patient_id, MIN(visit_date) last_visit FROM(\n"
            + "									SELECT p.patient_id, MIN(e.encounter_datetime) visit_date FROM patient p\n"
            + "										INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "										INNER JOIN obs o ON o.encounter_id = e.encounter_id\n"
            + "											WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND encounter_type = 21 \n"
            + "												AND o.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "												AND e.location_id = :location AND e.encounter_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "													GROUP BY p.patient_id\n"
            + "												\n"
            + "								UNION\n"
            + "							\n"
            + "								SELECT p.patient_id, MIN(o.value_datetime) visit_date FROM patient p\n"
            + "									INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "									INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "									INNER JOIN obs obs_found ON obs_found.encounter_id = e.encounter_id\n"
            + "										WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND obs_found.voided = 0\n"
            + "											AND encounter_type = 21 AND o.concept_id = 6254 AND obs_found.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "											AND o.value_datetime IS NOT NULL AND e.location_id = :location AND o.value_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "												GROUP BY p.patient_id\n"
            + "								\n"
            + "								UNION\n"
            + "							\n"
            + "								SELECT p.patient_id, MIN(o.value_datetime) visit_date FROM patient p\n"
            + "									INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "									INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "									INNER JOIN obs obs_found ON obs_found.encounter_id = e.encounter_id\n"
            + "										WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND obs_found.voided = 0\n"
            + "											AND encounter_type = 21 AND o.concept_id = 6255 AND obs_found.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "											AND o.value_datetime IS NOT NULL AND e.location_id = :location AND o.value_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "												GROUP BY p.patient_id\n"
            + "														\n"
            + "									)patient_last_visit GROUP BY patient_id\n"
            + "						)last_visit_performded ON last_visit_performded.patient_id = p.patient_id\n"
            + "							WHERE e.voided = 0 AND p.voided = 0 AND e.encounter_type IN (6,18,35,53)\n"
            + "							AND e.encounter_datetime >= last_visit_performded.last_visit\n"
            + "									GROUP BY p.patient_id\n"
            + "            )last_encounter ON patients_found.patient_id = last_encounter.patient_id\n"
            + "            \n"
            + "            LEFT JOIN \n"
            + "            (\n"
            + "            	SELECT pa.person_id patient_id, pa.value patient_contact FROM person_attribute pa\n"
            + "            		WHERE pa.person_attribute_type_id = 9\n"
            + "            	         GROUP BY pa.person_id\n"
            + "            )patient_contact ON patient_contact.patient_id = p.patient_id\n"
            + "            \n"
            + "            LEFT JOIN\n"
            + "            (\n"
            + "            	SELECT o.person_id patient_id, CASE \n"
            + "            		WHEN o.value_coded = 2175 THEN 'TARV (Clínica/APSS e PP)'\n"
            + "            		WHEN o.value_coded = 1872 THEN 'CCR'\n"
            + "            		WHEN o.value_coded = 1598 THEN 'CPN'\n"
            + "            		WHEN o.value_coded = 1414 THEN 'PNCT'\n"
            + "            		WHEN o.value_coded = 1987 THEN 'SAAJ'\n"
            + "            		WHEN o.value_coded = 23913 THEN 'OUTRO'\n"
            + "            		ELSE null END AS sector, e.encounter_id FROM obs o\n"
            + "            			INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "            				WHERE e.voided = 0 AND o.voided = 0 AND e.encounter_type = 21\n"
            + "            				AND e.location_id = :location\n"
            + "            				AND o.concept_id = 2176\n"
            + "            					GROUP BY patient_id\n"
            + "            )sector ON p.patient_id = sector.patient_id AND patients_found.encounter_id = sector.encounter_id\n"
            + "            \n"
            + "            LEFT JOIN \n"
            + "            (\n"
            + "            	SELECT o.person_id patient_id, CASE \n"
            + "            		WHEN o.value_coded = 2161 THEN 'Visita Preventiva'\n"
            + "            		WHEN o.value_coded = 2160 THEN 'Visita de Reintegração'\n"
            + "            		WHEN o.value_coded = 23914 THEN 'Visita aos Casos Especiais'\n"
            + "            		ELSE null END AS type_of_visit, o.encounter_id FROM obs o\n"
            + "            			INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "            				WHERE e.voided = 0 AND o.voided = 0 AND e.encounter_type = 21\n"
            + "            				AND o.concept_id = 1981 AND e.location_id = :location\n"
            + "            					GROUP BY patient_id\n"
            + "            )type_of_visit ON type_of_visit.patient_id = p.patient_id AND patients_found.encounter_id = type_of_visit.encounter_id\n"
            + "            \n"
            + "            LEFT JOIN\n"
            + "            (\n"
            + "				SELECT o.person_id patient_id, o.value_text volunteer, o.encounter_id  FROM obs o\n"
            + "            			INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "            				WHERE e.voided = 0 AND o.voided = 0 AND e.encounter_type = 21\n"
            + "            				AND e.location_id = :location\n"
            + "            				AND o.concept_id = 1912\n"
            + "            					GROUP BY patient_id\n"
            + "            )volunteer ON volunteer.patient_id = p.patient_id AND patients_found.encounter_id = volunteer.encounter_id\n"
            + "            LEFT JOIN\n"
            + "            (\n"
            + "				SELECT patient_id, Max(expected_date) expected_date FROM (\n"
            + "\n"
            + "					SELECT o.person_id patient_id, MAX(o.value_datetime) expected_date FROM obs o\n"
            + "						INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "						INNER JOIN \n"
            + "						(\n"
            + "							SELECT patient_id, MAX(visit_date) last_visit FROM(\n"
            + "								SELECT p.patient_id, MAX(e.encounter_datetime) visit_date FROM patient p\n"
            + "									INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "									INNER JOIN obs o ON o.encounter_id = e.encounter_id\n"
            + "										WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND encounter_type = 21 \n"
            + "											AND o.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "											AND e.location_id = :location AND e.encounter_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "												GROUP BY p.patient_id\n"
            + "											\n"
            + "							UNION\n"
            + "						\n"
            + "							SELECT p.patient_id, MAX(o.value_datetime) visit_date FROM patient p\n"
            + "								INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "								INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "								INNER JOIN obs obs_found ON obs_found.encounter_id = e.encounter_id\n"
            + "									WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND obs_found.voided = 0\n"
            + "										AND encounter_type = 21 AND o.concept_id = 6254 AND obs_found.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "										AND o.value_datetime IS NOT NULL AND e.location_id = :location AND o.value_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "											GROUP BY p.patient_id\n"
            + "							\n"
            + "							UNION\n"
            + "						\n"
            + "							SELECT p.patient_id, MAX(o.value_datetime) visit_date FROM patient p\n"
            + "								INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "								INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "								INNER JOIN obs obs_found ON obs_found.encounter_id = e.encounter_id\n"
            + "									WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND obs_found.voided = 0\n"
            + "										AND encounter_type = 21 AND o.concept_id = 6255 AND obs_found.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "										AND o.value_datetime IS NOT NULL AND e.location_id = :location AND o.value_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "											GROUP BY p.patient_id\n"
            + "													\n"
            + "								)patient_last_visit GROUP BY patient_id\n"
            + "						)last_visit_performded ON last_visit_performded.patient_id = o.person_id\n"
            + "						WHERE o.concept_id = 1410 AND e.encounter_type IN(6,9) AND o.value_datetime IS NOT NULL\n"
            + "						AND o.voided = 0 AND e.voided = 0 AND e.location_id = :location AND o.value_datetime <= last_visit_performded.last_visit\n"
            + "							GROUP BY o.person_id\n"
            + "					UNION\n"
            + "					\n"
            + "					SELECT o.person_id patient_id, MAX(o.value_datetime) expected_date FROM obs o\n"
            + "						INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "						INNER JOIN \n"
            + "						(\n"
            + "							SELECT patient_id, MAX(visit_date) last_visit FROM(\n"
            + "								SELECT p.patient_id, MAX(e.encounter_datetime) visit_date FROM patient p\n"
            + "									INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "									INNER JOIN obs o ON o.encounter_id = e.encounter_id\n"
            + "										WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND encounter_type = 21 \n"
            + "											AND o.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "											AND e.location_id = :location AND e.encounter_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "												GROUP BY p.patient_id\n"
            + "											\n"
            + "							UNION\n"
            + "						\n"
            + "							SELECT p.patient_id, MAX(o.value_datetime) visit_date FROM patient p\n"
            + "								INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "								INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "								INNER JOIN obs obs_found ON obs_found.encounter_id = e.encounter_id\n"
            + "									WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND obs_found.voided = 0\n"
            + "										AND encounter_type = 21 AND o.concept_id = 6254 AND obs_found.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "										AND o.value_datetime IS NOT NULL AND e.location_id = :location AND o.value_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "											GROUP BY p.patient_id\n"
            + "							\n"
            + "							UNION\n"
            + "						\n"
            + "							SELECT p.patient_id, MAX(o.value_datetime) visit_date FROM patient p\n"
            + "								INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "								INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "								INNER JOIN obs obs_found ON obs_found.encounter_id = e.encounter_id\n"
            + "									WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND obs_found.voided = 0\n"
            + "										AND encounter_type = 21 AND o.concept_id = 6255 AND obs_found.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "										AND o.value_datetime IS NOT NULL AND e.location_id = :location AND o.value_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "											GROUP BY p.patient_id\n"
            + "													\n"
            + "								)patient_last_visit GROUP BY patient_id\n"
            + "						)last_visit_performded ON last_visit_performded.patient_id = o.person_id\n"
            + "						WHERE o.concept_id = 5096 AND e.encounter_type = 18 AND o.value_datetime IS NOT NULL\n"
            + "						AND o.voided = 0 AND e.voided = 0 AND e.location_id = :location AND o.value_datetime <= last_visit_performded.last_visit\n"
            + "							GROUP BY o.person_id\n"
            + "					UNION\n"
            + "					\n"
            + "					SELECT o.person_id patient_id, MAX((o.value_datetime + INTERVAL 28 DAY)) expected_date FROM obs o\n"
            + "						INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "						INNER JOIN \n"
            + "						(\n"
            + "							SELECT patient_id, MAX(visit_date) last_visit FROM(\n"
            + "								SELECT p.patient_id, MAX(e.encounter_datetime) visit_date FROM patient p\n"
            + "									INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "									INNER JOIN obs o ON o.encounter_id = e.encounter_id\n"
            + "										WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND encounter_type = 21 \n"
            + "											AND o.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "											AND e.location_id = :location AND e.encounter_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "												GROUP BY p.patient_id\n"
            + "											\n"
            + "							UNION\n"
            + "						\n"
            + "							SELECT p.patient_id, MAX(o.value_datetime) visit_date FROM patient p\n"
            + "								INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "								INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "								INNER JOIN obs obs_found ON obs_found.encounter_id = e.encounter_id\n"
            + "									WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND obs_found.voided = 0\n"
            + "										AND encounter_type = 21 AND o.concept_id = 6254 AND obs_found.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "										AND o.value_datetime IS NOT NULL AND e.location_id = :location AND o.value_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "											GROUP BY p.patient_id\n"
            + "							\n"
            + "							UNION\n"
            + "						\n"
            + "							SELECT p.patient_id, MAX(o.value_datetime) visit_date FROM patient p\n"
            + "								INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "								INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "								INNER JOIN obs obs_found ON obs_found.encounter_id = e.encounter_id\n"
            + "									WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND obs_found.voided = 0\n"
            + "										AND encounter_type = 21 AND o.concept_id = 6255 AND obs_found.concept_id IN (2016, 2157, 2158, 1272, 23933, 23934, 23935)\n"
            + "										AND o.value_datetime IS NOT NULL AND e.location_id = :location AND o.value_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "											GROUP BY p.patient_id\n"
            + "													\n"
            + "								)patient_last_visit GROUP BY patient_id\n"
            + "						)last_visit_performded ON last_visit_performded.patient_id = o.person_id\n"
            + "						WHERE o.concept_id = 23866 AND e.encounter_type = 52 AND o.value_datetime IS NOT NULL\n"
            + "						AND o.voided = 0 AND e.voided = 0 AND e.location_id = :location AND (o.value_datetime + INTERVAL 28 DAY) <= last_visit_performded.last_visit\n"
            + "							GROUP BY o.person_id \n"
            + "				)expected_date GROUP BY patient_id\n"
            + "            )expected ON expected.patient_id = p.patient_id\n"
            + "			LEFT JOIN \n"
            + "			(\n"
            + "				SELECT p.patient_id, MAX(o.value_datetime) agreed_date FROM patient p\n"
            + "					INNER JOIN encounter e ON e.patient_id = p.patient_id\n"
            + "					INNER JOIN obs o ON e.encounter_id = o.encounter_id\n"
            + "						WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0\n"
            + "							AND encounter_type = 21 AND o.concept_id IN (23933, 23934, 23935)\n"
            + "							AND o.value_datetime IS NOT NULL AND e.location_id = :location AND o.value_datetime BETWEEN ( :startDate - INTERVAL 15 DAY) AND ( :endDate - INTERVAL 15 DAY)\n"
            + "								GROUP BY p.patient_id\n"
            + "			)agreed_date ON agreed_date.patient_id = p.patient_id\n"
            + "            WHERE p.voided = 0 AND pi.voided = 0 AND pi.identifier_type = 2 AND pn.voided = 0 AND pe.voided = 0\n"
            + "            	GROUP BY p.patient_id\n"
            + "            	ORDER BY pi.identifier";
  }
}
