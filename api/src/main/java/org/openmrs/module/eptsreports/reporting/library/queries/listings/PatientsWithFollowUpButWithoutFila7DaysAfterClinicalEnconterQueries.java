/** */
package org.openmrs.module.eptsreports.reporting.library.queries.listings;

/** @author St√©lio Moiane */
public interface PatientsWithFollowUpButWithoutFila7DaysAfterClinicalEnconterQueries {

  class QUERY {
    public static final String findPatientsWithFollowUpButWithoutFila7DaysAfterClinicalEnconter =
        "select seguimento_sem_fila.patient_id,\n"
            + "		seguimento_sem_fila.data_seguimento,\n"
            + "		concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) nome,\n"
            + "		pid.identifier as nid\n"
            + "from\n"
            + "(\n"
            + "	select * from \n"
            + "	(	\n"
            + "		SELECT distinct	p.patient_id, e.encounter_datetime AS data_seguimento \n"
            + "		FROM 	patient p\n"
            + "				inner join encounter e on p.patient_id=e.patient_id\n"
            + "		WHERE	p.voided=0 and e.encounter_type in (6,9) AND e.voided=0 and \n"
            + "				e.encounter_datetime between :startDate and :endDate and \n"
            + "				e.location_id=:location\n"
            + "		ORDER BY 1,2\n"
            + "	) seguimento\n"
            + "	where not exists \n"
            + "	(\n"
            + "		select * from\n"
            + "		(\n"
            + "			SELECT 	distinct p.patient_id, e.encounter_datetime AS data_fila \n"
            + "			FROM 	patient p\n"
            + "					inner join encounter e on p.patient_id=e.patient_id\n"
            + "			WHERE	p.voided=0 and e.encounter_type=18 AND e.voided=0 and \n"
            + "					e.encounter_datetime between :startDate and CURDATE() and \n"
            + "					e.location_id=:location			\n"
            + "		) fila\n"
            + "		where fila.patient_id=seguimento.patient_id and fila.data_fila between seguimento.data_seguimento and DATE_ADD(seguimento.data_seguimento, INTERVAL 7 DAY)\n"
            + "	)\n"
            + ") seguimento_sem_fila\n"
            + "inner join \n"
            + "(	\n"
            + "\n"
            + "	/*Patients on ART who initiated the ARV DRUGS: ART Regimen Start Date*/\n"
            + "				\n"
            + "	Select 	p.patient_id\n"
            + "	from 	patient p\n"
            + "			inner join encounter e on p.patient_id=e.patient_id	\n"
            + "			inner join obs o on o.encounter_id=e.encounter_id\n"
            + "	where 	e.voided=0 and o.voided=0 and p.voided=0 and \n"
            + "			e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and \n"
            + "			e.encounter_datetime<=:endDate and e.location_id=:location\n"
            + "	group by p.patient_id\n"
            + "\n"
            + "	union\n"
            + "\n"
            + "	/*Patients on ART who have art start date: ART Start date*/\n"
            + "	Select 	p.patient_id\n"
            + "	from 	patient p\n"
            + "			inner join encounter e on p.patient_id=e.patient_id\n"
            + "			inner join obs o on e.encounter_id=o.encounter_id\n"
            + "	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and \n"
            + "			o.concept_id=1190 and o.value_datetime is not null and \n"
            + "			o.value_datetime<=:endDate and e.location_id=:location\n"
            + "	group by p.patient_id\n"
            + "\n"
            + "	union\n"
            + "\n"
            + "	/*Patients enrolled in ART Program: OpenMRS Program*/\n"
            + "	select 	pg.patient_id\n"
            + "	from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
            + "	where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate and location_id=:location\n"
            + "	group by pg.patient_id\n"
            + "	\n"
            + "	union\n"
            + "	\n"
            + "	\n"
            + "	/*Patients with first drugs pick up date set in Pharmacy: First ART Start Date*/\n"
            + "	  SELECT 	e.patient_id \n"
            + "	  FROM 		patient p\n"
            + "				inner join encounter e on p.patient_id=e.patient_id\n"
            + "	  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location\n"
            + "	  GROUP BY 	p.patient_id\n"
            + "  \n"
            + "	union\n"
            + "	\n"
            + "	/*Patients with first drugs pick up date set: Recepcao Levantou ARV*/\n"
            + "	Select 	p.patient_id\n"
            + "	from 	patient p\n"
            + "			inner join encounter e on p.patient_id=e.patient_id\n"
            + "			inner join obs o on e.encounter_id=o.encounter_id\n"
            + "	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and \n"
            + "			o.concept_id=23866 and o.value_datetime is not null and \n"
            + "			o.value_datetime<=:endDate and e.location_id=:location\n"
            + "	group by p.patient_id	\n"
            + "						\n"
            + ") inicio on seguimento_sem_fila.patient_id=inicio.patient_id\n"
            + "left join \n"
            + "(	select pid1.*\n"
            + "	from patient_identifier pid1\n"
            + "	inner join \n"
            + "		(\n"
            + "			select patient_id,min(patient_identifier_id) id \n"
            + "			from patient_identifier\n"
            + "			where voided=0\n"
            + "			group by patient_id\n"
            + "		) pid2\n"
            + "	where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
            + ") pid on pid.patient_id=seguimento_sem_fila.patient_id\n"
            + "left join \n"
            + "(	select pn1.*\n"
            + "	from person_name pn1\n"
            + "	inner join \n"
            + "		(\n"
            + "			select person_id,min(person_name_id) id \n"
            + "			from person_name\n"
            + "			where voided=0\n"
            + "			group by person_id\n"
            + "		) pn2\n"
            + "	where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
            + ") pn on pn.person_id=seguimento_sem_fila.patient_id";
  }
}
