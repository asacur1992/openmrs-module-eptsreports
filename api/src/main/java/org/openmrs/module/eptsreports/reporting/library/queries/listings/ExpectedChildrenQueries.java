/** */
package org.openmrs.module.eptsreports.reporting.library.queries.listings;

/** @author Abdul Sacur */
public interface ExpectedChildrenQueries {

  class QUERY {
    public static  String findExpectedPatientsList =
    		   "             select coorteprox_consulta.patient_id,                                                                                                                                                   "
    				+"             		pid.identifier as NID ,                                                                                                                                                       "
    				+"             		concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ') nome,                                                                                                      "
    				+"                     concat(ifnull(pn.family_name,'')) apelido,                                                                                                                                 "
    				+"             		coorteprox_consulta.data_inicio,                                                                                                                                              "
    				+"             		coorteprox_consulta.gender as sexo,                                                                                                                                           "
    				+"                     coorteprox_consulta.idade_actual,                                                                                                                                          "
    				+"                     peso.peso,                                                                                                                                                                 "
    				+"                     consulta.consulta_data_agendada,                                                                                                                                           "
    				+"                     levantamento.levantamento_data_agendada,                                                                                                                                   "
    				+"                     ultima_consulta.data_seguimento ultm_cons_data,                                                                                                                            "
    				+"                     utlimo_levantamento.data_fila ultm_levnt_data,                                                                                                                             "
    				+"                     regimeFila.ultimo_regime,                                                                                                                                                  "
    				+"                     med.medicamento,                                                                                                                                                           "
    				+"                     IF(sector.sector is not null,sector.sector,'') sector,                                                                                                                     "
    				+"                     carga_viral.data_carga,                                                                                                                                                    "
    				+"                     ultima_cv.Valor_carga,                                                                                                                                                     "
    				+"                     gaac_model.mds_gaac, af_model.mds_af, ca_model.mds_ca, pu_model.mds_pu, fr_model.mds_fr,                                                                                   "
    				+"                     dt_model.mds_dt, dc_model.mds_dc, ds_model.mds_ds, tb_model.mds_tb, saaj_model.mds_saaj,smi_model.mds_smi,                                                                 "
    				+"                     dd_model.mds_dd, dcp_model.mds_dcp, dca_model.mds_dca,bm_model.mds_bm,cm_model.mds_cm,eh_model.mds_eh,                                                                     "
    				+"                     dah_model.mds_dah, da_model.mds_da,                                                                                                                                        "
    				+"                      IF(patient_contact.patient_contact  is not null, patient_contact.patient_contact,                                                                                         "
    				+"                     IF(patient_contact2.patient_contact  is not null, patient_contact2.patient_contact, '')) contacto,                                                                         "
    				+"                     concat(ifnull(concat(', ',pad3.address5), ' '),ifnull(concat(', ',pad3.address1), ' '),ifnull(concat(',',pad3.address3), ' ')) endereco                                    "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                     from                                                                                                                                                                       "
    				+"             		(select consulta_menor_14.patient_id,                                                                                                                                         "
    				+"             				consulta_menor_14.gender,                                                                                                                                             "
    				+"                             consulta_menor_14.idade_actual,                                                                                                                                    "
    				+"                             consulta_menor_14.data_inicio,                                                                                                                                     "
    				+"                             consulta_menor_14.age                                                                                                                                              "
    				+"                             from                                                                                                                                                               "
    				+"             					(select consulta.patient_id,                                                                                                                                      "
    				+"             							pe.gender,                                                                                                                                                "
    				+"                                         FLOOR(datediff(:endDate,pe.birthdate)/365) idade_actual,                                                                                               "
    				+"                                         consulta.data_inicio,                                                                                                                                  "
    				+"                                         (YEAR( :endDate ) - YEAR(pe.birthdate)) age                                                                                                            "
    				+"             							from                                                                                                                                                      "
    				+"             						(select prox_consulta.patient_id,                                                                                                                             "
    				+"             								inicio_real.data_inicio                                                                                                                               "
    				+"             							from                                                                                                                                                      "
    				+"             (                                                                                                                                                                                  "
    				+"             Select 	p.patient_id,max(value_datetime)                                                                                                                                          "
    				+"                          						from 	patient p                                                                                                                             "
    				+"                          								inner join encounter e on p.patient_id=e.patient_id                                                                                   "
    				+"                          								inner join obs o on e.encounter_id=o.encounter_id                                                                                     "
    				+"                          						where 	 o.concept_id = 1410 and p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9)                                       "
    				+"                                                 and o.value_datetime BETWEEN :startDate AND :endDate                                                                                           "
    				+"                          								 and e.location_id=:location                                                                                                          "
    				+"                          						group by p.patient_id ) prox_consulta                                                                                                         "
    				+"             						                                                                                                                                                              "
    				+"                                                 inner join                                                                                                                                     "
    				+"             (	Select patient_id,min(data_inicio) data_inicio                                                                                                                                "
    				+"             	from                                                                                                                                                                              "
    				+"             		(	                                                                                                                                                                          "
    				+"             		-- Patients on ART who initiated the ARV DRUGS: ART Regimen Start Date/                                                                                                       "
    				+"                                                                                                                                                                                                "
    				+"             		Select 	p.patient_id,min(e.encounter_datetime) data_inicio                                                                                                                    "
    				+"             		from 	patient p                                                                                                                                                             "
    				+"             				inner join encounter e on p.patient_id=e.patient_id	                                                                                                                  "
    				+"             				inner join obs o on o.encounter_id=e.encounter_id                                                                                                                     "
    				+"             		where 	e.voided=0 and o.voided=0 and p.voided=0 and                                                                                                                          "
    				+"             				e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and                                                                                         "
    				+"             				e.encounter_datetime<=:endDate  and e.location_id=:location                                                                                                           "
    				+"             		group by p.patient_id                                                                                                                                                         "
    				+"                                                                                                                                                                                                "
    				+"             		union                                                                                                                                                                         "
    				+"                                                                                                                                                                                                "
    				+"             		                                                                                                                                                                              "
    				+"             		Select 	p.patient_id,min(value_datetime) data_inicio                                                                                                                          "
    				+"             		from 	patient p                                                                                                                                                             "
    				+"             				inner join encounter e on p.patient_id=e.patient_id                                                                                                                   "
    				+"             				inner join obs o on e.encounter_id=o.encounter_id                                                                                                                     "
    				+"             		where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and                                                                                      "
    				+"             				o.concept_id=1190 and o.value_datetime is not null and                                                                                                                "
    				+"             				o.value_datetime<=:endDate  and e.location_id=:location                                                                                                               "
    				+"             		group by p.patient_id                                                                                                                                                         "
    				+"                                                                                                                                                                                                "
    				+"             		union                                                                                                                                                                         "
    				+"                                                                                                                                                                                                "
    				+"             		                                                                                                                                                                              "
    				+"             		select 	pg.patient_id,min(date_enrolled) data_inicio                                                                                                                          "
    				+"             		from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id                                                                                                 "
    				+"             		where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate  and location_id=:location                                                                    "
    				+"             		group by pg.patient_id                                                                                                                                                        "
    				+"             		                                                                                                                                                                              "
    				+"             		union                                                                                                                                                                         "
    				+"             		                                                                                                                                                                              "
    				+"             		                                                                                                                                                                              "
    				+"             		-- Patients with first drugs pick up date set in Pharmacy: First ART Start Date/                                                                                              "
    				+"             		  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio                                                                                                            "
    				+"             		  FROM 		patient p                                                                                                                                                         "
    				+"             					inner join encounter e on p.patient_id=e.patient_id                                                                                                               "
    				+"             		  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=:endDate  and e.location_id=:location                                                 "
    				+"             		  GROUP BY 	p.patient_id                                                                                                                                                      "
    				+"             	                                                                                                                                                                                  "
    				+"             		union                                                                                                                                                                         "
    				+"             		                                                                                                                                                                              "
    				+"             		                                                                                                                                                                              "
    				+"             		Select 	p.patient_id,min(value_datetime) data_inicio                                                                                                                          "
    				+"             		from 	patient p                                                                                                                                                             "
    				+"             				inner join encounter e on p.patient_id=e.patient_id                                                                                                                   "
    				+"             				inner join obs o on e.encounter_id=o.encounter_id                                                                                                                     "
    				+"             		where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and                                                                                                  "
    				+"             				o.concept_id=23866 and o.value_datetime is not null and                                                                                                               "
    				+"             				o.value_datetime<=:endDate  and e.location_id=:location                                                                                                               "
    				+"             		group by p.patient_id								                                                                                                                          "
    				+"             				                                                                                                                                                                      "
    				+"             		) inicio                                                                                                                                                                      "
    				+"             	group by patient_id	                                                                                                                                                              "
    				+"             ) inicio_real on prox_consulta.patient_id=inicio_real.patient_id                                                                                                                   "
    				+"             left join                                                                                                                                                                          "
    				+"             (                                                                                                                                                                                  "
    				+"             select patient_id,max(data_estado) data_estado                                                                                                                                     "
    				+"             from                                                                                                                                                                               "
    				+"             (                                                                                                                                                                                  "
    				+"                                                                                                                                                                                                "
    				+"             select maxEstado.patient_id,                                                                                                                                                       "
    				+"             maxEstado.data_estado                                                                                                                                                              "
    				+"             from                                                                                                                                                                               "
    				+"             (                                                                                                                                                                                  "
    				+"             select pg.patient_id,max(ps.start_date) data_estado                                                                                                                                "
    				+"             from   patient p                                                                                                                                                                   "
    				+"             inner join patient_program pg on p.patient_id=pg.patient_id                                                                                                                        "
    				+"             inner join patient_state ps on pg.patient_program_id=ps.patient_program_id                                                                                                         "
    				+"             where pg.voided=0 and ps.voided=0 and p.voided=0 and                                                                                                                               "
    				+"             pg.program_id=2 and ps.start_date<=:endDate  and pg.location_id=:location                                                                                                          "
    				+"             group by p.patient_id                                                                                                                                                              "
    				+"             ) maxEstado                                                                                                                                                                        "
    				+"             inner join patient_program pg2 on pg2.patient_id=maxEstado.patient_id                                                                                                              "
    				+"             inner join patient_state ps2 on pg2.patient_program_id=ps2.patient_program_id                                                                                                      "
    				+"             where pg2.voided=0 and ps2.voided=0 and pg2.program_id=2 and                                                                                                                       "
    				+"             ps2.start_date=maxEstado.data_estado and pg2.location_id=:location and ps2.state in (7,8,10)                                                                                       "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"             union                                                                                                                                                                              "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"             select p.patient_id,                                                                                                                                                               "
    				+"             max(o.obs_datetime) data_estado                                                                                                                                                    "
    				+"             from patient p                                                                                                                                                                     "
    				+"             inner join encounter e on p.patient_id=e.patient_id                                                                                                                                "
    				+"             inner join obs  o on e.encounter_id=o.encounter_id                                                                                                                                 "
    				+"             where e.voided=0 and o.voided=0 and p.voided=0 and                                                                                                                                 "
    				+"             e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and                                                                               "
    				+"             o.obs_datetime<=:endDate  and e.location_id=:location                                                                                                                              "
    				+"             group by p.patient_id                                                                                                                                                              "
    				+"                                                                                                                                                                                                "
    				+"             union                                                                                                                                                                              "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                        "
    				+"                                                                                                                                                                                                "
    				+"             select person_id as patient_id,death_date as data_estado                                                                                                                           "
    				+"             from person                                                                                                                                                                        "
    				+"             where dead=1 and death_date is not null and death_date<=:endDate                                                                                                                   "
    				+"                                                                                                                                                                                                "
    				+"             union                                                                                                                                                                              "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                 "
    				+"             select p.patient_id,                                                                                                                                                               "
    				+"             max(obsObito.obs_datetime) data_estado                                                                                                                                             "
    				+"             from patient p                                                                                                                                                                     "
    				+"             inner join encounter e on p.patient_id=e.patient_id                                                                                                                                "
    				+"             inner join obs obsObito on e.encounter_id=obsObito.encounter_id                                                                                                                    "
    				+"             where e.voided=0 and p.voided=0 and obsObito.voided=0 and                                                                                                                          "
    				+"             e.encounter_type in (21,36,37) and  e.encounter_datetime<=:endDate  and  e.location_id=:location and                                                                               "
    				+"             obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366                                                                                                            "
    				+"             group by p.patient_id                                                                                                                                                              "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"             ) allSaida                                                                                                                                                                         "
    				+"             group by patient_id                                                                                                                                                                "
    				+"             ) saida on prox_consulta.patient_id=saida.patient_id where saida.data_estado is null) consulta                                                                                     "
    				+"             inner join person pe on pe.person_id=consulta.patient_id where 	((pe.birthdate is not null and                                                                                    "
    				+"             timestampdiff(year,pe.birthdate,:endDate) <= 14	) or pe.birthdate is  null	) )consulta_menor_14                                                                                  "
    				+"             inner join                                                                                                                                                                         "
    				+"             (                                                                                                                                                                                  "
    				+"             SELECT inicio_pDTG.patient_id                                                                                                                                                      "
    				+"             	from                                                                                                                                                                              "
    				+"             		(                                                                                                                                                                             "
    				+"             			SELECT inicio_6meses.patient_id                                                                                                                                           "
    				+"             					from (                                                                                                                                                            "
    				+"             							select patient_id,data_inicio                                                                                                                             "
    				+"                          from                                                                                                                                                                  "
    				+"                          (	Select patient_id,min(data_inicio) data_inicio                                                                                                                    "
    				+"                          		from                                                                                                                                                          "
    				+"                          			(	                                                                                                                                                      "
    				+"                          			                                                                                                                                                          "
    				+"                          				/*Patients on ART who initiated the ARV DRUGS: ART Regimen Start Date*/                                                                               "
    				+"                          				                                                                                                                                                      "
    				+"                          						Select 	p.patient_id,min(e.encounter_datetime) data_inicio                                                                                    "
    				+"                          						from 	patient p                                                                                                                             "
    				+"                          								inner join encounter e on p.patient_id=e.patient_id	                                                                                  "
    				+"                          								inner join obs o on o.encounter_id=e.encounter_id                                                                                     "
    				+"                          						where 	e.voided=0 and o.voided=0 and p.voided=0 and                                                                                          "
    				+"                          								e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and                                                         "
    				+"                          								e.encounter_datetime<=:endDate  and e.location_id=:location                                                                           "
    				+"                          						group by p.patient_id                                                                                                                         "
    				+"                          				                                                                                                                                                      "
    				+"                          						union                                                                                                                                         "
    				+"                          				                                                                                                                                                      "
    				+"                          						                                                                                                                                              "
    				+"                          						Select 	p.patient_id,min(value_datetime) data_inicio                                                                                          "
    				+"                          						from 	patient p                                                                                                                             "
    				+"                          								inner join encounter e on p.patient_id=e.patient_id                                                                                   "
    				+"                          								inner join obs o on e.encounter_id=o.encounter_id                                                                                     "
    				+"                          						where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and                                                      "
    				+"                          								o.concept_id=1190 and o.value_datetime is not null and                                                                                "
    				+"                          								o.value_datetime<=:endDate  and e.location_id=:location                                                                               "
    				+"                          						group by p.patient_id                                                                                                                         "
    				+"                                                                                                                                                                                                "
    				+"                          						union                                                                                                                                         "
    				+"                                                                                                                                                                                                "
    				+"                          						                                                                                                                                              "
    				+"                          						select 	pg.patient_id,min(date_enrolled) data_inicio                                                                                          "
    				+"                          						from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id                                                                 "
    				+"                          						where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate  and location_id=:location                                    "
    				+"                          						group by pg.patient_id                                                                                                                        "
    				+"                          						                                                                                                                                              "
    				+"                          						union                                                                                                                                         "
    				+"                          						                                                                                                                                              "
    				+"                          						                                                                                                                                              "
    				+"                          						                                                                                                                                              "
    				+"                          						  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio                                                                            "
    				+"                          						  FROM 		patient p                                                                                                                         "
    				+"                          									inner join encounter e on p.patient_id=e.patient_id                                                                               "
    				+"                          						  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0  and e.encounter_datetime<=:endDate  and e.location_id=:location                "
    				+"                          						  GROUP BY 	p.patient_id                                                                                                                      "
    				+"                          					                                                                                                                                                  "
    				+"                          						union                                                                                                                                         "
    				+"                          						                                                                                                                                              "
    				+"                          						                                                                                                                                              "
    				+"                          						Select 	p.patient_id,min(value_datetime) data_inicio                                                                                          "
    				+"                          						from 	patient p                                                                                                                             "
    				+"                          								inner join encounter e on p.patient_id=e.patient_id                                                                                   "
    				+"                          								inner join obs o on e.encounter_id=o.encounter_id                                                                                     "
    				+"                          						where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and                                                                  "
    				+"                          								o.concept_id=23866 and o.value_datetime is not null and                                                                               "
    				+"                          								o.value_datetime<=:endDate  and e.location_id=:location                                                                               "
    				+"                          						group by p.patient_id		                                                                                                                  "
    				+"                          					                                                                                                                                                  "
    				+"                          				                                                                                                                                                      "
    				+"                          				                                                                                                                                                      "
    				+"                          			) inicio                                                                                                                                                  "
    				+"                          		group by patient_id	                                                                                                                                          "
    				+"                          	)inicio1                                                                                                                                                          "
    				+"                          where data_inicio between date_add(date_add(:endDate, interval -6 MONTH), interval 1 day) and :endDate) inicio_6meses                                                 "
    				+"                                                                                                                                                                                                "
    				+"                          inner join                                                                                                                                                            "
    				+"                                                                                                                                                                                                "
    				+"             	(-- pDTG Remgime                                                                                                                                                                  "
    				+"                          SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inici                                                                                                         "
    				+"                          						  FROM 		patient p                                                                                                                         "
    				+"                          									inner join encounter e on p.patient_id=e.patient_id                                                                               "
    				+"                                                             inner join obs o on o.encounter_id = e.encounter_id                                                                                "
    				+"                          						  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0  and  o.concept_id=165256 AND                                                   "
    				+"                                                   o.value_drug in (51,52) and o.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location                                        "
    				+"                          						  GROUP BY 	p.patient_id) pDTG on inicio_6meses.patient_id = pDTG.patient_id                                                                  "
    				+"                                                                                                                                                                                                "
    				+"             	inner join person pe on pe.person_id=inicio_6meses.patient_id                                                                                                                     "
    				+"                                                                                                                                                                                                "
    				+"             	where ((pe.birthdate is not null and timestampdiff(year,pe.birthdate,:endDate) <= 8	) or pe.birthdate is  null	)                                                                 "
    				+"                 )inicio_pDTG                                                                                                                                                                   "
    				+"                 union                                                                                                                                                                          "
    				+"                                                                                                                                                                                                "
    				+"                 	select ultima_carga.patient_id                                                                                                                                                "
    				+"             	 from 		                                                                                                                                                                      "
    				+"             		(                                                                                                                                                                             "
    				+"             			Select p.patient_id,max(o.obs_datetime) data_carga                                                                                                                        "
    				+"             			from 	patient p                                                                                                                                                         "
    				+"             					inner join encounter e on p.patient_id=e.patient_id                                                                                                               "
    				+"             					inner join obs o on e.encounter_id=o.encounter_id                                                                                                                 "
    				+"             			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,53,9,13,51) and  o.concept_id = 856 and o.value_numeric>1000 and                              "
    				+"             					o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and e.location_id=:location                                  "
    				+"             			group by p.patient_id                                                                                                                                                     "
    				+"             		) ultima_carga                                                                                                                                                                "
    				+"             	union                                                                                                                                                                             "
    				+"             	                                                                                                                                                                                  "
    				+"               select consulta.patient_id from                                                                                                                                                  "
    				+"             (                                                                                                                                                                                  "
    				+"             			Select 	p.patient_id,max(value_datetime)                                                                                                                                  "
    				+"                          						from 	patient p                                                                                                                             "
    				+"                          								inner join encounter e on p.patient_id=e.patient_id                                                                                   "
    				+"                          								inner join obs o on e.encounter_id=o.encounter_id                                                                                     "
    				+"                          						where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9)                                                                "
    				+"                                                 and o.value_datetime BETWEEN :startDate AND :endDate                                                                                           "
    				+"                          								 and e.location_id=:location                                                                                                          "
    				+"                          						group by p.patient_id ) consulta                                                                                                              "
    				+"                                                 inner join person pe on pe.person_id=consulta.patient_id											                                              "
    				+"                         where 	((pe.birthdate is not null and timestampdiff(year,pe.birthdate,:endDate) <= 2	) or pe.birthdate is  null	)                                                 "
    				+"             ) cv on cv.patient_id = consulta_menor_14.patient_id )coorteprox_consulta                                                                                                          "
    				+"              left join                                                                                                                                                                         "
    				+"             	(	select pid1.*                                                                                                                                                                 "
    				+"             		from patient_identifier pid1                                                                                                                                                  "
    				+"             		inner join                                                                                                                                                                    "
    				+"             			(                                                                                                                                                                         "
    				+"             				select patient_id,min(patient_identifier_id) id                                                                                                                       "
    				+"             				from patient_identifier                                                                                                                                               "
    				+"             				where voided=0                                                                                                                                                        "
    				+"             				group by patient_id                                                                                                                                                   "
    				+"             			) pid2                                                                                                                                                                    "
    				+"             		where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id                                                                                                  "
    				+"             	) pid on pid.patient_id=coorteprox_consulta.patient_id                                                                                                                            "
    				+"             	left join                                                                                                                                                                         "
    				+"             	(	select pn1.*                                                                                                                                                                  "
    				+"             		from person_name pn1                                                                                                                                                          "
    				+"             		inner join                                                                                                                                                                    "
    				+"             			(                                                                                                                                                                         "
    				+"             				select person_id,min(person_name_id) id                                                                                                                               "
    				+"             				from person_name                                                                                                                                                      "
    				+"             				where voided=0                                                                                                                                                        "
    				+"             				group by person_id                                                                                                                                                    "
    				+"             			) pn2                                                                                                                                                                     "
    				+"             		where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id                                                                                                               "
    				+"             	) pn on pn.person_id=coorteprox_consulta.patient_id                                                                                                                               "
    				+"                 left join                                                                                                                                                                      "
    				+"                 (Select 	p.patient_id,max(o.obs_datetime), o.value_numeric  peso                                                                                                               "
    				+"                          						from 	patient p                                                                                                                             "
    				+"                          								inner join encounter e on p.patient_id=e.patient_id                                                                                   "
    				+"                          								inner join obs o on e.encounter_id=o.encounter_id                                                                                     "
    				+"                          						where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9,53,51)                                                          "
    				+"                                                 and o.concept_id=5089                                                                                                                          "
    				+"                                                 and o.obs_datetime <= :endDate                                                                                                                 "
    				+"                          								 and e.location_id=:location                                                                                                          "
    				+"                          						group by p.patient_id ) peso on peso.patient_id=coorteprox_consulta.patient_id                                                                "
    				+"             		LEFT JOIN (                                                                                                                                                                   "
    				+"                          		Select 	p.patient_id,max(o.value_datetime) consulta_data_agendada                                                                                             "
    				+"                          						from 	patient p                                                                                                                             "
    				+"                          								inner join encounter e on p.patient_id=e.patient_id                                                                                   "
    				+"                          								inner join obs o on e.encounter_id=o.encounter_id                                                                                     "
    				+"                          						where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9)                                                                "
    				+"                                                 and o.concept_id=1410                                                                                                                          "
    				+"                                                 and o.value_datetime BETWEEN :startDate AND :endDate                                                                                           "
    				+"                          								 and e.location_id=:location                                                                                                          "
    				+"                          						group by p.patient_id                                                                                                                         "
    				+"                          	)consulta ON coorteprox_consulta.patient_id = consulta.patient_id                                                                                                 "
    				+"                          LEFT JOIN (                                                                                                                                                           "
    				+"                          	Select p.patient_id,max(o.value_datetime) levantamento_data_agendada                                                                                              "
    				+"             						from patient p                                                                                                                                                "
    				+"             						inner join encounter e on e.patient_id=p.patient_id                                                                                                           "
    				+"             						inner join obs o on e.encounter_id=o.encounter_id                                                                                                             "
    				+"             						where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=18 and  o.concept_id = 5096 and                                                           "
    				+"             						e.location_id=:location and e.encounter_datetime <= :endDate                                                                                                  "
    				+"             						group by p.patient_id                                                                                                                                         "
    				+"             			                                                                                                                                                                          "
    				+"                          	)levantamento ON levantamento.patient_id = coorteprox_consulta.patient_id                                                                                         "
    				+"                 		LEFT JOIN (                                                                                                                                                               "
    				+"                          		Select p.patient_id,max(encounter_datetime) data_seguimento                                                                                                   "
    				+"             						from patient p                                                                                                                                                "
    				+"             						inner join encounter e on e.patient_id=p.patient_id                                                                                                           "
    				+"             						where p.voided=0 and e.voided=0 and e.encounter_type in (6,9) and                                                                                             "
    				+"             						e.location_id=:location and e.encounter_datetime<=:endDate                                                                                                    "
    				+"             						group by p.patient_id                                                                                                                                         "
    				+"                                                                                                                                                                                                "
    				+"                          	)ultima_consulta ON coorteprox_consulta.patient_id = ultima_consulta.patient_id                                                                                   "
    				+"             					and ultima_consulta.data_seguimento<=consulta.consulta_data_agendada                                                                                              "
    				+"             		left join(                                                                                                                                                                    "
    				+"             				 Select p.patient_id,max(encounter_datetime) data_fila                                                                                                                "
    				+"             				from patient p                                                                                                                                                        "
    				+"             				inner join encounter e on e.patient_id=p.patient_id                                                                                                                   "
    				+"             				where p.voided=0 and e.voided=0 and e.encounter_type=18 and                                                                                                           "
    				+"             				e.location_id=:location and e.encounter_datetime<=:endDate                                                                                                            "
    				+"             				group by p.patient_id                                                                                                                                                 "
    				+"             				 union                                                                                                                                                                "
    				+"             				Select p.patient_id,max(value_datetime) data_fila                                                                                                                     "
    				+"             				from patient p                                                                                                                                                        "
    				+"             				inner join encounter e on p.patient_id=e.patient_id                                                                                                                   "
    				+"             				inner join obs o on e.encounter_id=o.encounter_id                                                                                                                     "
    				+"             				where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and                                                                                            "
    				+"             				o.concept_id=23866 and o.value_datetime is not null and                                                                                                               "
    				+"             				o.value_datetime<=:endDate and e.location_id=:location                                                                                                                "
    				+"             				group by p.patient_id                                                                                                                                                 "
    				+"             			)utlimo_levantamento on coorteprox_consulta.patient_id = utlimo_levantamento.patient_id                                                                                   "
    				+"             				and utlimo_levantamento.data_fila<=levantamento.levantamento_data_agendada                                                                                            "
    				+"             			left join                                                                                                                                                                 "
    				+"             (                                                                                                                                                                                  "
    				+"             select ultimo_lev.patient_id,                                                                                                                                                      "
    				+"             ultimo_lev.encounter_datetime as max_date,                                                                                                                                         "
    				+"             case o.value_coded                                                                                                                                                                 "
    				+"             when 1703 then 'AZT+3TC+EFV'                                                                                                                                                       "
    				+"             when 6100 then 'AZT+3TC+LPV/r'                                                                                                                                                     "
    				+"             when 1651 then 'AZT+3TC+NVP'                                                                                                                                                       "
    				+"             when 6324 then 'TDF+3TC+EFV'                                                                                                                                                       "
    				+"             when 6104 then 'ABC+3TC+EFV'                                                                                                                                                       "
    				+"             when 23784 then 'TDF+3TC+DTG'                                                                                                                                                      "
    				+"             when 23785 then 'TDF+3TC+DTG'                                                                                                                                                      "
    				+"             when 23786 then 'ABC+3TC+DTG'                                                                                                                                                      "
    				+"             when 6116 then 'AZT+3TC+ABC'                                                                                                                                                       "
    				+"             when 6106 then 'ABC+3TC+LPV/r'                                                                                                                                                     "
    				+"             when 6105 then 'ABC+3TC+NVP'                                                                                                                                                       "
    				+"             when 6108 then 'TDF+3TC+LPV/r'                                                                                                                                                     "
    				+"             when 23790 then 'TDF+3TC+LPV/r+RTV'                                                                                                                                                "
    				+"             when 23791 then 'TDF+3TC+ATV/r'                                                                                                                                                    "
    				+"             when 23792 then 'ABC+3TC+ATV/r'                                                                                                                                                    "
    				+"             when 23793 then 'AZT+3TC+ATV/r'                                                                                                                                                    "
    				+"             when 23795 then 'ABC+3TC+ATV/r+RAL'                                                                                                                                                "
    				+"             when 23796 then 'TDF+3TC+ATV/r+RAL'                                                                                                                                                "
    				+"             when 23801 then 'AZT+3TC+RAL'                                                                                                                                                      "
    				+"             when 23802 then 'AZT+3TC+DRV/r'                                                                                                                                                    "
    				+"             when 23815 then 'AZT+3TC+DTG'                                                                                                                                                      "
    				+"             when 6329 then 'TDF+3TC+RAL+DRV/r'                                                                                                                                                 "
    				+"             when 23797 then 'ABC+3TC+DRV/r+RAL'                                                                                                                                                "
    				+"             when 23798 then '3TC+RAL+DRV/r'                                                                                                                                                    "
    				+"             when 23803 then 'AZT+3TC+RAL+DRV/r'                                                                                                                                                "
    				+"             when 6243 then 'TDF+3TC+NVP'                                                                                                                                                       "
    				+"             when 6103 then 'D4T+3TC+LPV/r'                                                                                                                                                     "
    				+"             when 792 then 'D4T+3TC+NVP'                                                                                                                                                        "
    				+"             when 1827 then 'D4T+3TC+EFV'                                                                                                                                                       "
    				+"             when 6102 then 'D4T+3TC+ABC'                                                                                                                                                       "
    				+"             when 1311 then 'ABC+3TC+LPV/r'                                                                                                                                                     "
    				+"             when 1312 then 'ABC+3TC+NVP'                                                                                                                                                       "
    				+"             when 1313 then 'ABC+3TC+EFV'                                                                                                                                                       "
    				+"             when 1314 then 'AZT+3TC+LPV/r'                                                                                                                                                     "
    				+"             when 1315 then 'TDF+3TC+EFV'                                                                                                                                                       "
    				+"             when 6330 then 'AZT+3TC+RAL+DRV/r'                                                                                                                                                 "
    				+"             when 6325 then 'D4T+3TC+ABC+LPV/r'                                                                                                                                                 "
    				+"             when 6326 then 'AZT+3TC+ABC+LPV/r'                                                                                                                                                 "
    				+"             when 6327 then 'D4T+3TC+ABC+EFV'                                                                                                                                                   "
    				+"             when 6328 then 'AZT+3TC+ABC+EFV'                                                                                                                                                   "
    				+"             when 6109 then 'AZT+DDI+LPV/r'                                                                                                                                                     "
    				+"             when 21163 then 'AZT+3TC+LPV/r'                                                                                                                                                    "
    				+"             when 23799 then 'TDF+3TC+DTG'                                                                                                                                                      "
    				+"             when 23800 then 'ABC+3TC+DTG'                                                                                                                                                      "
    				+"             when 6110 then 'D4T20+3TC+NVP'                                                                                                                                                     "
    				+"             when 1702 then 'AZT+3TC+NFV'                                                                                                                                                       "
    				+"             when 817  then 'AZT+3TC+ABC'                                                                                                                                                       "
    				+"             when 6244 then 'AZT+3TC+RTV'                                                                                                                                                       "
    				+"             when 1700 then 'AZT+DDl+NFV'                                                                                                                                                       "
    				+"             when 633  then 'EFV'                                                                                                                                                               "
    				+"             when 625  then 'D4T'                                                                                                                                                               "
    				+"             when 631  then 'NVP'                                                                                                                                                               "
    				+"             when 628  then '3TC'                                                                                                                                                               "
    				+"             when 635  then 'NFV'                                                                                                                                                               "
    				+"             when 797  then 'AZT'                                                                                                                                                               "
    				+"             when 814  then 'ABC'                                                                                                                                                               "
    				+"             when 6107 then 'TDF+AZT+3TC+LPV/r'                                                                                                                                                 "
    				+"             when 6236 then 'D4T+DDI+RTV-IP'                                                                                                                                                    "
    				+"             when 1701 then 'ABC+DDI+NFV'                                                                                                                                                       "
    				+"             when 6114 then '3DFC'                                                                                                                                                              "
    				+"             when 6115 then '2DFC+EFV'                                                                                                                                                          "
    				+"             when 6233 then 'AZT+3TC+DDI+LPV'                                                                                                                                                   "
    				+"             when 6234 then 'ABC+TDF+LPV'                                                                                                                                                       "
    				+"             when 6242 then 'D4T+DDI+NVP'                                                                                                                                                       "
    				+"             when 6118 then 'DDI50+ABC+LPV'                                                                                                                                                     "
    				+"             else 'OUTRO' end as ultimo_regime,                                                                                                                                                 "
    				+"             ultimo_lev.encounter_datetime data_regime                                                                                                                                          "
    				+"             from obs o,                                                                                                                                                                        "
    				+"             ( select p.patient_id,max(encounter_datetime) as encounter_datetime                                                                                                                "
    				+"             from patient p                                                                                                                                                                     "
    				+"             inner join encounter e on p.patient_id=e.patient_id                                                                                                                                "
    				+"             where encounter_type=18 and e.voided=0 and                                                                                                                                         "
    				+"             encounter_datetime <=:endDate and e.location_id=:location and p.voided=0                                                                                                           "
    				+"             group by patient_id                                                                                                                                                                "
    				+"             ) ultimo_lev                                                                                                                                                                       "
    				+"             where o.person_id=ultimo_lev.patient_id and o.obs_datetime=ultimo_lev.encounter_datetime and o.voided=0 and                                                                        "
    				+"             o.concept_id=1088 and o.location_id=:location                                                                                                                                      "
    				+"             ) regimeFila on regimeFila.patient_id=coorteprox_consulta.patient_id                                                                                                               "
    				+"             left join                                                                                                                                                                          "
    				+"                 (SELECT 	e.patient_id, MAX(e.encounter_datetime) AS max_date, d.name as medicamento                                                                                            "
    				+"                          						  FROM 		patient p                                                                                                                         "
    				+"                          									inner join encounter e on p.patient_id=e.patient_id                                                                               "
    				+"                                                             inner join obs o on o.encounter_id = e.encounter_id                                                                                "
    				+"                                                             inner join drug d on d.drug_id = o.value_drug                                                                                      "
    				+"                          						  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0  and  o.concept_id=165256 AND                                                   "
    				+"                                                   o.value_drug in (51,52) and o.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location                                        "
    				+"                          						  GROUP BY 	p.patient_id) med on  med.patient_id=coorteprox_consulta.patient_id and                                                           "
    				+"             														med.max_date=regimeFila.max_date                                                                                              "
    				+"                                                                                                                                                                                                "
    				+"             			                                                                                                                                                                          "
    				+"             left join                                                                                                                                                                          "
    				+"             									( select sector_inicial.patient_id,                                                                                                               "
    				+"             									case o.value_coded                                                                                                                                "
    				+"             									when 1414 then 'TB'                                                                                                                               "
    				+"             									when 1987 then 'SAAJ'                                                                                                                             "
    				+"             									when 1985 then 'CPN/G'                                                                                                                            "
    				+"             									when 1872 then 'CCR/L'                                                                                                                            "
    				+"             									when 21275 then 'Clinica'                                                                                                                         "
    				+"             									else '' end as sector                                                                                                                             "
    				+"             									from obs o,                                                                                                                                       "
    				+"             						( select p.patient_id,max(encounter_datetime) as encounter_datetime                                                                                           "
    				+"             						from patient p                                                                                                                                                "
    				+"             						inner join encounter e on p.patient_id=e.patient_id                                                                                                           "
    				+"             						where encounter_type=53 and e.voided=0 and                                                                                                                    "
    				+"             						encounter_datetime <=:endDate and e.location_id=:location and p.voided=0                                                                                      "
    				+"             												group by patient_id                                                                                                                   "
    				+"             						) sector_inicial                                                                                                                                              "
    				+"             						where o.person_id=sector_inicial.patient_id and o.obs_datetime=sector_inicial.encounter_datetime and o.voided=0 and                                           "
    				+"             						o.concept_id=23783 and o.location_id=:location group by patient_id                                                                                            "
    				+"             						) sector on sector.patient_id=coorteprox_consulta.patient_id                                                                                                  "
    				+"                                                                                                                                                                                                "
    				+"                                     left join                                                                                                                                                  "
    				+"             (                                                                                                                                                                                  "
    				+"             Select p.patient_id,max(o.obs_datetime) data_carga                                                                                                                                 "
    				+"             from patient p                                                                                                                                                                     "
    				+"                          inner join encounter e on p.patient_id=e.patient_id                                                                                                                   "
    				+"                          inner join obs o on e.encounter_id=o.encounter_id                                                                                                                     "
    				+"                     where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9,53,13,51) and                                                                                  "
    				+"             o.concept_id in (856,1305) and  o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and                                           "
    				+"             e.location_id=:location                                                                                                                                                            "
    				+"             group by p.patient_id                                                                                                                                                              "
    				+"                                                                                                                                                                                                "
    				+"             ) carga_viral on carga_viral.patient_id=coorteprox_consulta.patient_id                                                                                                             "
    				+"             left join                                                                                                                                                                          "
    				+"             (                                                                                                                                                                                  "
    				+"             select 	                                                                                                                                                                          "
    				+"             		carga_viral.patient_id,                                                                                                                                                       "
    				+"             		carga_viral.Valor_carga,                                                                                                                                                      "
    				+"                     carga_viral.data_carga                                                                                                                                                     "
    				+"                                                                                                                                                                                                "
    				+"             		                                                                                                                                                                              "
    				+"                                                                                                                                                                                                "
    				+"             from 	                                                                                                                                                                          "
    				+"             (                                                                                                                                                                                  "
    				+"             	 select ultima_carga.patient_id,ultima_carga.data_carga,                                                                                                                          "
    				+"                  if(obs.value_numeric is null or obs.value_numeric<0,'Indetectavel',obs.value_numeric)  Valor_carga,                                                                           "
    				+"             			ultima_carga.encounter_type,                                                                                                                                              "
    				+"             			obs.creator,                                                                                                                                                              "
    				+"             			obs.date_created data_registo                                                                                                                                             "
    				+"             	 from 		                                                                                                                                                                      "
    				+"             		(                                                                                                                                                                             "
    				+"             			Select p.patient_id,max(o.obs_datetime) data_carga, e.encounter_type                                                                                                      "
    				+"             			from 	patient p                                                                                                                                                         "
    				+"             					inner join encounter e on p.patient_id=e.patient_id                                                                                                               "
    				+"             					inner join obs o on e.encounter_id=o.encounter_id                                                                                                                 "
    				+"             			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,51,6,9) and  o.concept_id in (856,1305) and                                                  "
    				+"             					o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and e.location_id=:location                                  "
    				+"             			group by p.patient_id                                                                                                                                                     "
    				+"             		) ultima_carga                                                                                                                                                                "
    				+"             			inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga                                                                      "
    				+"             		where obs.voided=0 and ((obs.concept_id=856) or obs.concept_id=1305)  and obs.location_id=:location                                                                           "
    				+"             ) carga_viral                                                                                                                                                                      "
    				+"             inner join encounter_type et on et.encounter_type_id=carga_viral.encounter_type                                                                                                    "
    				+"             group by carga_viral.patient_id) ultima_cv on ultima_cv.patient_id=coorteprox_consulta.patient_id and ultima_cv.data_carga =carga_viral.data_carga                                 "
    				+"                                                                                                                                                                                                "
    				+"                 	LEFT JOIN (		                                                                                                                                                              "
    				+"                          		select os.person_id patient_id, os.mds_gaac                                                                                                                   "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'GA', NULL ) mds_gaac,                                                                            "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=23724 and os.voided=0 and os.obs_datetime <= :endDate                                                               "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)                                                           "
    				+"                          	)gaac_model ON gaac_model.patient_id =coorteprox_consulta.patient_id                                                                                              "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                           LEFT JOIN (		                                                                                                                                                  "
    				+"                          		select os.person_id patient_id, os.mds_eh                                                                                                                     "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'EH', NULL ) mds_eh,                                                                              "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=165316 and os.voided=0 and os.obs_datetime <= :endDate                                                              "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)                                                           "
    				+"                          	)eh_model ON eh_model.patient_id =coorteprox_consulta.patient_id                                                                                                  "
    				+"                                                                                                                                                                                                "
    				+"                           	LEFT JOIN (		                                                                                                                                                  "
    				+"                          		select os.person_id patient_id, os.mds_cm                                                                                                                     "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'CM', NULL ) mds_cm,                                                                              "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=165265 and os.voided=0 and os.obs_datetime <= :endDate                                                              "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)                                                           "
    				+"                          	)cm_model ON cm_model.patient_id =coorteprox_consulta.patient_id                                                                                                  "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                             LEFT JOIN (		                                                                                                                                                  "
    				+"                          		select os.person_id patient_id, os.mds_dd                                                                                                                     "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DD', NULL ) mds_dd,                                                                              "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=165315 and os.voided=0 and os.obs_datetime <= :endDate                                                              "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)                                                           "
    				+"                          	)dd_model ON dd_model.patient_id =coorteprox_consulta.patient_id                                                                                                  "
    				+"                                                                                                                                                                                                "
    				+"                              LEFT JOIN (		                                                                                                                                                  "
    				+"                          		select os.person_id patient_id, os.mds_dcp                                                                                                                    "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DCP', NULL ) mds_dcp,                                                                            "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=165178 and os.voided=0 and os.obs_datetime <= :endDate                                                              "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)                                                           "
    				+"                          	)dcp_model ON dcp_model.patient_id =coorteprox_consulta.patient_id                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                              LEFT JOIN (		                                                                                                                                                  "
    				+"                          		select os.person_id patient_id, os.mds_dca                                                                                                                    "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DCA', NULL ) mds_dca,                                                                            "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=165179 and os.voided=0 and os.obs_datetime <= :endDate                                                              "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)                                                           "
    				+"                          	)dca_model ON dca_model.patient_id =coorteprox_consulta.patient_id                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                              LEFT JOIN (		                                                                                                                                                  "
    				+"                          		select os.person_id patient_id, os.mds_bm                                                                                                                     "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'BM', NULL ) mds_bm,                                                                              "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=165264 and os.voided=0 and os.obs_datetime <= :endDate                                                              "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)                                                           "
    				+"                          	)bm_model ON bm_model.patient_id =coorteprox_consulta.patient_id                                                                                                  "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"             				LEFT JOIN (		                                                                                                                                                      "
    				+"                          		select os.person_id patient_id, os.mds_smi                                                                                                                    "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'SMI', NULL ) mds_smi,                                                                            "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=165320 and os.voided=0 and os.obs_datetime <= :endDate                                                              "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)                                                           "
    				+"                          	)smi_model ON smi_model.patient_id =coorteprox_consulta.patient_id                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                             LEFT JOIN (		                                                                                                                                                  "
    				+"                          		select os.person_id patient_id, os.mds_saaj                                                                                                                   "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'SAAJ', NULL ) mds_saaj,                                                                          "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=165319 and os.voided=0 and os.obs_datetime <= :endDate                                                              "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)                                                           "
    				+"                          	)saaj_model ON saaj_model.patient_id =coorteprox_consulta.patient_id                                                                                              "
    				+"                                                                                                                                                                                                "
    				+"                          	LEFT JOIN (		                                                                                                                                                  "
    				+"                          		select os.person_id patient_id, os.mds_af                                                                                                                     "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'AF', NULL ) mds_af,                                                                              "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=23725 and os.voided=0 and os.obs_datetime <= :endDate                                                               "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)                                                           "
    				+"                          	)af_model ON af_model.patient_id =coorteprox_consulta.patient_id                                                                                                  "
    				+"                                                                                                                                                                                                "
    				+"                          	LEFT JOIN (		                                                                                                                                                  "
    				+"                          		select os.person_id patient_id, os.mds_ca                                                                                                                     "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'CA', NULL ) mds_ca,                                                                              "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=23726 and os.voided=0 and os.obs_datetime <= :endDate                                                               "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)                                                           "
    				+"                          	)ca_model ON ca_model.patient_id =coorteprox_consulta.patient_id                                                                                                  "
    				+"                                                                                                                                                                                                "
    				+"                          	LEFT JOIN (		                                                                                                                                                  "
    				+"                          		select os.person_id patient_id, os.mds_pu                                                                                                                     "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'CT', NULL ) mds_pu,                                                                              "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=165318 and os.voided=0 and os.obs_datetime <= :endDate                                                              "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)                                                           "
    				+"                                      )pu_model ON pu_model.patient_id =coorteprox_consulta.patient_id                                                                                          "
    				+"                                                                                                                                                                                                "
    				+"                                      LEFT JOIN (		                                                                                                                                          "
    				+"                          		select os.person_id patient_id, os.mds_tb                                                                                                                     "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'TB', NULL ) mds_tb,                                                                              "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=165317 and os.voided=0 and os.obs_datetime <= :endDate                                                              "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)                                                           "
    				+"                                      )tb_model ON tb_model.patient_id =coorteprox_consulta.patient_id                                                                                          "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                          	LEFT JOIN (		                                                                                                                                                  "
    				+"                          		select os.person_id patient_id, os.mds_fr                                                                                                                     "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'FR', NULL ) mds_fr,                                                                              "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=23729 and os.voided=0 and os.obs_datetime <= :endDate                                                               "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime )                                                          "
    				+"                          	)fr_model ON fr_model.patient_id =coorteprox_consulta.patient_id                                                                                                  "
    				+"                                                                                                                                                                                                "
    				+"                          	LEFT JOIN (		                                                                                                                                                  "
    				+"                          		select os.person_id patient_id, os.mds_dt                                                                                                                     "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DT', NULL ) mds_dt,                                                                              "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=23730 and os.voided=0 and os.obs_datetime <= :endDate                                                               "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime )                                                          "
    				+"                          	)dt_model ON dt_model.patient_id =coorteprox_consulta.patient_id                                                                                                  "
    				+"                                                                                                                                                                                                "
    				+"                          	LEFT JOIN (		                                                                                                                                                  "
    				+"                          		SELECT o.person_id patient_id, IF(MAX(o.obs_datetime) IS NOT NULL, 'DC', NULL ) mds_dc FROM obs o                                                             "
    				+"                          			INNER JOIN encounter e ON o.encounter_id = e.encounter_id                                                                                                 "
    				+"                          				WHERE o.voided = 0 AND e.voided = 0 AND concept_id = 23731                                                                                            "
    				+"                          				AND value_coded IN (1256, 1257) AND o.obs_datetime <= :endDate  AND e.location_id = :location                                                         "
    				+"                          					GROUP BY o.person_id                                                                                                                              "
    				+"                          	)dc_model ON dc_model.patient_id =coorteprox_consulta.patient_id                                                                                                  "
    				+"                                                                                                                                                                                                "
    				+"                          	LEFT JOIN (	                                                                                                                                                      "
    				+"                             select os.person_id patient_id, os.mds_ds                                                                                                                          "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DS', NULL ) mds_ds,                                                                              "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=23888 and os.voided=0 and os.obs_datetime <= :endDate                                                               "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and  o.obs_datetime <= :endDate and o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime )                                                          "
    				+"             										)ds_model ON ds_model.patient_id =coorteprox_consulta.patient_id                                                                              "
    				+"                                                                                                                                                                                                "
    				+"             			LEFT JOIN (	                                                                                                                                                              "
    				+"                             select os.person_id patient_id, os.mds_dah                                                                                                                         "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DAH', NULL ) mds_dah,                                                                            "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=165321 and os.voided=0 and os.obs_datetime <= :endDate                                                              "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and  o.obs_datetime <= :endDate and o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime )                                                          "
    				+"             										)dah_model ON dah_model.patient_id =coorteprox_consulta.patient_id                                                                            "
    				+"                                                                                                                                                                                                "
    				+"             			LEFT JOIN (	                                                                                                                                                              "
    				+"                             select os.person_id patient_id, os.mds_da                                                                                                                          "
    				+"             						from                                                                                                                                                          "
    				+"             						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DA', NULL ) mds_da,                                                                              "
    				+"             						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where                                             "
    				+"             						os.concept_id = 165174 and os.value_coded=165314 and os.voided=0 and os.obs_datetime <= :endDate                                                              "
    				+"             						 GROUP BY os.person_id) os                                                                                                                                    "
    				+"             						                                                                                                                                                              "
    				+"             						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)                                                                 "
    				+"             						 and o.voided =0 and o.obs_group_id is not null and  o.obs_datetime <= :endDate and o.encounter_id = os.encounter_id                                          "
    				+"             						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime )                                                          "
    				+"             										)da_model ON da_model.patient_id =coorteprox_consulta.patient_id                                                                              "
    				+"                       left join                                                                                                                                                                "
    				+"             ( select pad1.*                                                                                                                                                                    "
    				+"             from person_address pad1                                                                                                                                                           "
    				+"             inner join                                                                                                                                                                         "
    				+"             (                                                                                                                                                                                  "
    				+"             select person_id,min(person_address_id) id                                                                                                                                         "
    				+"             from person_address                                                                                                                                                                "
    				+"             where voided=0                                                                                                                                                                     "
    				+"             group by person_id                                                                                                                                                                 "
    				+"             ) pad2                                                                                                                                                                             "
    				+"             where pad1.person_id=pad2.person_id and pad1.person_address_id=pad2.id                                                                                                             "
    				+"             ) pad3 on pad3.person_id=coorteprox_consulta.patient_id                                                                                                                            "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"                                                                                                                                                                                                "
    				+"             left join                                                                                                                                                                          "
    				+"             	(	SELECT pa.person_id patient_id, pa.value patient_contact FROM person_attribute pa                                                                                             "
    				+"                                  WHERE pa.person_attribute_type_id = 9                                                                                                                         "
    				+"                                GROUP BY pa.person_id                                                                                                                                           "
    				+"                        	)patient_contact ON patient_contact.patient_id = coorteprox_consulta.patient_id                                                                                       "
    				+"                                                                                                                                                                                                "
    				+"             left join                                                                                                                                                                          "
    				+"             	(	SELECT pa.person_id patient_id, pa.value patient_contact FROM person_attribute pa                                                                                             "
    				+"                                  WHERE pa.person_attribute_type_id = 30                                                                                                                        "
    				+"                                GROUP BY pa.person_id                                                                                                                                           "
    				+"                        	)patient_contact2 ON patient_contact2.patient_id = coorteprox_consulta.patient_id                                                                                     "
    				+"                                                                                                                                                                                                "
    				+"                 group by coorteprox_consulta.patient_id                                                                                                                                        ";
  }
}
