/** */
package org.openmrs.module.eptsreports.reporting.library.queries.listings;

/** @author Abdul Sacur */
public interface ExpectedChildrenQueries {

  class QUERY {

    public static String findExpectedPatientsList() {

      String query =
          "select coorteprox_consulta.patient_id,\n"
              + "		pid.identifier as NID ,\n"
              + "		concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ') nome,\n"
              + "        concat(ifnull(pn.family_name,'')) apelido,\n"
              + "		coorteprox_consulta.data_inicio,\n"
              + "		coorteprox_consulta.gender as sexo,\n"
              + "        coorteprox_consulta.idade_actual,\n"
              + "        peso.peso,\n"
              + "        consulta.consulta_data_agendada,\n"
              + "        levantamento.levantamento_data_agendada,\n"
              + "        ultima_consulta.data_seguimento ultm_cons_data,\n"
              + "        utlimo_levantamento.data_fila ultm_levnt_data,\n"
              + "        regimeFila.ultimo_regime,\n"
              + "        med.medicamento,\n"
              + "        IF(sector.sector is not null,sector.sector,'') sector,\n"
              + "        carga_viral.data_carga,\n"
              + "        ultima_cv.Valor_carga,\n"
              + "        gaac_model.mds_gaac, af_model.mds_af, ca_model.mds_ca, pu_model.mds_pu, fr_model.mds_fr, \n"
              + "        dt_model.mds_dt, dc_model.mds_dc, ds_model.mds_ds, tb_model.mds_tb, saaj_model.mds_saaj,smi_model.mds_smi,\n"
              + "        dd_model.mds_dd, dcp_model.mds_dcp, dca_model.mds_dca,bm_model.mds_bm,cm_model.mds_cm,eh_model.mds_eh,\n"
              + "        dah_model.mds_dah, da_model.mds_da,\n"
              + "         IF(patient_contact.patient_contact  is not null, patient_contact.patient_contact,\n"
              + "        IF(patient_contact2.patient_contact  is not null, patient_contact2.patient_contact, '')) contacto,\n"
              + "        concat(ifnull(concat('  ',pad3.address5), '  '),ifnull(concat('  ',pad3.address1), '  '),ifnull(concat(', ',pad3.address3), '  ')) endereco\n"
              + "        \n"
              + "\n"
              + "        from\n"
              + "		(select consulta_menor_14.patient_id,\n"
              + "				consulta_menor_14.gender,\n"
              + "                consulta_menor_14.idade_actual,\n"
              + "                consulta_menor_14.data_inicio,\n"
              + "                consulta_menor_14.age\n"
              + "                from \n"
              + "					(select consulta.patient_id,\n"
              + "							pe.gender,\n"
              + "                            FLOOR(datediff(:endDate,pe.birthdate)/365) idade_actual,\n"
              + "                            consulta.data_inicio,\n"
              + "                            (YEAR( :endDate ) - YEAR(pe.birthdate)) age\n"
              + "							from \n"
              + "						(select prox_consulta.patient_id,\n"
              + "								inicio_real.data_inicio\n"
              + "							from\n"
              + "(\n"
              + "Select 	p.patient_id,max(value_datetime)\n"
              + "             						from 	patient p\n"
              + "             								inner join encounter e on p.patient_id=e.patient_id\n"
              + "             								inner join obs o on e.encounter_id=o.encounter_id\n"
              + "             						where 	 o.concept_id = 1410 and p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9) \n"
              + "                                    and o.value_datetime BETWEEN :startDate AND :endDate \n"
              + "             								 and e.location_id=:location\n"
              + "             						group by p.patient_id ) prox_consulta\n"
              + "						\n"
              + "                                    inner join \n"
              + "(	Select patient_id,min(data_inicio) data_inicio\n"
              + "	from\n"
              + "		(	\n"
              + "		-- Patients on ART who initiated the ARV DRUGS: ART Regimen Start Date/\n"
              + "\n"
              + "		Select 	p.patient_id,min(e.encounter_datetime) data_inicio\n"
              + "		from 	patient p \n"
              + "				inner join encounter e on p.patient_id=e.patient_id	\n"
              + "				inner join obs o on o.encounter_id=e.encounter_id\n"
              + "		where 	e.voided=0 and o.voided=0 and p.voided=0 and \n"
              + "				e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and \n"
              + "				e.encounter_datetime<=:endDate  and e.location_id=:location\n"
              + "		group by p.patient_id\n"
              + "\n"
              + "		union\n"
              + "\n"
              + "		-- Patients on ART who have art start date: ART Start date/\n"
              + "		Select 	p.patient_id,min(value_datetime) data_inicio\n"
              + "		from 	patient p\n"
              + "				inner join encounter e on p.patient_id=e.patient_id\n"
              + "				inner join obs o on e.encounter_id=o.encounter_id\n"
              + "		where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and \n"
              + "				o.concept_id=1190 and o.value_datetime is not null and \n"
              + "				o.value_datetime<=:endDate  and e.location_id=:location\n"
              + "		group by p.patient_id\n"
              + "\n"
              + "		union\n"
              + "\n"
              + "		-- Patients enrolled in ART Program: OpenMRS Program/\n"
              + "		select 	pg.patient_id,min(date_enrolled) data_inicio\n"
              + "		from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
              + "		where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate  and location_id=:location\n"
              + "		group by pg.patient_id\n"
              + "		\n"
              + "		union\n"
              + "		\n"
              + "		\n"
              + "		-- Patients with first drugs pick up date set in Pharmacy: First ART Start Date/\n"
              + "		  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio \n"
              + "		  FROM 		patient p\n"
              + "					inner join encounter e on p.patient_id=e.patient_id\n"
              + "		  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=:endDate  and e.location_id=:location\n"
              + "		  GROUP BY 	p.patient_id\n"
              + "	  \n"
              + "		union\n"
              + "		\n"
              + "		-- Patients with first drugs pick up date set: Recepcao Levantou ARV/\n"
              + "		Select 	p.patient_id,min(value_datetime) data_inicio\n"
              + "		from 	patient p\n"
              + "				inner join encounter e on p.patient_id=e.patient_id\n"
              + "				inner join obs o on e.encounter_id=o.encounter_id\n"
              + "		where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and \n"
              + "				o.concept_id=23866 and o.value_datetime is not null and \n"
              + "				o.value_datetime<=:endDate  and e.location_id=:location\n"
              + "		group by p.patient_id								\n"
              + "				\n"
              + "		) inicio\n"
              + "	group by patient_id	\n"
              + ") inicio_real on prox_consulta.patient_id=inicio_real.patient_id\n"
              + "left join\n"
              + "(\n"
              + "select patient_id,max(data_estado) data_estado\n"
              + "from\n"
              + "(\n"
              + "/*Estado no programa*/\n"
              + "select maxEstado.patient_id,\n"
              + "maxEstado.data_estado\n"
              + "from\n"
              + "(\n"
              + "select pg.patient_id,max(ps.start_date) data_estado\n"
              + "from   patient p\n"
              + "inner join patient_program pg on p.patient_id=pg.patient_id\n"
              + "inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
              + "where pg.voided=0 and ps.voided=0 and p.voided=0 and\n"
              + "pg.program_id=2 and ps.start_date<=:endDate  and pg.location_id=:location\n"
              + "group by p.patient_id\n"
              + ") maxEstado\n"
              + "inner join patient_program pg2 on pg2.patient_id=maxEstado.patient_id\n"
              + "inner join patient_state ps2 on pg2.patient_program_id=ps2.patient_program_id\n"
              + "where pg2.voided=0 and ps2.voided=0 and pg2.program_id=2 and\n"
              + "ps2.start_date=maxEstado.data_estado and pg2.location_id=:location and ps2.state in (7,8,10)\n"
              + "\n"
              + "\n"
              + "\n"
              + "union\n"
              + "\n"
              + "/*Estado no estado de permanencia da Ficha Resumo, Ficha Clinica*/\n"
              + "select p.patient_id,\n"
              + "max(o.obs_datetime) data_estado\n"
              + "from patient p\n"
              + "inner join encounter e on p.patient_id=e.patient_id\n"
              + "inner join obs  o on e.encounter_id=o.encounter_id\n"
              + "where e.voided=0 and o.voided=0 and p.voided=0 and\n"
              + "e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and  \n"
              + "o.obs_datetime<=:endDate  and e.location_id=:location\n"
              + "group by p.patient_id\n"
              + "\n"
              + "union\n"
              + "\n"
              + "/*Obito demografico*/\n"
              + "\n"
              + "select person_id as patient_id,death_date as data_estado\n"
              + "from person\n"
              + "where dead=1 and death_date is not null and death_date<=:endDate \n"
              + "\n"
              + "union\n"
              + "\n"
              + "/*Obito na ficha de busca*/\n"
              + "select p.patient_id,\n"
              + "max(obsObito.obs_datetime) data_estado\n"
              + "from patient p\n"
              + "inner join encounter e on p.patient_id=e.patient_id\n"
              + "inner join obs obsObito on e.encounter_id=obsObito.encounter_id\n"
              + "where e.voided=0 and p.voided=0 and obsObito.voided=0 and\n"
              + "e.encounter_type in (21,36,37) and  e.encounter_datetime<=:endDate  and  e.location_id=:location and\n"
              + "obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366\n"
              + "group by p.patient_id\n"
              + "\n"
              + "\n"
              + ") allSaida\n"
              + "group by patient_id\n"
              + ") saida on prox_consulta.patient_id=saida.patient_id where saida.data_estado is null) consulta\n"
              + "inner join person pe on pe.person_id=consulta.patient_id where 	((pe.birthdate is not null and \n"
              + "timestampdiff(year,pe.birthdate,:endDate) <= 14	) or pe.birthdate is  null	) )consulta_menor_14\n"
              + "inner join\n"
              + "(\n"
              + "SELECT inicio_pDTG.patient_id \n"
              + "	from \n"
              + "		(\n"
              + "			SELECT inicio_6meses.patient_id  \n"
              + "					from (\n"
              + "							select patient_id,data_inicio\n"
              + "             from\n"
              + "             (	Select patient_id,min(data_inicio) data_inicio\n"
              + "             		from\n"
              + "             			(	\n"
              + "             			\n"
              + "             				/*Patients on ART who initiated the ARV DRUGS: ART Regimen Start Date*/\n"
              + "             				\n"
              + "             						Select 	p.patient_id,min(e.encounter_datetime) data_inicio\n"
              + "             						from 	patient p \n"
              + "             								inner join encounter e on p.patient_id=e.patient_id	\n"
              + "             								inner join obs o on o.encounter_id=e.encounter_id\n"
              + "             						where 	e.voided=0 and o.voided=0 and p.voided=0 and \n"
              + "             								e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and \n"
              + "             								e.encounter_datetime<=:endDate  and e.location_id=:location\n"
              + "             						group by p.patient_id\n"
              + "             				\n"
              + "             						union\n"
              + "             				\n"
              + "             						/*Patients on ART who have art start date: ART Start date*/\n"
              + "             						Select 	p.patient_id,min(value_datetime) data_inicio\n"
              + "             						from 	patient p\n"
              + "             								inner join encounter e on p.patient_id=e.patient_id\n"
              + "             								inner join obs o on e.encounter_id=o.encounter_id\n"
              + "             						where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and \n"
              + "             								o.concept_id=1190 and o.value_datetime is not null and \n"
              + "             								o.value_datetime<=:endDate  and e.location_id=:location\n"
              + "             						group by p.patient_id\n"
              + "             \n"
              + "             						union\n"
              + "             \n"
              + "             						/*Patients enrolled in ART Program: OpenMRS Program*/\n"
              + "             						select 	pg.patient_id,min(date_enrolled) data_inicio\n"
              + "             						from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
              + "             						where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate  and location_id=:location\n"
              + "             						group by pg.patient_id\n"
              + "             						\n"
              + "             						union\n"
              + "             						\n"
              + "             						\n"
              + "             						/*Patients with first drugs pick up date set in Pharmacy: First ART Start Date*/\n"
              + "             						  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio \n"
              + "             						  FROM 		patient p\n"
              + "             									inner join encounter e on p.patient_id=e.patient_id\n"
              + "             						  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0  and e.encounter_datetime<=:endDate  and e.location_id=:location\n"
              + "             						  GROUP BY 	p.patient_id\n"
              + "             					  \n"
              + "             						union\n"
              + "             						\n"
              + "             						/*Patients with first drugs pick up date set: Recepcao Levantou ARV*/\n"
              + "             						Select 	p.patient_id,min(value_datetime) data_inicio\n"
              + "             						from 	patient p\n"
              + "             								inner join encounter e on p.patient_id=e.patient_id\n"
              + "             								inner join obs o on e.encounter_id=o.encounter_id\n"
              + "             						where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and \n"
              + "             								o.concept_id=23866 and o.value_datetime is not null and \n"
              + "             								o.value_datetime<=:endDate  and e.location_id=:location\n"
              + "             						group by p.patient_id		\n"
              + "             					\n"
              + "             				\n"
              + "             				\n"
              + "             			) inicio\n"
              + "             		group by patient_id	\n"
              + "             	)inicio1\n"
              + "             where data_inicio between date_add(date_add(:endDate, interval -6 MONTH), interval 1 day) and :endDate) inicio_6meses\n"
              + "             \n"
              + "             inner join\n"
              + "             \n"
              + "	(-- pDTG Remgime\n"
              + "             SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inici \n"
              + "             						  FROM 		patient p\n"
              + "             									inner join encounter e on p.patient_id=e.patient_id\n"
              + "                                                inner join obs o on o.encounter_id = e.encounter_id\n"
              + "             						  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0  and  o.concept_id=165256 AND\n"
              + "                                      o.value_drug in (51,52) and o.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location\n"
              + "             						  GROUP BY 	p.patient_id) pDTG on inicio_6meses.patient_id = pDTG.patient_id\n"
              + "                                      \n"
              + "	inner join person pe on pe.person_id=inicio_6meses.patient_id\n"
              + "              \n"
              + "	where ((pe.birthdate is not null and timestampdiff(year,pe.birthdate,:endDate) <= 8	) or pe.birthdate is  null	)     \n"
              + "    )inicio_pDTG \n"
              + "    union\n"
              + "    \n"
              + "              	select ultima_carga.patient_id                                                                                                                          "
              + "	 from 		                                                                                                                                                            "
              + "		(                                                                                                                                                                   "
              + "			SELECT cv_above_1000.patient_id                                                                                                                                 "
              + "				FROM                                                                                                                                                        "
              + "                                                                                                                                                                          "
              + "	(                                                                                                                                                                       "
              + "	Select p.patient_id,max(o.obs_datetime) data_carga                                                                                                                      "
              + "			from 	patient p                                                                                                                                               "
              + "					inner join encounter e on p.patient_id=e.patient_id                                                                                                     "
              + "					inner join obs o on e.encounter_id=o.encounter_id                                                                                                       "
              + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,53,9,13,51) and o.concept_id in (856,1305)  and                                             "
              + "					o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and e.location_id=:location                        "
              + "			group by p.patient_id) max_date_carga                                                                                                                           "
              + "            inner join                                                                                                                                                    "
              + "                                                                                                                                                                          "
              + "            (Select p.patient_id,max(o.obs_datetime) data_carga                                                                                                           "
              + "			from 	patient p                                                                                                                                               "
              + "					inner join encounter e on p.patient_id=e.patient_id                                                                                                     "
              + "					inner join obs o on e.encounter_id=o.encounter_id                                                                                                       "
              + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,53,9,13,51) and  o.concept_id = 856 and o.value_numeric>1000 and  		            "
              + "					o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and e.location_id=:location                        "
              + "			group by p.patient_id) cv_above_1000 on max_date_carga.data_carga = cv_above_1000.data_carga and                                                                "
              + "            max_date_carga.patient_id = cv_above_1000.patient_id                                                                                                          "
              + "		) ultima_carga 																																						"
              + "	union\n"
              + "	\n"
              + "  select consulta.patient_id from\n"
              + "(\n"
              + "			Select 	p.patient_id,max(value_datetime)\n"
              + "             						from 	patient p\n"
              + "             								inner join encounter e on p.patient_id=e.patient_id\n"
              + "             								inner join obs o on e.encounter_id=o.encounter_id\n"
              + "             						where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9) \n"
              + "                                    and o.value_datetime BETWEEN :startDate AND :endDate \n"
              + "             								 and e.location_id=:location\n"
              + "             						group by p.patient_id ) consulta\n"
              + "                                    inner join person pe on pe.person_id=consulta.patient_id											\n"
              + "            where 	((pe.birthdate is not null and timestampdiff(year,pe.birthdate,:endDate) <= 2	) or pe.birthdate is  null	)    \n"
              + ") cv on cv.patient_id = consulta_menor_14.patient_id )coorteprox_consulta\n"
              + " left join \n"
              + "	(	select pid1.*\n"
              + "		from patient_identifier pid1\n"
              + "		inner join \n"
              + "			(\n"
              + "				select patient_id,min(patient_identifier_id) id \n"
              + "				from patient_identifier\n"
              + "				where voided=0\n"
              + "				group by patient_id\n"
              + "			) pid2\n"
              + "		where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
              + "	) pid on pid.patient_id=coorteprox_consulta.patient_id\n"
              + "	left join \n"
              + "	(	select pn1.*\n"
              + "		from person_name pn1\n"
              + "		inner join \n"
              + "			(\n"
              + "				select person_id,min(person_name_id) id \n"
              + "				from person_name\n"
              + "				where voided=0\n"
              + "				group by person_id\n"
              + "			) pn2\n"
              + "		where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
              + "	) pn on pn.person_id=coorteprox_consulta.patient_id\n"
              + "    left join\n"
              + "    (	Select peso_crianca.patient_id, peso_crianca.peso  FROM\n"
              + "\n"
              + "(Select 	p.patient_id,o.obs_datetime,o.value_numeric peso\n"
              + "             						from 	patient p\n"
              + "             								inner join encounter e on p.patient_id=e.patient_id\n"
              + "             								inner join obs o on e.encounter_id=o.encounter_id\n"
              + "             						where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9,53,51) \n"
              + "                                    and o.concept_id=5089  and o.obs_datetime <= :endDate\n"
              + "             								 and e.location_id=:location) peso_crianca \n"
              + "\n"
              + "inner join\n"
              + "\n"
              + "(Select 	p.patient_id,max(o.obs_datetime) data_mx\n"
              + "             						from 	patient p\n"
              + "             								inner join encounter e on p.patient_id=e.patient_id\n"
              + "             								inner join obs o on e.encounter_id=o.encounter_id\n"
              + "             						where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9,53,51) \n"
              + "                                    and o.concept_id=5089  \n"
              + "                                    and o.obs_datetime <= :endDate\n"
              + "             								 and e.location_id=:location\n"
              + "             						group by p.patient_id ) peso_crianca_max on peso_crianca.obs_datetime=peso_crianca_max.data_mx \n"
              + "                                    and peso_crianca.patient_id = peso_crianca_max.patient_id ) peso on peso.patient_id=coorteprox_consulta.patient_id\n"
              + "		LEFT JOIN (\n"
              + "             		Select 	p.patient_id,max(o.value_datetime) consulta_data_agendada\n"
              + "             						from 	patient p\n"
              + "             								inner join encounter e on p.patient_id=e.patient_id\n"
              + "             								inner join obs o on e.encounter_id=o.encounter_id\n"
              + "             						where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9) \n"
              + "                                    and o.concept_id=1410  \n"
              + "                                    and o.value_datetime BETWEEN :startDate AND :endDate \n"
              + "             								 and e.location_id=:location\n"
              + "             						group by p.patient_id \n"
              + "             	)consulta ON coorteprox_consulta.patient_id = consulta.patient_id\n"
              + "             LEFT JOIN (\n"
              + "             	Select p.patient_id,max(o.value_datetime) levantamento_data_agendada\n"
              + "						from patient p\n"
              + "						inner join encounter e on e.patient_id=p.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=18 and  o.concept_id = 5096 and\n"
              + "						e.location_id=:location and e.encounter_datetime <= :endDate\n"
              + "						group by p.patient_id\n"
              + "			 \n"
              + "             	)levantamento ON levantamento.patient_id = coorteprox_consulta.patient_id\n"
              + "    		LEFT JOIN (\n"
              + "             		Select p.patient_id,max(encounter_datetime) data_seguimento\n"
              + "						from patient p\n"
              + "						inner join encounter e on e.patient_id=p.patient_id\n"
              + "						where p.voided=0 and e.voided=0 and e.encounter_type in (6,9) and\n"
              + "						e.location_id=:location and e.encounter_datetime<=:endDate\n"
              + "						group by p.patient_id\n"
              + "\n"
              + "             	)ultima_consulta ON coorteprox_consulta.patient_id = ultima_consulta.patient_id \n"
              + "					and ultima_consulta.data_seguimento<=consulta.consulta_data_agendada\n"
              + "		left join(\n"
              + "				 Select p.patient_id,max(encounter_datetime) data_fila\n"
              + "				from patient p\n"
              + "				inner join encounter e on e.patient_id=p.patient_id\n"
              + "				where p.voided=0 and e.voided=0 and e.encounter_type=18 and\n"
              + "				e.location_id=:location and e.encounter_datetime<=:endDate\n"
              + "				group by p.patient_id\n"
              + "				 union\n"
              + "				Select p.patient_id,max(value_datetime) data_fila\n"
              + "				from patient p\n"
              + "				inner join encounter e on p.patient_id=e.patient_id\n"
              + "				inner join obs o on e.encounter_id=o.encounter_id\n"
              + "				where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and\n"
              + "				o.concept_id=23866 and o.value_datetime is not null and\n"
              + "				o.value_datetime<=:endDate and e.location_id=:location\n"
              + "				group by p.patient_id\n"
              + "			)utlimo_levantamento on coorteprox_consulta.patient_id = utlimo_levantamento.patient_id\n"
              + "				and utlimo_levantamento.data_fila<=levantamento.levantamento_data_agendada\n"
              + "			left join\n"
              + "(\n"
              + "select ultimo_lev.patient_id,\n"
              + "ultimo_lev.encounter_datetime as max_date,\n"
              + "case o.value_coded\n"
              + "when 1703 then 'AZT+3TC+EFV'\n"
              + "when 6100 then 'AZT+3TC+LPV/r'\n"
              + "when 1651 then 'AZT+3TC+NVP'\n"
              + "when 6324 then 'TDF+3TC+EFV'\n"
              + "when 6104 then 'ABC+3TC+EFV'\n"
              + "when 23784 then 'TDF+3TC+DTG'\n"
              + "when 23785 then 'TDF+3TC+DTG'\n"
              + "when 23786 then 'ABC+3TC+DTG'\n"
              + "when 6116 then 'AZT+3TC+ABC'\n"
              + "when 6106 then 'ABC+3TC+LPV/r'\n"
              + "when 6105 then 'ABC+3TC+NVP'\n"
              + "when 6108 then 'TDF+3TC+LPV/r'\n"
              + "when 23790 then 'TDF+3TC+LPV/r+RTV'\n"
              + "when 23791 then 'TDF+3TC+ATV/r'\n"
              + "when 23792 then 'ABC+3TC+ATV/r'\n"
              + "when 23793 then 'AZT+3TC+ATV/r'\n"
              + "when 23795 then 'ABC+3TC+ATV/r+RAL'\n"
              + "when 23796 then 'TDF+3TC+ATV/r+RAL'\n"
              + "when 23801 then 'AZT+3TC+RAL'\n"
              + "when 23802 then 'AZT+3TC+DRV/r'\n"
              + "when 23815 then 'AZT+3TC+DTG'\n"
              + "when 6329 then 'TDF+3TC+RAL+DRV/r'\n"
              + "when 23797 then 'ABC+3TC+DRV/r+RAL'\n"
              + "when 23798 then '3TC+RAL+DRV/r'\n"
              + "when 23803 then 'AZT+3TC+RAL+DRV/r'\n"
              + "when 6243 then 'TDF+3TC+NVP'\n"
              + "when 6103 then 'D4T+3TC+LPV/r'\n"
              + "when 792 then 'D4T+3TC+NVP'\n"
              + "when 1827 then 'D4T+3TC+EFV'\n"
              + "when 6102 then 'D4T+3TC+ABC'\n"
              + "when 1311 then 'ABC+3TC+LPV/r'\n"
              + "when 1312 then 'ABC+3TC+NVP'\n"
              + "when 1313 then 'ABC+3TC+EFV'\n"
              + "when 1314 then 'AZT+3TC+LPV/r'\n"
              + "when 1315 then 'TDF+3TC+EFV'\n"
              + "when 6330 then 'AZT+3TC+RAL+DRV/r'\n"
              + "when 6325 then 'D4T+3TC+ABC+LPV/r'\n"
              + "when 6326 then 'AZT+3TC+ABC+LPV/r'\n"
              + "when 6327 then 'D4T+3TC+ABC+EFV'\n"
              + "when 6328 then 'AZT+3TC+ABC+EFV'\n"
              + "when 6109 then 'AZT+DDI+LPV/r'\n"
              + "when 21163 then 'AZT+3TC+LPV/r'\n"
              + "when 23799 then 'TDF+3TC+DTG'\n"
              + "when 23800 then 'ABC+3TC+DTG'\n"
              + "when 6110 then 'D4T20+3TC+NVP'\n"
              + "when 1702 then 'AZT+3TC+NFV'\n"
              + "when 817  then 'AZT+3TC+ABC'\n"
              + "when 6244 then 'AZT+3TC+RTV'\n"
              + "when 1700 then 'AZT+DDl+NFV'\n"
              + "when 633  then 'EFV'\n"
              + "when 625  then 'D4T'\n"
              + "when 631  then 'NVP'\n"
              + "when 628  then '3TC'\n"
              + "when 635  then 'NFV'\n"
              + "when 797  then 'AZT'\n"
              + "when 814  then 'ABC'\n"
              + "when 6107 then 'TDF+AZT+3TC+LPV/r'\n"
              + "when 6236 then 'D4T+DDI+RTV-IP'\n"
              + "when 1701 then 'ABC+DDI+NFV'\n"
              + "when 6114 then '3DFC'\n"
              + "when 6115 then '2DFC+EFV'\n"
              + "when 6233 then 'AZT+3TC+DDI+LPV'\n"
              + "when 6234 then 'ABC+TDF+LPV'\n"
              + "when 6242 then 'D4T+DDI+NVP'\n"
              + "when 6118 then 'DDI50+ABC+LPV'\n"
              + "else 'OUTRO' end as ultimo_regime,\n"
              + "ultimo_lev.encounter_datetime data_regime\n"
              + "from obs o,\n"
              + "( select p.patient_id,max(encounter_datetime) as encounter_datetime\n"
              + "from patient p\n"
              + "inner join encounter e on p.patient_id=e.patient_id\n"
              + "where encounter_type=18 and e.voided=0 and\n"
              + "encounter_datetime <=:endDate and e.location_id=:location and p.voided=0\n"
              + "group by patient_id\n"
              + ") ultimo_lev\n"
              + "where o.person_id=ultimo_lev.patient_id and o.obs_datetime=ultimo_lev.encounter_datetime and o.voided=0 and\n"
              + "o.concept_id=1088 and o.location_id=:location\n"
              + ") regimeFila on regimeFila.patient_id=coorteprox_consulta.patient_id\n"
              + "left join\n"
              + "    (SELECT 	e.patient_id, MAX(e.encounter_datetime) AS max_date, d.name as medicamento\n"
              + "             						  FROM 		patient p\n"
              + "             									inner join encounter e on p.patient_id=e.patient_id\n"
              + "                                                inner join obs o on o.encounter_id = e.encounter_id\n"
              + "                                                inner join drug d on d.drug_id = o.value_drug \n"
              + "             						  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0  and  o.concept_id=165256 AND\n"
              + "                                      o.value_drug in (51,52) and o.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location\n"
              + "             						  GROUP BY 	p.patient_id) med on  med.patient_id=coorteprox_consulta.patient_id and \n"
              + "														med.max_date=regimeFila.max_date\n"
              + "                                                        \n"
              + "			\n"
              + "left join\n"
              + "									( select sector_inicial.patient_id,\n"
              + "									case o.value_coded\n"
              + "									when 1414 then 'TB'\n"
              + "									when 1987 then 'SAAJ'\n"
              + "									when 1985 then 'CPN/G'\n"
              + "									when 1872 then 'CCR/L'\n"
              + "									when 21275 then 'Clinica'\n"
              + "									else '' end as sector\n"
              + "									from obs o,\n"
              + "						( select p.patient_id,max(encounter_datetime) as encounter_datetime\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						where encounter_type=53 and e.voided=0 and\n"
              + "						encounter_datetime <=:endDate and e.location_id=:location and p.voided=0\n"
              + "												group by patient_id\n"
              + "						) sector_inicial\n"
              + "						where o.person_id=sector_inicial.patient_id and o.obs_datetime=sector_inicial.encounter_datetime and o.voided=0 and\n"
              + "						o.concept_id=23783 and o.location_id=:location group by patient_id\n"
              + "						) sector on sector.patient_id=coorteprox_consulta.patient_id \n"
              + "                        \n"
              + "                        left join\n"
              + "(\n"
              + "Select p.patient_id,max(o.obs_datetime) data_carga\n"
              + "from patient p\n"
              + "             inner join encounter e on p.patient_id=e.patient_id\n"
              + "             inner join obs o on e.encounter_id=o.encounter_id\n"
              + "        where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9,53,13,51) and  \n"
              + "o.concept_id in (856,1305) and  o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and\n"
              + "e.location_id=:location\n"
              + "group by p.patient_id\n"
              + "\n"
              + ") carga_viral on carga_viral.patient_id=coorteprox_consulta.patient_id\n"
              + "left join\n"
              + "(\n"
              + "select 	\n"
              + "		carga_viral.patient_id, \n"
              + "		carga_viral.Valor_carga,\n"
              + "        carga_viral.data_carga\n"
              + "        \n"
              + "		\n"
              + "\n"
              + "from 	\n"
              + "(\n"
              + "	 select ultima_carga.patient_id,ultima_carga.data_carga,\n"
              + "     if(obs.value_numeric is null or obs.value_numeric<0,'Indetectavel',obs.value_numeric)  Valor_carga, \n"
              + "			ultima_carga.encounter_type,\n"
              + "			obs.creator,\n"
              + "			obs.date_created data_registo\n"
              + "	 from 		\n"
              + "		( \n"
              + "			Select p.patient_id,max(o.obs_datetime) data_carga, e.encounter_type\n"
              + "			from 	patient p \n"
              + "					inner join encounter e on p.patient_id=e.patient_id \n"
              + "					inner join obs o on e.encounter_id=o.encounter_id \n"
              + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,51,6,9) and  o.concept_id in (856,1305) and  \n"
              + "					o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and e.location_id=:location\n"
              + "			group by p.patient_id\n"
              + "		) ultima_carga \n"
              + "			inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga \n"
              + "		where obs.voided=0 and ((obs.concept_id=856) or obs.concept_id=1305)  and obs.location_id=:location\n"
              + ") carga_viral\n"
              + "inner join encounter_type et on et.encounter_type_id=carga_viral.encounter_type\n"
              + "group by carga_viral.patient_id) ultima_cv on ultima_cv.patient_id=coorteprox_consulta.patient_id and ultima_cv.data_carga =carga_viral.data_carga\n"
              + " \n"
              + "    	LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_gaac\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'GA', NULL ) mds_gaac, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=23724 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0  and o.location_id=:location and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)\n"
              + "             	)gaac_model ON gaac_model.patient_id =coorteprox_consulta.patient_id\n"
              + "              \n"
              + "              \n"
              + "              \n"
              + "              \n"
              + "              LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_eh\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'EH', NULL ) mds_eh, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=165316 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)\n"
              + "             	)eh_model ON eh_model.patient_id =coorteprox_consulta.patient_id\n"
              + "              \n"
              + "              	LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_cm\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'CM', NULL ) mds_cm, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=165265 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)\n"
              + "             	)cm_model ON cm_model.patient_id =coorteprox_consulta.patient_id\n"
              + "                \n"
              + "              \n"
              + "              \n"
              + "                \n"
              + "                \n"
              + "                LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_dd\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DD', NULL ) mds_dd, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=165315 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and  o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)\n"
              + "             	)dd_model ON dd_model.patient_id =coorteprox_consulta.patient_id\n"
              + "                \n"
              + "                 LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_dcp\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DCP', NULL ) mds_dcp, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=165178 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)\n"
              + "             	)dcp_model ON dcp_model.patient_id =coorteprox_consulta.patient_id\n"
              + "                \n"
              + "                 LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_dca\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DCA', NULL ) mds_dca, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=165179 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)\n"
              + "             	)dca_model ON dca_model.patient_id =coorteprox_consulta.patient_id\n"
              + "                \n"
              + "                \n"
              + "                 LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_bm\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'BM', NULL ) mds_bm, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=165264 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and  o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)\n"
              + "             	)bm_model ON bm_model.patient_id =coorteprox_consulta.patient_id\n"
              + "                \n"
              + "                \n"
              + "                \n"
              + "                \n"
              + "                \n"
              + "				LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_smi\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'SMI', NULL ) mds_smi, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=165320 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)\n"
              + "             	)smi_model ON smi_model.patient_id =coorteprox_consulta.patient_id\n"
              + "                \n"
              + "                \n"
              + "                \n"
              + "                \n"
              + "                LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_saaj\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'SAAJ', NULL ) mds_saaj, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=165319 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)\n"
              + "             	)saaj_model ON saaj_model.patient_id =coorteprox_consulta.patient_id\n"
              + "         \n"
              + "             	LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_af\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'AF', NULL ) mds_af, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=23725 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)\n"
              + "             	)af_model ON af_model.patient_id =coorteprox_consulta.patient_id\n"
              + "             \n"
              + "             	LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_ca\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'CA', NULL ) mds_ca, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=23726 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)\n"
              + "             	)ca_model ON ca_model.patient_id =coorteprox_consulta.patient_id\n"
              + "             \n"
              + "             	LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_pu\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'CT', NULL ) mds_pu, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=165318 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)\n"
              + "                         )pu_model ON pu_model.patient_id =coorteprox_consulta.patient_id\n"
              + "                         \n"
              + "                         LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_tb\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'TB', NULL ) mds_tb, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=165317 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime)\n"
              + "                         )tb_model ON tb_model.patient_id =coorteprox_consulta.patient_id\n"
              + "           \n"
              + "           \n"
              + "             	LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_fr\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'FR', NULL ) mds_fr, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=23729 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime )\n"
              + "             	)fr_model ON fr_model.patient_id =coorteprox_consulta.patient_id\n"
              + "              \n"
              + "             	LEFT JOIN (		\n"
              + "             		select os.person_id patient_id, os.mds_dt\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DT', NULL ) mds_dt, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=23730 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location  and o.obs_group_id is not null and o.obs_datetime <= :endDate and  o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime )\n"
              + "             	)dt_model ON dt_model.patient_id =coorteprox_consulta.patient_id\n"
              + "             \n"
              + "             	LEFT JOIN (		\n"
              + "             		SELECT o.person_id patient_id, IF(MAX(o.obs_datetime) IS NOT NULL, 'DC', NULL ) mds_dc FROM obs o\n"
              + "             			INNER JOIN encounter e ON o.encounter_id = e.encounter_id\n"
              + "             				WHERE o.voided = 0 AND e.voided = 0 AND concept_id = 23731\n"
              + "             				AND value_coded IN (1256, 1257) AND o.obs_datetime <= :endDate  AND e.location_id = :location\n"
              + "             					GROUP BY o.person_id\n"
              + "             	)dc_model ON dc_model.patient_id =coorteprox_consulta.patient_id\n"
              + "             \n"
              + "             	LEFT JOIN (	\n"
              + "                select os.person_id patient_id, os.mds_ds\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DS', NULL ) mds_ds, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=23888 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and  o.obs_datetime <= :endDate and o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime )\n"
              + "										)ds_model ON ds_model.patient_id =coorteprox_consulta.patient_id\n"
              + "\n"
              + "			LEFT JOIN (	\n"
              + "                select os.person_id patient_id, os.mds_dah\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DAH', NULL ) mds_dah, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=165321 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and  o.obs_datetime <= :endDate and o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime )\n"
              + "										)dah_model ON dah_model.patient_id =coorteprox_consulta.patient_id\n"
              + "          \n"
              + "			LEFT JOIN (	\n"
              + "                select os.person_id patient_id, os.mds_da\n"
              + "						from\n"
              + "						(select  os.person_id, IF(MAX(os.obs_datetime) IS NOT NULL, 'DA', NULL ) mds_da, \n"
              + "						max(os.obs_group_id) obs_group_id,max(os.encounter_id) encounter_id,MAX(os.obs_datetime) max_ds from obs os where  \n"
              + "						os.concept_id = 165174 and os.location_id=:location and os.value_coded=165314 and os.voided=0 and os.obs_datetime <= :endDate \n"
              + "						 GROUP BY os.person_id) os\n"
              + "						 \n"
              + "						 Where os.obs_group_id in (select obs_group_id from obs o where o.value_coded in (1256, 1257)\n"
              + "						 and o.voided =0 and o.location_id=:location and o.obs_group_id is not null and  o.obs_datetime <= :endDate and o.encounter_id = os.encounter_id\n"
              + "						 and os.person_id = o.person_id and  os.obs_group_id =o.obs_group_id and os.max_ds= o.obs_datetime )\n"
              + "										)da_model ON da_model.patient_id =coorteprox_consulta.patient_id\n"
              + "          left join\n"
              + "( select pad1.*\n"
              + "from person_address pad1\n"
              + "inner join\n"
              + "(\n"
              + "select person_id,min(person_address_id) id\n"
              + "from person_address\n"
              + "where voided=0\n"
              + "group by person_id\n"
              + ") pad2\n"
              + "where pad1.person_id=pad2.person_id and pad1.person_address_id=pad2.id\n"
              + ") pad3 on pad3.person_id=coorteprox_consulta.patient_id\n"
              + "\n"
              + "\n"
              + "\n"
              + "left join \n"
              + "	(	SELECT pa.person_id patient_id, pa.value patient_contact FROM person_attribute pa\n"
              + "                     WHERE pa.person_attribute_type_id = 9\n"
              + "                   GROUP BY pa.person_id\n"
              + "           	)patient_contact ON patient_contact.patient_id = coorteprox_consulta.patient_id\n"
              + "            \n"
              + "left join \n"
              + "	(	SELECT pa.person_id patient_id, pa.value patient_contact FROM person_attribute pa\n"
              + "                     WHERE pa.person_attribute_type_id = 30\n"
              + "                   GROUP BY pa.person_id\n"
              + "           	)patient_contact2 ON patient_contact2.patient_id = coorteprox_consulta.patient_id\n"
              + "\n"
              + "    group by coorteprox_consulta.patient_id ";

      return query;
    }
  }
}
