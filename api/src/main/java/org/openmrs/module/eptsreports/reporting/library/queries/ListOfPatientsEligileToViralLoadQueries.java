package org.openmrs.module.eptsreports.reporting.library.queries;

public interface ListOfPatientsEligileToViralLoadQueries {

  class QUERY {

    public static final String findPatientsEligibleToViralLoadList =
        "	select inicio.patient_id, inicio.data_inicio, "
            + "	concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as NomeCompleto, "
            + "	pid.identifier as NID, "
            + "	p.birthdate, "
            + "	p.gender as gender, "
            + "	round(datediff(:endDate,p.birthdate)/365) as idade_actual, pa.value contacto, "
            + "	vl_final.data_carga, vl_final.valor_carga, "
            + "case regime_tarv "
            + "when 1703 then 'AZT+3TC+EFV' "
            + "when 6100 then 'AZT+3TC+LPV/r' "
            + "when 1651 then 'AZT+3TC+NVP' "
            + "when 6324 then 'TDF+3TC+EFV' "
            + "when 6104 then 'ABC+3TC+EFV' "
            + "when 23784 then 'TDF+3TC+DTG' "
            + "when 23786 then 'ABC+3TC+DTG' "
            + "when 6116 then 'AZT+3TC+ABC' "
            + "when 6106 then 'ABC+3TC+LPV/r' "
            + "when 6105 then 'ABC+3TC+NVP' "
            + "when 6108 then 'TDF+3TC+LPV/r' "
            + "when 23790 then 'TDF+3TC+LPV/r+RTV' "
            + "when 23791 then 'TDF+3TC+ATV/r' "
            + "when 23792 then 'ABC+3TC+ATV/r' "
            + "when 23793 then 'AZT+3TC+ATV/r' "
            + "when 23795 then 'ABC+3TC+ATV/r+RAL' "
            + "when 23796 then 'TDF+3TC+ATV/r+RAL' "
            + "when 23801 then 'AZT+3TC+RAL' "
            + "when 23802 then 'AZT+3TC+DRV/r' "
            + "when 23815 then 'AZT+3TC+DTG' "
            + "when 6329 then 'TDF+3TC+RAL+DRV/r' "
            + "when 23797 then 'ABC+3TC+DRV/r+RAL' "
            + "when 23798 then '3TC+RAL+DRV/r' "
            + "when 23803 then 'AZT+3TC+RAL+DRV/r' "
            + "when 6243 then 'TDF+3TC+NVP' "
            + "when 6103 then 'D4T+3TC+LPV/r' "
            + "when 792 then 'D4T+3TC+NVP' "
            + "when 1827 then 'D4T+3TC+EFV' "
            + "when 6102 then 'D4T+3TC+ABC' "
            + "when 1311 then 'ABC+3TC+LPV/r' "
            + "when 1312 then 'ABC+3TC+NVP' "
            + "when 1313 then 'ABC+3TC+EFV' "
            + "when 1314 then 'AZT+3TC+LPV/r' "
            + "when 1315 then 'TDF+3TC+EFV' "
            + "when 6330 then 'AZT+3TC+RAL+DRV/r' "
            + "when 6325 then 'D4T+3TC+ABC+LPV/r' "
            + "when 6326 then 'AZT+3TC+ABC+LPV/r' "
            + "when 6327 then 'D4T+3TC+ABC+EFV' "
            + "when 6328 then 'AZT+3TC+ABC+EFV' "
            + "when 6109 then 'AZT+DDI+LPV/r' "
            + "when 21163 then 'AZT+3TC+LPV/r' "
            + "when 23799 then 'TDF+3TC+DTG ' "
            + "when 23800 then 'ABC+3TC+DTG ' "
            + "when 6110 then  'D4T20+3TC+NVP' "
            + "when 1702 then 'AZT+3TC+NFV' "
            + "when 817  then 'AZT+3TC+ABC' "
            + "when 6244 then 'AZT+3TC+RTV' "
            + "when 1700 then 'AZT+DDl+NFV' "
            + "when 633  then 'EFV' "
            + "when 625  then 'D4T' "
            + "when 631  then 'NVP' "
            + "when 628  then '3TC' "
            + "when 635  then 'NFV' "
            + "when 797  then 'AZT' "
            + "when 814  then 'ABC' "
            + "when 6107 then 'TDF+AZT+3TC+LPV/r' "
            + "when 6236 then 'D4T+DDI+RTV-IP' "
            + "when 1701 then 'ABC+DDI+NFV' "
            + "when 6114 then '3DFC' "
            + "when 6115 then '2DFC+EFV' "
            + "when 6233 then 'AZT+3TC+DDI+LPV' "
            + "when 6234 then 'ABC+TDF+LPV' "
            + "when 6242 then 'D4T+DDI+NVP' "
            + "when 6118 then 'DDI50+ABC+LPV' "
            + "else 'OUTRO' end as regime_tarv, "
            + "case linha_terapeutica "
            + "when 21150 then 'PRIMEIRA LINHA' "
            + "when 21148 then 'SEGUNDA LINHA' "
            + "when 21149 then 'TERCEIRA LINHA' "
            + "else '' end as linha_terapeutica, "
            + "data_seguimento data_ultima_consulta, "
            + "data_proximo_seguimento data_proxima_consulta, "
            + "data_fila data_ultimo_fila, "
            + "data_proximo_lev data_proximo_fila, "
            + "data_recepcao_levantou, "
            + "data_recepcao_levantou30, "
            + "apss_final.sessoes "
            + "	from( "
            + "	select coorte12meses_final.patient_id, data_usar_c , data_usar, coorte12meses_final.data_inicio, regime_tarv , linha_terapeutica, data_seguimento, data_proximo_seguimento, data_fila, data_proximo_lev, data_recepcao_levantou, data_recepcao_levantou30 "
            + "	from "
            + "	(select   	inicio_fila_seg_prox.*, "
            + "			GREATEST(COALESCE(data_fila,data_seguimento,data_recepcao_levantou),COALESCE(data_seguimento,data_fila,data_recepcao_levantou),COALESCE(data_recepcao_levantou,data_seguimento,data_fila))  data_usar_c, "
            + "		    GREATEST(COALESCE(data_proximo_lev,data_proximo_seguimento,data_recepcao_levantou30),COALESCE(data_proximo_seguimento,data_proximo_lev,data_recepcao_levantou30),COALESCE(data_recepcao_levantou30,data_proximo_seguimento,data_proximo_lev)) data_usar, "
            + "		    regime regime_tarv, "
            + "		    linha linha_terapeutica "
            + "	from "
            + "		(select 	inicio_fila_seg.*, "
            + "		max(obs_fila.value_datetime) data_proximo_lev, "
            + "		max(obs_seguimento.value_datetime) data_proximo_seguimento, "
            + "		date_add(data_recepcao_levantou, interval 30 day) data_recepcao_levantou30, "
            + "		obs_regime.value_coded regime, "
            + "		obs_linha.value_coded linha "
            + "  from "
            + "(select inicio.*, "
            + "		saida.data_estado, "
            + "		max_fila.data_fila, "
            + "		max_consulta.data_seguimento, "
            + "		max_recepcao.data_recepcao_levantou "
            + " from "
            + " (	Select patient_id,min(data_inicio) data_inicio "
            + "		from "
            + "			( "
            + "				Select 	p.patient_id,min(e.encounter_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on o.encounter_id=e.encounter_id "
            + "				where 	e.voided=0 and o.voided=0 and p.voided=0 and "
            + "						e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and "
            + "						e.encounter_datetime<=:endDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "				union "
            + "				Select 	p.patient_id,min(value_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on e.encounter_id=o.encounter_id "
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and "
            + "						o.concept_id=1190 and o.value_datetime is not null and "
            + "						o.value_datetime<=:endDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "				union "
            + "				select 	pg.patient_id,min(date_enrolled) data_inicio "
            + "				from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id "
            + "				where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate and location_id=:location "
            + "				group by pg.patient_id "
            + "				union "
            + "				  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio "
            + "				  FROM 		patient p "
            + "							inner join encounter e on p.patient_id=e.patient_id "
            + "				  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location "
            + "				  GROUP BY 	p.patient_id "
            + "				union "
            + "				Select 	p.patient_id,min(value_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on e.encounter_id=o.encounter_id "
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "						o.concept_id=23866 and o.value_datetime is not null and "
            + "						o.value_datetime<=:endDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "			) inicio_real "
            + "		group by patient_id "
            + "  )inicio "
            + "  left join "
            + "	( "
            + "	select patient_id,max(data_estado) data_estado "
            + "	from "
            + "		( "
            + "			select 	pg.patient_id, "
            + "					max(ps.start_date) data_estado "
            + "			from 	patient p "
            + "					inner join patient_program pg on p.patient_id=pg.patient_id "
            + "					inner join patient_state ps on pg.patient_program_id=ps.patient_program_id "
            + "			where 	pg.voided=0 and ps.voided=0 and p.voided=0 and "
            + "					pg.program_id=2 and ps.state in (7,8,10) and ps.end_date is null and "
            + "					ps.start_date<=:endDate and location_id=:location "
            + "			group by pg.patient_id "
            + "			union "
            + "			select 	p.patient_id, "
            + "					max(o.obs_datetime) data_estado "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs  o on e.encounter_id=o.encounter_id "
            + "			where 	e.voided=0 and o.voided=0 and p.voided=0 and "
            + "					e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and "
            + "					o.obs_datetime<=:endDate and e.location_id=:location "
            + "			group by p.patient_id "
            + "			union "
            + "			select person_id as patient_id,death_date as data_estado "
            + "			from person "
            + "			where dead=1 and death_date is not null and death_date<=:endDate "
            + "			union "
            + "			select 	p.patient_id, "
            + "					max(obsObito.obs_datetime) data_estado "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs obsObito on e.encounter_id=obsObito.encounter_id "
            + "			where 	e.voided=0 and p.voided=0 and obsObito.voided=0 and "
            + "					e.encounter_type in (21,36,37) and  e.encounter_datetime<=:endDate and  e.location_id=:location and "
            + "					obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366 "
            + "			group by p.patient_id "
            + "			union "
            + "			select 	p.patient_id,max(e.encounter_datetime) data_estado "
            + "			from	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on o.encounter_id=e.encounter_id "
            + "			where 	e.voided=0 and p.voided=0 and e.encounter_datetime<=:endDate and "
            + "					o.voided=0 and o.concept_id=2016 and o.value_coded in (1706,23863) and e.encounter_type in (21,36,37) and  e.location_id=:location "
            + "			group by p.patient_id "
            + "		) allSaida "
            + "	group by patient_id "
            + "  ) saida on inicio.patient_id=saida.patient_id "
            + " left join "
            + "  ( Select p.patient_id,max(encounter_datetime) data_fila "
            + "	from 	patient p "
            + "			inner join encounter e on e.patient_id=p.patient_id "
            + "	where 	p.voided=0 and e.voided=0 and e.encounter_type=18 and "
            + "			e.location_id=:location and e.encounter_datetime<=:endDate "
            + "	group by p.patient_id "
            + " ) max_fila on inicio.patient_id=max_fila.patient_id "
            + "  left join "
            + "  (	Select 	p.patient_id,max(encounter_datetime) data_seguimento "
            + "	from 	patient p "
            + "			inner join encounter e on e.patient_id=p.patient_id "
            + "	where 	p.voided=0 and e.voided=0 and e.encounter_type in (6,9) and "
            + "			e.location_id=:location and e.encounter_datetime<=:endDate "
            + "	group by p.patient_id "
            + " ) max_consulta on inicio.patient_id=max_consulta.patient_id "
            + "  left join "
            + "  ( "
            + "	Select 	p.patient_id,max(value_datetime) data_recepcao_levantou "
            + "	from 	patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "			o.concept_id=23866 and o.value_datetime is not null and "
            + "			o.value_datetime between :startDate and :endDate and e.location_id=:location "
            + "	group by p.patient_id "
            + "  ) max_recepcao on inicio.patient_id=max_recepcao.patient_id "
            + "  group by inicio.patient_id "
            + " ) inicio_fila_seg "
            + "  left join "
            + "	 obs obs_fila on obs_fila.person_id=inicio_fila_seg.patient_id "
            + "   and obs_fila.voided=0 "
            + "	 and obs_fila.obs_datetime=inicio_fila_seg.data_fila "
            + "	 and obs_fila.concept_id=5096 "
            + "	 and obs_fila.location_id=:location "
            + "	 and obs_fila.value_datetime between :startDate and :endDate "
            + "  left join "
            + "	 obs obs_regime on obs_regime.person_id=inicio_fila_seg.patient_id "
            + "   and obs_regime.voided=0 "
            + "	 and obs_regime.obs_datetime=inicio_fila_seg.data_fila "
            + "	 and obs_regime.concept_id=1088 "
            + "	 and obs_regime.location_id=:location "
            + "  left join "
            + "	obs obs_seguimento on obs_seguimento.person_id=inicio_fila_seg.patient_id "
            + "	and obs_seguimento.voided=0 "
            + "	and obs_seguimento.obs_datetime=inicio_fila_seg.data_seguimento "
            + "	and obs_seguimento.concept_id=1410 "
            + "	and obs_seguimento.location_id=:location "
            + "	and obs_seguimento.value_datetime between :startDate and :endDate "
            + " left join "
            + "	obs obs_linha on obs_linha.person_id=inicio_fila_seg.patient_id "
            + "	and obs_linha.voided=0 "
            + "	and obs_linha.obs_datetime=inicio_fila_seg.data_seguimento "
            + "	and obs_linha.concept_id=21151 "
            + "	and obs_linha.location_id=:location "
            + " group by inicio_fila_seg.patient_id "
            + " ) inicio_fila_seg_prox "
            + " group by patient_id "
            + " ) coorte12meses_final "
            + "inner join "
            + "( "
            + "select patient_id, min(data_inicio) data_inicio from ( "
            + "Select p.patient_id,min(e.encounter_datetime) data_inicio from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and o.voided=0 and p.voided=0 and  e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and  e.encounter_datetime<='2021-06-01' and e.location_id=:location "
            + "group by p.patient_id "
            + "union "
            + "Select p.patient_id,min(o.value_datetime) data_inicio from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and o.voided=0 and p.voided=0 and  e.encounter_type in (18,6,9,53) and o.concept_id=1190 and o.value_datetime <= :endDate and e.location_id=:location "
            + "group by p.patient_id "
            + "union "
            + "Select p.patient_id, min(pp.date_enrolled) data_inicio from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join patient_program pp on pp.patient_id = p.patient_id "
            + "where pe.voided=0 and p.voided=0 and pp.location_id=:location and pp.voided = 0 and pp.program_id = 2 "
            + "and pp.date_enrolled <= :endDate "
            + "group by p.patient_id "
            + "union "
            + "Select p.patient_id,min(e.encounter_datetime) data_inicio from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "where e.voided=0 and p.voided=0 and  e.encounter_type = 18 and e.encounter_datetime <= :endDate and e.location_id=:location "
            + "group by p.patient_id "
            + "union "
            + "Select p.patient_id,min(o.value_datetime) data_inicio from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and o.voided=0 and p.voided=0 and  e.encounter_type = 52 and o.concept_id=23866 and o.value_datetime <= :endDate and e.location_id=:location "
            + "group by p.patient_id "
            + ") inicio_real group by inicio_real.patient_id "
            + ") inicio on inicio.patient_id = coorte12meses_final.patient_id "
            + "where (data_estado is null or (data_estado is not null and  data_usar_c>data_estado)) and date_add(data_usar, interval 28 day) >=:endDate "
            + "and TIMESTAMPDIFF(MONTH, inicio.data_inicio, data_usar) > 5 "
            + ") inicio "
            + "inner join person p on p.person_id=inicio.patient_id "
            + "left join "
            + "(	select pad1.* "
            + "	from person_address pad1 "
            + "	inner join "
            + "	( "
            + "		select person_id,min(person_address_id) id "
            + "		from person_address "
            + "		where voided=0 "
            + "		group by person_id "
            + "	) pad2 "
            + "	where pad1.person_id=pad2.person_id and pad1.person_address_id=pad2.id "
            + ") pad3 on pad3.person_id=inicio.patient_id "
            + "left join "
            + "(	select pn1.* "
            + "	from person_name pn1 "
            + "	inner join "
            + "	( "
            + "		select person_id,min(person_name_id) id "
            + "		from person_name "
            + "		where voided=0 "
            + "		group by person_id "
            + "	) pn2 "
            + "	where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id "
            + ") pn on pn.person_id=inicio.patient_id "
            + "left join "
            + "(   select pid1.* "
            + "	from patient_identifier pid1 "
            + "	inner join "
            + "	( "
            + "		select patient_id,min(patient_identifier_id) id "
            + "		from patient_identifier "
            + "		where voided=0 "
            + "		group by patient_id "
            + "	) pid2 "
            + "	where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id "
            + ") pid on pid.patient_id=inicio.patient_id "
            + "left join ( "
            + "select person_id, value from person_attribute "
            + "where person_attribute_type_id = 9 "
            + "and voided = 0 "
            + ") pa on pa.person_id = inicio.patient_id "
            + " "
            + "inner join "
            + "( "
            + " "
            + "select patient_id, max(data_carga) data_carga, valor_carga from ( "
            + "select vlmenor1000.patient_id, vlmenor1000.data_carga, vlmenor1000.valor_carga from ( "
            + "select patient_id, max(data_maior) recent_date from ( "
            + "select "
            + "obs_fila.person_id patient_id,obs_fila.value_datetime data_maior "
            + "from "
            + "( "
            + "   select "
            + "   obs_fila.person_id, obs_fila.value_datetime, obs_fila.obs_datetime "
            + "   from obs obs_fila "
            + "   where obs_fila.voided=0 "
            + "   and obs_fila.concept_id=5096 "
            + "   and obs_fila.location_id=:location "
            + "   and obs_fila.value_datetime between :startDate "
            + "   and :endDate "
            + ") "
            + "obs_fila inner join "
            + "( "
            + "   Select "
            + "   p.patient_id, "
            + "   max(encounter_datetime) data_fila "
            + "   from patient p "
            + "   inner join encounter e on e.patient_id=p.patient_id "
            + "   where p.voided=0 "
            + "   and e.voided=0 "
            + "   and e.encounter_type=18 "
            + "   and e.location_id=:location "
            + "   and e.encounter_datetime<=:endDate "
            + "   group by p.patient_id "
            + ") "
            + "max_fila "
            + "on "
            + "( "
            + "   obs_fila.person_id=max_fila.patient_id "
            + "   and obs_fila.obs_datetime = max_fila.data_fila "
            + ") "
            + " union "
            + "select "
            + "obs_seguimento.person_id patient_id,obs_seguimento.value_datetime data_maior "
            + "from "
            + "( "
            + "   select "
            + "   obs_fila.person_id, obs_fila.value_datetime, obs_fila.obs_datetime "
            + "   from obs obs_fila "
            + "   where obs_fila.voided=0 "
            + "   and obs_fila.concept_id=1410 "
            + "   and obs_fila.location_id=:location "
            + "   and obs_fila.value_datetime between :startDate "
            + "   and :endDate "
            + ") "
            + "obs_seguimento inner join "
            + "( "
            + "   Select "
            + "   p.patient_id, "
            + "   max(encounter_datetime) data_seguimento "
            + "   from patient p "
            + "   inner join encounter e on e.patient_id=p.patient_id "
            + "   where p.voided=0 "
            + "   and e.voided=0 "
            + "   and e.encounter_type in (6,9) "
            + "   and e.location_id=:location "
            + "   and e.encounter_datetime<=:endDate "
            + "   group by p.patient_id "
            + ") "
            + "max_seguimento "
            + "on "
            + "( "
            + "   obs_seguimento.person_id=max_seguimento.patient_id "
            + "   and obs_seguimento.obs_datetime = max_seguimento.data_seguimento "
            + ") "
            + "union "
            + "select patient_id, date_add(data_recepcao_levantou, interval 30 day) data_maior from ( "
            + "Select 	p.patient_id,max(value_datetime) data_recepcao_levantou "
            + "	from 	patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "			o.concept_id=23866 and o.value_datetime is not null and "
            + "			o.value_datetime between :startDate and :endDate and e.location_id=:location "
            + "	group by p.patient_id "
            + "	) max_recepcao "
            + ") lastscheduled group by lastscheduled.patient_id "
            + " "
            + ") lastscheduled_final "
            + " "
            + "inner join ( "
            + " "
            + "select ultima_carga.patient_id,ultima_carga.data_carga,obs.value_numeric valor_carga,obs.concept_id,obs.value_coded from ( "
            + "Select p.patient_id,max(o.obs_datetime) data_carga from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9,13,51,53) and  o.concept_id in (856,1305) and  o.obs_datetime <= :endDate and e.location_id=:location group by p.patient_id) ultima_carga "
            + "inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga "
            + "where obs.voided=0 and ((obs.concept_id=856 and obs.value_numeric<1000) or (obs.concept_id=1305 and obs.value_coded in (1306,23814,23905,23906,23907,23908,23904)))  and obs.location_id=:location "
            + " "
            + ") vlmenor1000 on lastscheduled_final.patient_id=vlmenor1000.patient_id "
            + "where vlmenor1000.data_carga<=date_sub(lastscheduled_final.recent_date, interval 12 MONTH) "
            + " "
            + "union "
            + " "
            + " select vlmaiorigual1000.patient_id, vlmaiorigual1000.data_carga, vlmaiorigual1000.valor_carga from ( "
            + "select patient_id, max(data_maior) recent_date from ( "
            + "select "
            + "obs_fila.person_id patient_id,obs_fila.value_datetime data_maior "
            + "from "
            + "( "
            + "   select "
            + "   obs_fila.person_id, obs_fila.value_datetime, obs_fila.obs_datetime "
            + "   from obs obs_fila "
            + "   where obs_fila.voided=0 "
            + "   and obs_fila.concept_id=5096 "
            + "   and obs_fila.location_id=:location "
            + "   and obs_fila.value_datetime between :startDate "
            + "   and :endDate "
            + ") "
            + "obs_fila inner join "
            + "( "
            + "   Select "
            + "   p.patient_id, "
            + "   max(encounter_datetime) data_fila "
            + "   from patient p "
            + "   inner join encounter e on e.patient_id=p.patient_id "
            + "   where p.voided=0 "
            + "   and e.voided=0 "
            + "   and e.encounter_type=18 "
            + "   and e.location_id=:location "
            + "   and e.encounter_datetime<=:endDate "
            + "   group by p.patient_id "
            + ") "
            + "max_fila "
            + "on "
            + "( "
            + "   obs_fila.person_id=max_fila.patient_id "
            + "   and obs_fila.obs_datetime = max_fila.data_fila "
            + ") "
            + " union "
            + "select "
            + "obs_seguimento.person_id patient_id,obs_seguimento.value_datetime data_maior "
            + "from "
            + "( "
            + "   select "
            + "   obs_fila.person_id, obs_fila.value_datetime, obs_fila.obs_datetime "
            + "   from obs obs_fila "
            + "   where obs_fila.voided=0 "
            + "   and obs_fila.concept_id=1410 "
            + "   and obs_fila.location_id=:location "
            + "   and obs_fila.value_datetime between :startDate "
            + "   and :endDate "
            + ") "
            + "obs_seguimento inner join "
            + "( "
            + "   Select "
            + "   p.patient_id, "
            + "   max(encounter_datetime) data_seguimento "
            + "   from patient p "
            + "   inner join encounter e on e.patient_id=p.patient_id "
            + "   where p.voided=0 "
            + "   and e.voided=0 "
            + "   and e.encounter_type in (6,9) "
            + "   and e.location_id=:location "
            + "   and e.encounter_datetime<=:endDate "
            + "   group by p.patient_id "
            + ") "
            + "max_seguimento "
            + "on "
            + "( "
            + "   obs_seguimento.person_id=max_seguimento.patient_id "
            + "   and obs_seguimento.obs_datetime = max_seguimento.data_seguimento "
            + ") "
            + "union "
            + "select patient_id, date_add(data_recepcao_levantou, interval 30 day) data_maior from ( "
            + "Select 	p.patient_id,max(value_datetime) data_recepcao_levantou "
            + "	from 	patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "			o.concept_id=23866 and o.value_datetime is not null and "
            + "			o.value_datetime between :startDate and :endDate and e.location_id=:location "
            + "	group by p.patient_id "
            + "	) max_recepcao "
            + ") lastscheduled group by lastscheduled.patient_id "
            + " "
            + ") lastscheduled_final "
            + " "
            + "inner join ( "
            + " "
            + "select ultima_carga.patient_id,ultima_carga.data_carga,obs.value_numeric valor_carga,obs.concept_id,obs.value_coded from ( "
            + "Select p.patient_id,max(o.obs_datetime) data_carga from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9,13,51,53) and  o.concept_id in (856,1305) and  o.obs_datetime <= :endDate and e.location_id=:location group by p.patient_id) ultima_carga "
            + "inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga "
            + "where obs.voided=0 and ((obs.concept_id=856 and obs.value_numeric>=1000) or (obs.concept_id=1305 and obs.value_coded in (1306,23814,23905,23906,23907,23908,23904)))  and obs.location_id=:location "
            + " "
            + ") vlmaiorigual1000 on lastscheduled_final.patient_id=vlmaiorigual1000.patient_id "
            + "where vlmaiorigual1000.data_carga<=date_sub(lastscheduled_final.recent_date, interval 3 MONTH) "
            + " "
            + ") viral_load group by patient_id "
            + " "
            + ") vl_final on vl_final.patient_id = inicio.patient_id "
            + " "
            + "left join ( "
            + "SELECT patient_id, count(patient_id) sessoes FROM ( "
            + "select distinct apss.patient_id, apss.encounter_datetime, apss.encounter_id from ( "
            + "select ultima_carga.patient_id,ultima_carga.data_carga,obs.value_numeric valor_carga,obs.concept_id,obs.value_coded from ( "
            + "Select p.patient_id,max(o.obs_datetime) data_carga from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9,13,51,53) and  o.concept_id in (856,1305) and  o.obs_datetime <= :endDate and e.location_id=:location group by p.patient_id) ultima_carga "
            + "inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga "
            + "where obs.voided=0 and ((obs.concept_id=856 and obs.value_numeric>=1000) or (obs.concept_id=1305 and obs.value_coded in (1306,23814,23905,23906,23907,23908,23904)))  and obs.location_id=:location) carga_viral "
            + "inner join( "
            + "Select p.patient_id,e.encounter_datetime, e.encounter_id from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and e.encounter_type=35 and "
            + " e.encounter_datetime<=:endDate and e.location_id=:location "
            + ") apss on apss.patient_id = carga_viral.patient_id "
            + "where apss.encounter_datetime between carga_viral.data_carga and :endDate "
            + "order by apss.patient_id "
            + ") apss group by patient_id "
            + ") apss_final on apss_final.patient_id = inicio.patient_id "
            + "where inicio.patient_id not in ( "
            + "select patient_id from ( "
            + "Select p.patient_id, min(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsGravida.voided=0 and e.encounter_type in(5,6) and e.location_id=:location and "
            + "obsGravida.concept_id=1982 and obsGravida.value_coded=1065 and pe.gender='F' "
            + "and e.encounter_datetime between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, min(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsGravida.voided=0 and e.encounter_type in(5,6) and e.location_id=:location and "
            + "obsGravida.concept_id=1279 and pe.gender='F' "
            + "and e.encounter_datetime between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id,  min(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsGravida.voided=0 and e.encounter_type in(5,6) and e.location_id=:location and "
            + "obsGravida.concept_id=1600 and pe.gender='F' "
            + "and e.encounter_datetime between (:endDate - INTERVAL 18 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id,  min(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsGravida.voided=0 and e.encounter_type = 6 and e.location_id=:location and "
            + "obsGravida.concept_id=6334 and obsGravida.value_coded = 6331 and pe.gender='F' "
            + "and e.encounter_datetime between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, min(pp.date_enrolled) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join patient_program pp on pp.patient_id = p.patient_id "
            + "where pe.voided=0 and p.voided=0 and "
            + " pe.gender='F' and pp.location_id=:location and pp.voided = 0 and pp.program_id = 8 "
            + "and pp.date_enrolled between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + "   Select p.patient_id, min(obsGravida.value_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and o.voided=0 and obsGravida.voided=0 and e.encounter_type=53 and e.location_id=:location and "
            + "o.concept_id=1190 and "
            + "obsGravida.concept_id=1982 and obsGravida.value_coded=1065 and pe.gender='F' "
            + "and o.value_datetime between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by patient_id "
            + "union "
            + "   Select p.patient_id, min(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsGravida.voided=0 and e.encounter_type=6 and e.location_id=:location and "
            + "obsGravida.concept_id=1982 and obsGravida.value_coded=1065 and pe.gender='F' "
            + "and e.encounter_datetime between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + "   Select p.patient_id, min(obsGravida.value_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsGravida.voided=0 and e.encounter_type=6 and e.location_id=:location and "
            + "obsGravida.concept_id=1465 and pe.gender='F' "
            + "and obsGravida.value_datetime between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by patient_id "
            + ") pregnant "
            + ") and "
            + "inicio.patient_id not in ( "
            + "select patient_id from ( "
            + "Select p.patient_id, max(obsLactante.value_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsLactante on e.encounter_id=obsLactante.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsLactante.voided=0 and e.encounter_type in (5,6) and e.location_id=:location and "
            + "obsLactante.concept_id=5599 and obsLactante.value_datetime between (:endDate - INTERVAL 18 MONTH) and :endDate and pe.gender='F' "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, max(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsLactante on e.encounter_id=obsLactante.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsLactante.voided=0 and e.encounter_type = 6 and e.location_id=:location and "
            + "obsLactante.concept_id=6332 and obsLactante.value_coded = 1065 and e.encounter_datetime between (:endDate - INTERVAL 18 MONTH) and :endDate and pe.gender='F' "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, max(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "inner join obs obsLactante on e.encounter_id=obsLactante.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and o.voided=0 and obsLactante.voided=0 and e.encounter_type in (5,6) and e.location_id=:location and "
            + "o.concept_id=1190 and "
            + "obsLactante.concept_id=6334 and obsLactante.value_coded=6332 and pe.gender='F' "
            + "and e.encounter_datetime between (:endDate - INTERVAL 18 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, max(ps.start_date) "
            + "from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join patient_program pp on pp.patient_id = p.patient_id "
            + "inner join patient_state ps on ps.patient_program_id = pp.patient_program_id "
            + "where pe.voided=0 and p.voided=0 and "
            + " pe.gender='F' and pp.location_id=:location and pp.voided = 0 and pp.program_id = 8 "
            + " and ps.state = 27 "
            + "and ps.start_date between (:endDate - INTERVAL 18 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, max(o.value_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "inner join obs obsLactante on e.encounter_id=obsLactante.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and o.voided=0 and obsLactante.voided=0 and e.encounter_type = 53 and e.location_id=:location and "
            + "o.concept_id=1190 and "
            + "obsLactante.concept_id=6332 and obsLactante.value_coded=1065 and pe.gender='F' "
            + "and o.value_datetime between "
            + "(:endDate - INTERVAL 18 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, max(e.encounter_datetime) "
            + "encounter_datetime  from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsLactante on e.encounter_id=obsLactante.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsLactante.voided=0 and e.encounter_type = 6 and e.location_id=:location and "
            + "obsLactante.concept_id=6332 and obsLactante.value_coded=1065 and pe.gender='F' "
            + "and e.encounter_datetime between "
            + "(:endDate - INTERVAL 18 MONTH) and :endDate "
            + "group by p.patient_id "
            + ") lactante "
            + ") ";

    public static final String findPatientsEligibleToViralLoad =
        "	select inicio.patient_id "
            + "	from( "
            + "	select coorte12meses_final.patient_id, data_usar_c , data_usar, coorte12meses_final.data_inicio, regime_tarv , linha_terapeutica, data_seguimento, data_proximo_seguimento, data_fila, data_proximo_lev, data_recepcao_levantou, data_recepcao_levantou30 "
            + "	from "
            + "	(select   	inicio_fila_seg_prox.*, "
            + "			GREATEST(COALESCE(data_fila,data_seguimento,data_recepcao_levantou),COALESCE(data_seguimento,data_fila,data_recepcao_levantou),COALESCE(data_recepcao_levantou,data_seguimento,data_fila))  data_usar_c, "
            + "		    GREATEST(COALESCE(data_proximo_lev,data_proximo_seguimento,data_recepcao_levantou30),COALESCE(data_proximo_seguimento,data_proximo_lev,data_recepcao_levantou30),COALESCE(data_recepcao_levantou30,data_proximo_seguimento,data_proximo_lev)) data_usar, "
            + "		    regime regime_tarv, "
            + "		    linha linha_terapeutica "
            + "	from "
            + "		(select 	inicio_fila_seg.*, "
            + "		max(obs_fila.value_datetime) data_proximo_lev, "
            + "		max(obs_seguimento.value_datetime) data_proximo_seguimento, "
            + "		date_add(data_recepcao_levantou, interval 30 day) data_recepcao_levantou30, "
            + "		obs_regime.value_coded regime, "
            + "		obs_linha.value_coded linha "
            + "  from "
            + "(select inicio.*, "
            + "		saida.data_estado, "
            + "		max_fila.data_fila, "
            + "		max_consulta.data_seguimento, "
            + "		max_recepcao.data_recepcao_levantou "
            + " from "
            + " (	Select patient_id,min(data_inicio) data_inicio "
            + "		from "
            + "			( "
            + "				Select 	p.patient_id,min(e.encounter_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on o.encounter_id=e.encounter_id "
            + "				where 	e.voided=0 and o.voided=0 and p.voided=0 and "
            + "						e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and "
            + "						e.encounter_datetime<=:endDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "				union "
            + "				Select 	p.patient_id,min(value_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on e.encounter_id=o.encounter_id "
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and "
            + "						o.concept_id=1190 and o.value_datetime is not null and "
            + "						o.value_datetime<=:endDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "				union "
            + "				select 	pg.patient_id,min(date_enrolled) data_inicio "
            + "				from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id "
            + "				where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate and location_id=:location "
            + "				group by pg.patient_id "
            + "				union "
            + "				  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio "
            + "				  FROM 		patient p "
            + "							inner join encounter e on p.patient_id=e.patient_id "
            + "				  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location "
            + "				  GROUP BY 	p.patient_id "
            + "				union "
            + "				Select 	p.patient_id,min(value_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on e.encounter_id=o.encounter_id "
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "						o.concept_id=23866 and o.value_datetime is not null and "
            + "						o.value_datetime<=:endDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "			) inicio_real "
            + "		group by patient_id "
            + "  )inicio "
            + "  left join "
            + "	( "
            + "	select patient_id,max(data_estado) data_estado "
            + "	from "
            + "		( "
            + "			select 	pg.patient_id, "
            + "					max(ps.start_date) data_estado "
            + "			from 	patient p "
            + "					inner join patient_program pg on p.patient_id=pg.patient_id "
            + "					inner join patient_state ps on pg.patient_program_id=ps.patient_program_id "
            + "			where 	pg.voided=0 and ps.voided=0 and p.voided=0 and "
            + "					pg.program_id=2 and ps.state in (7,8,10) and ps.end_date is null and "
            + "					ps.start_date<=:endDate and location_id=:location "
            + "			group by pg.patient_id "
            + "			union "
            + "			select 	p.patient_id, "
            + "					max(o.obs_datetime) data_estado "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs  o on e.encounter_id=o.encounter_id "
            + "			where 	e.voided=0 and o.voided=0 and p.voided=0 and "
            + "					e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and "
            + "					o.obs_datetime<=:endDate and e.location_id=:location "
            + "			group by p.patient_id "
            + "			union "
            + "			select person_id as patient_id,death_date as data_estado "
            + "			from person "
            + "			where dead=1 and death_date is not null and death_date<=:endDate "
            + "			union "
            + "			select 	p.patient_id, "
            + "					max(obsObito.obs_datetime) data_estado "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs obsObito on e.encounter_id=obsObito.encounter_id "
            + "			where 	e.voided=0 and p.voided=0 and obsObito.voided=0 and "
            + "					e.encounter_type in (21,36,37) and  e.encounter_datetime<=:endDate and  e.location_id=:location and "
            + "					obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366 "
            + "			group by p.patient_id "
            + "			union "
            + "			select 	p.patient_id,max(e.encounter_datetime) data_estado "
            + "			from	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on o.encounter_id=e.encounter_id "
            + "			where 	e.voided=0 and p.voided=0 and e.encounter_datetime<=:endDate and "
            + "					o.voided=0 and o.concept_id=2016 and o.value_coded in (1706,23863) and e.encounter_type in (21,36,37) and  e.location_id=:location "
            + "			group by p.patient_id "
            + "		) allSaida "
            + "	group by patient_id "
            + "  ) saida on inicio.patient_id=saida.patient_id "
            + " left join "
            + "  ( Select p.patient_id,max(encounter_datetime) data_fila "
            + "	from 	patient p "
            + "			inner join encounter e on e.patient_id=p.patient_id "
            + "	where 	p.voided=0 and e.voided=0 and e.encounter_type=18 and "
            + "			e.location_id=:location and e.encounter_datetime<=:endDate "
            + "	group by p.patient_id "
            + " ) max_fila on inicio.patient_id=max_fila.patient_id "
            + "  left join "
            + "  (	Select 	p.patient_id,max(encounter_datetime) data_seguimento "
            + "	from 	patient p "
            + "			inner join encounter e on e.patient_id=p.patient_id "
            + "	where 	p.voided=0 and e.voided=0 and e.encounter_type in (6,9) and "
            + "			e.location_id=:location and e.encounter_datetime<=:endDate "
            + "	group by p.patient_id "
            + " ) max_consulta on inicio.patient_id=max_consulta.patient_id "
            + "  left join "
            + "  ( "
            + "	Select 	p.patient_id,max(value_datetime) data_recepcao_levantou "
            + "	from 	patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "			o.concept_id=23866 and o.value_datetime is not null and "
            + "			o.value_datetime between :startDate and :endDate and e.location_id=:location "
            + "	group by p.patient_id "
            + "  ) max_recepcao on inicio.patient_id=max_recepcao.patient_id "
            + "  group by inicio.patient_id "
            + " ) inicio_fila_seg "
            + "  left join "
            + "	 obs obs_fila on obs_fila.person_id=inicio_fila_seg.patient_id "
            + "   and obs_fila.voided=0 "
            + "	 and obs_fila.obs_datetime=inicio_fila_seg.data_fila "
            + "	 and obs_fila.concept_id=5096 "
            + "	 and obs_fila.location_id=:location "
            + "	 and obs_fila.value_datetime between :startDate and :endDate "
            + "  left join "
            + "	 obs obs_regime on obs_regime.person_id=inicio_fila_seg.patient_id "
            + "   and obs_regime.voided=0 "
            + "	 and obs_regime.obs_datetime=inicio_fila_seg.data_fila "
            + "	 and obs_regime.concept_id=1088 "
            + "	 and obs_regime.location_id=:location "
            + "  left join "
            + "	obs obs_seguimento on obs_seguimento.person_id=inicio_fila_seg.patient_id "
            + "	and obs_seguimento.voided=0 "
            + "	and obs_seguimento.obs_datetime=inicio_fila_seg.data_seguimento "
            + "	and obs_seguimento.concept_id=1410 "
            + "	and obs_seguimento.location_id=:location "
            + "	and obs_seguimento.value_datetime between :startDate and :endDate "
            + " left join "
            + "	obs obs_linha on obs_linha.person_id=inicio_fila_seg.patient_id "
            + "	and obs_linha.voided=0 "
            + "	and obs_linha.obs_datetime=inicio_fila_seg.data_seguimento "
            + "	and obs_linha.concept_id=21151 "
            + "	and obs_linha.location_id=:location "
            + " group by inicio_fila_seg.patient_id "
            + " ) inicio_fila_seg_prox "
            + " group by patient_id "
            + " ) coorte12meses_final "
            + "inner join "
            + "( "
            + "select patient_id, min(data_inicio) data_inicio from ( "
            + "Select p.patient_id,min(e.encounter_datetime) data_inicio from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and o.voided=0 and p.voided=0 and  e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and  e.encounter_datetime<='2021-06-01' and e.location_id=:location "
            + "group by p.patient_id "
            + "union "
            + "Select p.patient_id,min(o.value_datetime) data_inicio from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and o.voided=0 and p.voided=0 and  e.encounter_type in (18,6,9,53) and o.concept_id=1190 and o.value_datetime <= :endDate and e.location_id=:location "
            + "group by p.patient_id "
            + "union "
            + "Select p.patient_id, min(pp.date_enrolled) data_inicio from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join patient_program pp on pp.patient_id = p.patient_id "
            + "where pe.voided=0 and p.voided=0 and pp.location_id=:location and pp.voided = 0 and pp.program_id = 2 "
            + "and pp.date_enrolled <= :endDate "
            + "group by p.patient_id "
            + "union "
            + "Select p.patient_id,min(e.encounter_datetime) data_inicio from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "where e.voided=0 and p.voided=0 and  e.encounter_type = 18 and e.encounter_datetime <= :endDate and e.location_id=:location "
            + "group by p.patient_id "
            + "union "
            + "Select p.patient_id,min(o.value_datetime) data_inicio from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where e.voided=0 and o.voided=0 and p.voided=0 and  e.encounter_type = 52 and o.concept_id=23866 and o.value_datetime <= :endDate and e.location_id=:location "
            + "group by p.patient_id "
            + ") inicio_real group by inicio_real.patient_id "
            + ") inicio on inicio.patient_id = coorte12meses_final.patient_id "
            + "where (data_estado is null or (data_estado is not null and  data_usar_c>data_estado)) and date_add(data_usar, interval 28 day) >=:endDate "
            + "and TIMESTAMPDIFF(MONTH, inicio.data_inicio, data_usar) > 5 "
            + ") inicio "
            + "inner join person p on p.person_id=inicio.patient_id "
            + "left join "
            + "(	select pad1.* "
            + "	from person_address pad1 "
            + "	inner join "
            + "	( "
            + "		select person_id,min(person_address_id) id "
            + "		from person_address "
            + "		where voided=0 "
            + "		group by person_id "
            + "	) pad2 "
            + "	where pad1.person_id=pad2.person_id and pad1.person_address_id=pad2.id "
            + ") pad3 on pad3.person_id=inicio.patient_id "
            + "left join "
            + "(	select pn1.* "
            + "	from person_name pn1 "
            + "	inner join "
            + "	( "
            + "		select person_id,min(person_name_id) id "
            + "		from person_name "
            + "		where voided=0 "
            + "		group by person_id "
            + "	) pn2 "
            + "	where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id "
            + ") pn on pn.person_id=inicio.patient_id "
            + "left join "
            + "(   select pid1.* "
            + "	from patient_identifier pid1 "
            + "	inner join "
            + "	( "
            + "		select patient_id,min(patient_identifier_id) id "
            + "		from patient_identifier "
            + "		where voided=0 "
            + "		group by patient_id "
            + "	) pid2 "
            + "	where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id "
            + ") pid on pid.patient_id=inicio.patient_id "
            + "left join ( "
            + "select person_id, value from person_attribute "
            + "where person_attribute_type_id = 9 "
            + "and voided = 0 "
            + ") pa on pa.person_id = inicio.patient_id "
            + " "
            + "inner join "
            + "( "
            + " "
            + "select patient_id, max(data_carga) data_carga, valor_carga from ( "
            + "select vlmenor1000.patient_id, vlmenor1000.data_carga, vlmenor1000.valor_carga from ( "
            + "select patient_id, max(data_maior) recent_date from ( "
            + "select "
            + "obs_fila.person_id patient_id,obs_fila.value_datetime data_maior "
            + "from "
            + "( "
            + "   select "
            + "   obs_fila.person_id, obs_fila.value_datetime, obs_fila.obs_datetime "
            + "   from obs obs_fila "
            + "   where obs_fila.voided=0 "
            + "   and obs_fila.concept_id=5096 "
            + "   and obs_fila.location_id=:location "
            + "   and obs_fila.value_datetime between :startDate "
            + "   and :endDate "
            + ") "
            + "obs_fila inner join "
            + "( "
            + "   Select "
            + "   p.patient_id, "
            + "   max(encounter_datetime) data_fila "
            + "   from patient p "
            + "   inner join encounter e on e.patient_id=p.patient_id "
            + "   where p.voided=0 "
            + "   and e.voided=0 "
            + "   and e.encounter_type=18 "
            + "   and e.location_id=:location "
            + "   and e.encounter_datetime<=:endDate "
            + "   group by p.patient_id "
            + ") "
            + "max_fila "
            + "on "
            + "( "
            + "   obs_fila.person_id=max_fila.patient_id "
            + "   and obs_fila.obs_datetime = max_fila.data_fila "
            + ") "
            + " union "
            + "select "
            + "obs_seguimento.person_id patient_id,obs_seguimento.value_datetime data_maior "
            + "from "
            + "( "
            + "   select "
            + "   obs_fila.person_id, obs_fila.value_datetime, obs_fila.obs_datetime "
            + "   from obs obs_fila "
            + "   where obs_fila.voided=0 "
            + "   and obs_fila.concept_id=1410 "
            + "   and obs_fila.location_id=:location "
            + "   and obs_fila.value_datetime between :startDate "
            + "   and :endDate "
            + ") "
            + "obs_seguimento inner join "
            + "( "
            + "   Select "
            + "   p.patient_id, "
            + "   max(encounter_datetime) data_seguimento "
            + "   from patient p "
            + "   inner join encounter e on e.patient_id=p.patient_id "
            + "   where p.voided=0 "
            + "   and e.voided=0 "
            + "   and e.encounter_type in (6,9) "
            + "   and e.location_id=:location "
            + "   and e.encounter_datetime<=:endDate "
            + "   group by p.patient_id "
            + ") "
            + "max_seguimento "
            + "on "
            + "( "
            + "   obs_seguimento.person_id=max_seguimento.patient_id "
            + "   and obs_seguimento.obs_datetime = max_seguimento.data_seguimento "
            + ") "
            + "union "
            + "select patient_id, date_add(data_recepcao_levantou, interval 30 day) data_maior from ( "
            + "Select 	p.patient_id,max(value_datetime) data_recepcao_levantou "
            + "	from 	patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "			o.concept_id=23866 and o.value_datetime is not null and "
            + "			o.value_datetime between :startDate and :endDate and e.location_id=:location "
            + "	group by p.patient_id "
            + "	) max_recepcao "
            + ") lastscheduled group by lastscheduled.patient_id "
            + " "
            + ") lastscheduled_final "
            + " "
            + "inner join ( "
            + " "
            + "select ultima_carga.patient_id,ultima_carga.data_carga,obs.value_numeric valor_carga,obs.concept_id,obs.value_coded from ( "
            + "Select p.patient_id,max(o.obs_datetime) data_carga from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9,13,51,53) and  o.concept_id in (856,1305) and  o.obs_datetime <= :endDate and e.location_id=:location group by p.patient_id) ultima_carga "
            + "inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga "
            + "where obs.voided=0 and ((obs.concept_id=856 and obs.value_numeric<1000) or (obs.concept_id=1305 and obs.value_coded in (1306,23814,23905,23906,23907,23908,23904)))  and obs.location_id=:location "
            + " "
            + ") vlmenor1000 on lastscheduled_final.patient_id=vlmenor1000.patient_id "
            + "where vlmenor1000.data_carga<=date_sub(lastscheduled_final.recent_date, interval 12 MONTH) "
            + " "
            + "union "
            + " "
            + " select vlmaiorigual1000.patient_id, vlmaiorigual1000.data_carga, vlmaiorigual1000.valor_carga from ( "
            + "select patient_id, max(data_maior) recent_date from ( "
            + "select "
            + "obs_fila.person_id patient_id,obs_fila.value_datetime data_maior "
            + "from "
            + "( "
            + "   select "
            + "   obs_fila.person_id, obs_fila.value_datetime, obs_fila.obs_datetime "
            + "   from obs obs_fila "
            + "   where obs_fila.voided=0 "
            + "   and obs_fila.concept_id=5096 "
            + "   and obs_fila.location_id=:location "
            + "   and obs_fila.value_datetime between :startDate "
            + "   and :endDate "
            + ") "
            + "obs_fila inner join "
            + "( "
            + "   Select "
            + "   p.patient_id, "
            + "   max(encounter_datetime) data_fila "
            + "   from patient p "
            + "   inner join encounter e on e.patient_id=p.patient_id "
            + "   where p.voided=0 "
            + "   and e.voided=0 "
            + "   and e.encounter_type=18 "
            + "   and e.location_id=:location "
            + "   and e.encounter_datetime<=:endDate "
            + "   group by p.patient_id "
            + ") "
            + "max_fila "
            + "on "
            + "( "
            + "   obs_fila.person_id=max_fila.patient_id "
            + "   and obs_fila.obs_datetime = max_fila.data_fila "
            + ") "
            + " union "
            + "select "
            + "obs_seguimento.person_id patient_id,obs_seguimento.value_datetime data_maior "
            + "from "
            + "( "
            + "   select "
            + "   obs_fila.person_id, obs_fila.value_datetime, obs_fila.obs_datetime "
            + "   from obs obs_fila "
            + "   where obs_fila.voided=0 "
            + "   and obs_fila.concept_id=1410 "
            + "   and obs_fila.location_id=:location "
            + "   and obs_fila.value_datetime between :startDate "
            + "   and :endDate "
            + ") "
            + "obs_seguimento inner join "
            + "( "
            + "   Select "
            + "   p.patient_id, "
            + "   max(encounter_datetime) data_seguimento "
            + "   from patient p "
            + "   inner join encounter e on e.patient_id=p.patient_id "
            + "   where p.voided=0 "
            + "   and e.voided=0 "
            + "   and e.encounter_type in (6,9) "
            + "   and e.location_id=:location "
            + "   and e.encounter_datetime<=:endDate "
            + "   group by p.patient_id "
            + ") "
            + "max_seguimento "
            + "on "
            + "( "
            + "   obs_seguimento.person_id=max_seguimento.patient_id "
            + "   and obs_seguimento.obs_datetime = max_seguimento.data_seguimento "
            + ") "
            + "union "
            + "select patient_id, date_add(data_recepcao_levantou, interval 30 day) data_maior from ( "
            + "Select 	p.patient_id,max(value_datetime) data_recepcao_levantou "
            + "	from 	patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "			o.concept_id=23866 and o.value_datetime is not null and "
            + "			o.value_datetime between :startDate and :endDate and e.location_id=:location "
            + "	group by p.patient_id "
            + "	) max_recepcao "
            + ") lastscheduled group by lastscheduled.patient_id "
            + " "
            + ") lastscheduled_final "
            + " "
            + "inner join ( "
            + " "
            + "select ultima_carga.patient_id,ultima_carga.data_carga,obs.value_numeric valor_carga,obs.concept_id,obs.value_coded from ( "
            + "Select p.patient_id,max(o.obs_datetime) data_carga from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9,13,51,53) and  o.concept_id in (856,1305) and  o.obs_datetime <= :endDate and e.location_id=:location group by p.patient_id) ultima_carga "
            + "inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga "
            + "where obs.voided=0 and ((obs.concept_id=856 and obs.value_numeric>=1000) or (obs.concept_id=1305 and obs.value_coded in (1306,23814,23905,23906,23907,23908,23904)))  and obs.location_id=:location "
            + " "
            + ") vlmaiorigual1000 on lastscheduled_final.patient_id=vlmaiorigual1000.patient_id "
            + "where vlmaiorigual1000.data_carga<=date_sub(lastscheduled_final.recent_date, interval 3 MONTH) "
            + " "
            + ") viral_load group by patient_id "
            + " "
            + ") vl_final on vl_final.patient_id = inicio.patient_id "
            + " "
            + "left join ( "
            + "SELECT patient_id, count(patient_id) sessoes FROM ( "
            + "select distinct apss.patient_id, apss.encounter_datetime, apss.encounter_id from ( "
            + "select ultima_carga.patient_id,ultima_carga.data_carga,obs.value_numeric valor_carga,obs.concept_id,obs.value_coded from ( "
            + "Select p.patient_id,max(o.obs_datetime) data_carga from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9,13,51,53) and  o.concept_id in (856,1305) and  o.obs_datetime <= :endDate and e.location_id=:location group by p.patient_id) ultima_carga "
            + "inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga "
            + "where obs.voided=0 and ((obs.concept_id=856 and obs.value_numeric>=1000) or (obs.concept_id=1305 and obs.value_coded in (1306,23814,23905,23906,23907,23908,23904)))  and obs.location_id=:location) carga_viral "
            + "inner join( "
            + "Select p.patient_id,e.encounter_datetime, e.encounter_id from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and e.encounter_type=35 and "
            + " e.encounter_datetime<=:endDate and e.location_id=:location "
            + ") apss on apss.patient_id = carga_viral.patient_id "
            + "where apss.encounter_datetime between carga_viral.data_carga and :endDate "
            + "order by apss.patient_id "
            + ") apss group by patient_id "
            + ") apss_final on apss_final.patient_id = inicio.patient_id "
            + "where inicio.patient_id not in ( "
            + "select patient_id from ( "
            + "Select p.patient_id, min(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsGravida.voided=0 and e.encounter_type in(5,6) and e.location_id=:location and "
            + "obsGravida.concept_id=1982 and obsGravida.value_coded=1065 and pe.gender='F' "
            + "and e.encounter_datetime between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, min(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsGravida.voided=0 and e.encounter_type in(5,6) and e.location_id=:location and "
            + "obsGravida.concept_id=1279 and pe.gender='F' "
            + "and e.encounter_datetime between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id,  min(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsGravida.voided=0 and e.encounter_type in(5,6) and e.location_id=:location and "
            + "obsGravida.concept_id=1600 and pe.gender='F' "
            + "and e.encounter_datetime between (:endDate - INTERVAL 18 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id,  min(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsGravida.voided=0 and e.encounter_type = 6 and e.location_id=:location and "
            + "obsGravida.concept_id=6334 and obsGravida.value_coded = 6331 and pe.gender='F' "
            + "and e.encounter_datetime between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, min(pp.date_enrolled) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join patient_program pp on pp.patient_id = p.patient_id "
            + "where pe.voided=0 and p.voided=0 and "
            + " pe.gender='F' and pp.location_id=:location and pp.voided = 0 and pp.program_id = 8 "
            + "and pp.date_enrolled between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + "   Select p.patient_id, min(obsGravida.value_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and o.voided=0 and obsGravida.voided=0 and e.encounter_type=53 and e.location_id=:location and "
            + "o.concept_id=1190 and "
            + "obsGravida.concept_id=1982 and obsGravida.value_coded=1065 and pe.gender='F' "
            + "and o.value_datetime between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by patient_id "
            + "union "
            + "   Select p.patient_id, min(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsGravida.voided=0 and e.encounter_type=6 and e.location_id=:location and "
            + "obsGravida.concept_id=1982 and obsGravida.value_coded=1065 and pe.gender='F' "
            + "and e.encounter_datetime between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + "   Select p.patient_id, min(obsGravida.value_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsGravida on e.encounter_id=obsGravida.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsGravida.voided=0 and e.encounter_type=6 and e.location_id=:location and "
            + "obsGravida.concept_id=1465 and pe.gender='F' "
            + "and obsGravida.value_datetime between (:endDate - INTERVAL 9 MONTH) and :endDate "
            + "group by patient_id "
            + ") pregnant "
            + ") and "
            + "inicio.patient_id not in ( "
            + "select patient_id from ( "
            + "Select p.patient_id, max(obsLactante.value_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsLactante on e.encounter_id=obsLactante.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsLactante.voided=0 and e.encounter_type in (5,6) and e.location_id=:location and "
            + "obsLactante.concept_id=5599 and obsLactante.value_datetime between (:endDate - INTERVAL 18 MONTH) and :endDate and pe.gender='F' "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, max(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsLactante on e.encounter_id=obsLactante.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsLactante.voided=0 and e.encounter_type = 6 and e.location_id=:location and "
            + "obsLactante.concept_id=6332 and obsLactante.value_coded = 1065 and e.encounter_datetime between (:endDate - INTERVAL 18 MONTH) and :endDate and pe.gender='F' "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, max(e.encounter_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "inner join obs obsLactante on e.encounter_id=obsLactante.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and o.voided=0 and obsLactante.voided=0 and e.encounter_type in (5,6) and e.location_id=:location and "
            + "o.concept_id=1190 and "
            + "obsLactante.concept_id=6334 and obsLactante.value_coded=6332 and pe.gender='F' "
            + "and e.encounter_datetime between (:endDate - INTERVAL 18 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, max(ps.start_date) "
            + "from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join patient_program pp on pp.patient_id = p.patient_id "
            + "inner join patient_state ps on ps.patient_program_id = pp.patient_program_id "
            + "where pe.voided=0 and p.voided=0 and "
            + " pe.gender='F' and pp.location_id=:location and pp.voided = 0 and pp.program_id = 8 "
            + " and ps.state = 27 "
            + "and ps.start_date between (:endDate - INTERVAL 18 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, max(o.value_datetime) from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "inner join obs obsLactante on e.encounter_id=obsLactante.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and o.voided=0 and obsLactante.voided=0 and e.encounter_type = 53 and e.location_id=:location and "
            + "o.concept_id=1190 and "
            + "obsLactante.concept_id=6332 and obsLactante.value_coded=1065 and pe.gender='F' "
            + "and o.value_datetime between "
            + "(:endDate - INTERVAL 18 MONTH) and :endDate "
            + "group by p.patient_id "
            + "union "
            + " Select p.patient_id, max(e.encounter_datetime) "
            + "encounter_datetime  from person pe "
            + "inner join patient p on pe.person_id=p.patient_id "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs obsLactante on e.encounter_id=obsLactante.encounter_id "
            + "where pe.voided=0 and p.voided=0 and e.voided=0 and obsLactante.voided=0 and e.encounter_type = 6 and e.location_id=:location and "
            + "obsLactante.concept_id=6332 and obsLactante.value_coded=1065 and pe.gender='F' "
            + "and e.encounter_datetime between "
            + "(:endDate - INTERVAL 18 MONTH) and :endDate "
            + "group by p.patient_id "
            + ") lactante "
            + ") ";
  }
}
