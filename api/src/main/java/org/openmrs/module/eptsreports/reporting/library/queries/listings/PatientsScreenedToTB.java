package org.openmrs.module.eptsreports.reporting.library.queries.listings;

/** @author Abdul Sacur */
public interface PatientsScreenedToTB {

  public String findPatientsScreendToTB =
      ""
          + "select 	consulta.patient_id,\n"
          + "		consulta.data_consulta,\n"
          + "        consulta.ultimo_seguimento,\n"
          + "        consulta.prox_consulta,\n"
          + "        if(consulta.BK is not null,'Sim','') BK,\n"
          + "        if(consulta.GeneExpert is not null,'Sim','') GeneExpert,\n"
          + "        if(consulta.RaioX is not null,'Sim','') RaioX,\n"
          + "		if(consulta.Cultura is not null,'Sim','') Cultura,\n"
          + "        if(consulta.TbLam is not null,'Sim','') TbLam,\n"
          + "		if(tb.patient_id is not null,'Sim','') tuberculose,\n"
          + "        tb.data_inicio_tb,\n"
          + "		concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) nome,\n"
          + "		pid.identifier as NID\n"
          + "		\n"
          + "		\n"
          + "		\n"
          + "from 		\n"
          + "(\n"
          + "	Select 	ultimConsulta.patient_id,\n"
          + "			ultimConsulta.encounter_datetime data_consulta,\n"
          + "            BK.patient_id as BK,\n"
          + "            GeneExpert.patient_id as GeneExpert,\n"
          + "            RaioX.patient_id as RaioX,\n"
          + "            Cultura.patient_id as Cultura,\n"
          + "            TbLam.patient_id as TbLam,\n"
          + "            ultimo_seguimento.data_seguimento as ultimo_seguimento,\n"
          + "            prox_seg.data_prox as prox_consulta\n"
          + "           \n"
          + "			\n"
          + "	from\n"
          + "		(	select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
          + "			from 	patient p				 \n"
          + "					inner join encounter e on p.patient_id=e.patient_id \n"
          + "					inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=23758 and obsScreen.value_coded=1065 and obsScreen.voided=0  \n"
          + "			where 	e.voided=0 and p.voided=0 and e.encounter_type=6 and e.location_id=:location and \n"
          + "					e.encounter_datetime between :startDate and :endDate\n"
          + "			group by p.patient_id\n"
          + "            \n"
          + "            union\n"
          + "		-- Paciente com Qualquer Resposta na Opção de Observacao ao TB\n"
          + "            select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
          + "			from 	patient p				 \n"
          + "					inner join encounter e on p.patient_id=e.patient_id \n"
          + "					inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=1766 and obsScreen.voided=0  \n"
          + "			where 	e.voided=0 and p.voided=0 and e.encounter_type=6 and e.location_id=:location and \n"
          + "					e.encounter_datetime between :startDate and :endDate\n"
          + "			group by p.patient_id\n"
          + "            \n"
          + "            union\n"
          + "            select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
          + "			from 	patient p				 \n"
          + "					inner join encounter e on p.patient_id=e.patient_id \n"
          + "					inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=23761 and obsScreen.value_coded=1065 and obsScreen.voided=0  \n"
          + "			where 	e.voided=0 and p.voided=0 and e.encounter_type=6 and e.location_id=:location and \n"
          + "					e.encounter_datetime between :startDate and :endDate\n"
          + "			group by p.patient_id\n"
          + "            \n"
          + "            union\n"
          + "            \n"
          + "			select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
          + "			\n"
          + "			from 	patient p				 \n"
          + "					inner join encounter e on p.patient_id=e.patient_id \n"
          + "					inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=23722 and \n"
          + "                    obsScreen.value_coded in (23723,12,307,23774,23951) and  obsScreen.voided=0  \n"
          + "			where 	e.voided=0 and p.voided=0 and e.encounter_type=6 and e.location_id=:location and \n"
          + "					e.encounter_datetime between :startDate and :endDate\n"
          + "			group by p.patient_id\n"
          + "            \n"
          + "            union\n"
          + "            	select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
          + "			\n"
          + "			from 	patient p				 \n"
          + "					inner join encounter e on p.patient_id=e.patient_id \n"
          + "					inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and\n"
          + "                    obsScreen.concept_id in (23723,12,307,23774,23951) and obsScreen.voided=0  \n"
          + "			where 	e.voided=0 and p.voided=0 and e.encounter_type in ( 6,13) and e.location_id=:location and \n"
          + "					e.encounter_datetime between :startDate and :endDate\n"
          + "			group by p.patient_id\n"
          + "		) ultimConsulta\n"
          + "\n"
          + "       left join\n"
          + "      \n"
          + "		(\n"
          + "			select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
          + "			from 	patient p				 \n"
          + "					inner join encounter e on p.patient_id=e.patient_id \n"
          + "					inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=23722 and \n"
          + "                    obsScreen.value_coded = 307 and  obsScreen.voided=0 \n"
          + "			where 	e.voided=0 and p.voided=0 and e.encounter_type=6 and e.location_id=:location and \n"
          + "					e.encounter_datetime between :startDate and :endDate\n"
          + "			group by p.patient_id\n"
          + "       ) BK ON BK.patient_id = ultimConsulta.patient_id and ultimConsulta.encounter_datetime = BK.encounter_datetime\n"
          + "       \n"
          + "         left join\n"
          + "      \n"
          + "		(\n"
          + "			select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
          + "			from 	patient p				 \n"
          + "					inner join encounter e on p.patient_id=e.patient_id \n"
          + "					inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=23722 and \n"
          + "                    obsScreen.value_coded = 23723 and  obsScreen.voided=0 \n"
          + "			where 	e.voided=0 and p.voided=0 and e.encounter_type=6 and e.location_id=:location and \n"
          + "					e.encounter_datetime between :startDate and :endDate\n"
          + "			group by p.patient_id\n"
          + "       ) GeneExpert ON GeneExpert.patient_id = ultimConsulta.patient_id and ultimConsulta.encounter_datetime = GeneExpert.encounter_datetime\n"
          + "       \n"
          + "       left join\n"
          + "       (\n"
          + "			select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
          + "			from 	patient p				 \n"
          + "					inner join encounter e on p.patient_id=e.patient_id \n"
          + "					inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=23722 and \n"
          + "                    obsScreen.value_coded = 12 and  obsScreen.voided=0 \n"
          + "			where 	e.voided=0 and p.voided=0 and e.encounter_type=6 and e.location_id=:location and \n"
          + "					e.encounter_datetime between :startDate and :endDate\n"
          + "			group by p.patient_id\n"
          + "       ) RaioX ON RaioX.patient_id = ultimConsulta.patient_id and ultimConsulta.encounter_datetime = RaioX.encounter_datetime\n"
          + "       \n"
          + "        left join\n"
          + "       (\n"
          + "			select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
          + "			from 	patient p				 \n"
          + "					inner join encounter e on p.patient_id=e.patient_id \n"
          + "					inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=23722 and \n"
          + "                    obsScreen.value_coded = 23774 and  obsScreen.voided=0 \n"
          + "			where 	e.voided=0 and p.voided=0 and e.encounter_type=6 and e.location_id=:location and \n"
          + "					e.encounter_datetime between :startDate and :endDate\n"
          + "			group by p.patient_id\n"
          + "       ) Cultura ON Cultura.patient_id = ultimConsulta.patient_id and ultimConsulta.encounter_datetime = Cultura.encounter_datetime\n"
          + "		\n"
          + "         left join\n"
          + "       (\n"
          + "			select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
          + "			from 	patient p				 \n"
          + "					inner join encounter e on p.patient_id=e.patient_id \n"
          + "					inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=23722 and \n"
          + "                    obsScreen.value_coded = 23951 and  obsScreen.voided=0 \n"
          + "			where 	e.voided=0 and p.voided=0 and e.encounter_type=6 and e.location_id=:location and \n"
          + "					e.encounter_datetime between :startDate and :endDate\n"
          + "			group by p.patient_id\n"
          + "       ) TbLam ON TbLam.patient_id = ultimConsulta.patient_id and ultimConsulta.encounter_datetime = TbLam.encounter_datetime\n"
          + "       \n"
          + "       left join\n"
          + "        \n"
          + "          (  \n"
          + "			Select p.patient_id,max(encounter_datetime) data_seguimento\n"
          + "			from patient p\n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			where p.voided=0 and e.voided=0 and e.encounter_type in (6,9) and\n"
          + "			e.location_id=:location and e.encounter_datetime<=:endDate\n"
          + "			group by p.patient_id\n"
          + "			) ultimo_seguimento on ultimConsulta.patient_id=ultimo_seguimento.patient_id\n"
          + "		\n"
          + "        left join\n"
          + "        \n"
          + "        (\n"
          + "			SELECT value_datetime data_prox, person_id FROM obs o \n"
          + "		INNER JOIN\n"
          + "\n"
          + "		(	Select p.patient_id,max( e.encounter_id) as encontro, max(obsScreen.obs_id) as obsId\n"
          + "			from patient p\n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "            inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=1410  \n"
          + "			where p.voided=0 and e.voided=0 and e.encounter_type in (6,9) and\n"
          + "			e.location_id=:location and e.encounter_datetime between :startDate and :endDate\n"
          + "			group by p.patient_id )  data_seguimento\n"
          + "            \n"
          + "		ON o.person_id =  data_seguimento.patient_id\n"
          + "		where o.encounter_id = data_seguimento.encontro AND o.obs_id =  data_seguimento.obsId\n"
          + "         \n"
          + "         ) prox_seg on ultimConsulta.patient_id=prox_seg.person_id\n"
          + "      -- Aqui temos excluimos os transferidos para e tiramos os que inciaram a TB estes vao ser encontrados com a query de rastreio\n"
          + "        left join (\n"
          + "        SELECT transferidos.patient_id FROM \n"
          + "				(select 	pg.patient_id,																												\n"
          + "             					max(ps.start_date) data_estado																								\n"
          + "             			from 	patient p																													\n"
          + "             					inner join patient_program pg on p.patient_id=pg.patient_id																	\n"
          + "             					inner join patient_state ps on pg.patient_program_id=ps.patient_program_id													\n"
          + "             			where 	pg.voided=0 and ps.voided=0 and p.voided=0 and 																				\n"
          + "             					pg.program_id=2 and ps.state in (7) and ps.end_date is null and 														\n"
          + "             					ps.start_date between :startDate and :endDate and location_id=:location																			\n"
          + "             			group by pg.patient_id																												\n"
          + "             			union																																\n"
          + "            /* Estado no estado de permanencia da Ficha Resumo, Ficha Clinica */\n"
          + "             			select 	p.patient_id,																												\n"
          + "             					max(o.obs_datetime) data_estado																								\n"
          + "             			from 	patient p																													\n"
          + "             					inner join encounter e on p.patient_id=e.patient_id																			\n"
          + "             					inner join obs  o on e.encounter_id=o.encounter_id																			\n"
          + "             			where 	e.voided=0 and o.voided=0 and p.voided=0 and																				\n"
          + "             					e.encounter_type in (53,6) and o.concept_id = 6273 and o.value_coded = (1706) and  						\n"
          + "             					o.obs_datetime between :startDate and :endDate and e.location_id=:location																		\n"
          + "             			group by p.patient_id ) transferidos\n"
          + "                        \n"
          + "                        LEFT JOIN \n"
          + "								(	\n"
          + "                                select 	p.patient_id, min(o.obs_datetime) data_inicio_tb\n"
          + "									from 	patient p\n"
          + "											inner join encounter e on p.patient_id=e.patient_id\n"
          + "											inner join obs o on o.encounter_id=e.encounter_id\n"
          + "									where 	e.encounter_type in (6,9) and e.voided=0 and o.voided=0 and p.voided=0 and\n"
          + "											o.concept_id=1268 and o.value_coded = 1256 and e.location_id=:location and \n"
          + "											e.encounter_datetime  between :startDate and :endDate \n"
          + "											group by patient_id\n"
          + "									union\n"
          + "									\n"
          + "									select 	patient_id,date_enrolled data_inicio_tb\n"
          + "									from 	patient_program\n"
          + "									where	program_id=5 and voided=0 and date_enrolled between :startDate and :endDate and\n"
          + "											location_id=:location\n"
          + "		) inicio1  on inicio1.patient_id = transferidos.patient_id where inicio1.patient_id is null\n"
          + "					\n"
          + "                        )transferidos on ultimConsulta.patient_id=transferidos.patient_id \n"
          + "       \n"
          + ") consulta\n"
          + "inner join \n"
          + "(	Select patient_id,min(data_inicio) data_inicio\n"
          + "	from\n"
          + "		(	\n"
          + "		-- Patients on ART who initiated the ARV DRUGS: ART Regimen Start Date/\n"
          + "\n"
          + "		Select 	p.patient_id,min(e.encounter_datetime) data_inicio\n"
          + "		from 	patient p \n"
          + "				inner join encounter e on p.patient_id=e.patient_id	\n"
          + "				inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where 	e.voided=0 and o.voided=0 and p.voided=0 and \n"
          + "				e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and \n"
          + "				e.encounter_datetime<=:endDate  and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		-- Patients on ART who have art start date: ART Start date/\n"
          + "		Select 	p.patient_id,min(value_datetime) data_inicio\n"
          + "		from 	patient p\n"
          + "				inner join encounter e on p.patient_id=e.patient_id\n"
          + "				inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and \n"
          + "				o.concept_id=1190 and o.value_datetime is not null and \n"
          + "				o.value_datetime<=:endDate  and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		-- Patients enrolled in ART Program: OpenMRS Program/\n"
          + "		select 	pg.patient_id,min(date_enrolled) data_inicio\n"
          + "		from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate  and location_id=:location\n"
          + "		group by pg.patient_id\n"
          + "		\n"
          + "		union\n"
          + "		\n"
          + "		\n"
          + "		-- Patients with first drugs pick up date set in Pharmacy: First ART Start Date/\n"
          + "		  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio \n"
          + "		  FROM 		patient p\n"
          + "					inner join encounter e on p.patient_id=e.patient_id\n"
          + "		  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=:endDate  and e.location_id=:location\n"
          + "		  GROUP BY 	p.patient_id\n"
          + "	  \n"
          + "		union\n"
          + "		\n"
          + "		-- Patients with first drugs pick up date set: Recepcao Levantou ARV/\n"
          + "		Select 	p.patient_id,min(value_datetime) data_inicio\n"
          + "		from 	patient p\n"
          + "				inner join encounter e on p.patient_id=e.patient_id\n"
          + "				inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and \n"
          + "				o.concept_id=23866 and o.value_datetime is not null and \n"
          + "				o.value_datetime<=:endDate  and e.location_id=:location\n"
          + "		group by p.patient_id								\n"
          + "				\n"
          + "		) inicio\n"
          + "	group by patient_id	\n"
          + ") inicio_real on consulta.patient_id=inicio_real.patient_id\n"
          + "inner join person per on per.person_id=consulta.patient_id \n"
          + "left join 	\n"
          + "(\n"
          + "	select patient_id,max(data_estado) data_estado\n"
          + "	from \n"
          + "	(\n"
          + "		-- Estado no programa\n"
          + "		select 	pg.patient_id,\n"
          + "				max(ps.start_date) data_estado\n"
          + "		from 	patient p \n"
          + "				inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "				inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "		where 	pg.voided=0 and ps.voided=0 and p.voided=0 and \n"
          + "				pg.program_id=2 and ps.state in (7,8,10) and ps.end_date is null and \n"
          + "				ps.start_date<=:endDate  and location_id=:location\n"
          + "		group by pg.patient_id\n"
          + "		\n"
          + "		union\n"
          + "		\n"
          + "		-- Estadono estado de permanencia da Ficha Resumo, Ficha Clinica/\n"
          + "		select 	p.patient_id,\n"
          + "				max(o.obs_datetime) data_estado\n"
          + "		from 	patient p \n"
          + "				inner join encounter e on p.patient_id=e.patient_id\n"
          + "				inner join obs  o on e.encounter_id=o.encounter_id\n"
          + "		where 	e.voided=0 and o.voided=0 and p.voided=0 and \n"
          + "				e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and  \n"
          + "				o.obs_datetime<=:endDate  and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "		\n"
          + "		union\n"
          + "		\n"
          + "		-- Obito demografico/\n"
          + "		\n"
          + "		select person_id as patient_id,death_date as data_estado\n"
          + "		from person \n"
          + "		where dead=1 and death_date is not null and death_date<=:endDate \n"
          + "				\n"
          + "		union\n"
          + "		\n"
          + "		-- Obito na ficha de busca/\n"
          + "		select 	p.patient_id,\n"
          + "				max(obsObito.obs_datetime) data_estado\n"
          + "		from 	patient p \n"
          + "				inner join encounter e on p.patient_id=e.patient_id\n"
          + "				inner join obs obsObito on e.encounter_id=obsObito.encounter_id\n"
          + "		where 	e.voided=0 and p.voided=0 and obsObito.voided=0 and \n"
          + "				e.encounter_type in (21,36,37) and  e.encounter_datetime<=:endDate  and  e.location_id=:location and \n"
          + "				obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366	\n"
          + "		group by p.patient_id\n"
          + "		\n"
          + "		\n"
          + "		\n"
          + "	) allSaida\n"
          + "	group by patient_id			\n"
          + ") saida on consulta.patient_id=saida.patient_id\n"
          + "left join\n"
          + " \n"
          + "( select inicio1.patient_id,\n"
          + "		inicio1.data_inicio_tb\n"
          + "	FROM \n"
          + "		(	select 	p.patient_id, min(o.obs_datetime) data_inicio_tb\n"
          + "			from 	patient p\n"
          + "					inner join encounter e on p.patient_id=e.patient_id\n"
          + "					inner join obs o on o.encounter_id=e.encounter_id\n"
          + "			where 	e.encounter_type in (6,9) and e.voided=0 and o.voided=0 and p.voided=0 and\n"
          + "					o.concept_id=1268 and o.value_coded = 1256 and e.location_id=:location and \n"
          + "					e.encounter_datetime  between :startDate and :endDate \n"
          + "                    group by patient_id\n"
          + "			union\n"
          + "			\n"
          + "			select 	patient_id,date_enrolled data_inicio_tb\n"
          + "			from 	patient_program\n"
          + "			where	program_id=5 and voided=0 and date_enrolled between :startDate and :endDate and\n"
          + "					location_id=:location\n"
          + "		) inicio1\n"
          + "		\n"
          + "        LEFT JOIN\n"
          + "        \n"
          + "        	\n"
          + "		(	select 	p.patient_id, min(o.obs_datetime) data_inicio_tb\n"
          + "			from 	patient p\n"
          + "					inner join encounter e on p.patient_id=e.patient_id\n"
          + "					inner join obs o on o.encounter_id=e.encounter_id\n"
          + "			where 	e.encounter_type in (6,9) and e.voided=0 and o.voided=0 and p.voided=0 and\n"
          + "					o.concept_id=1268 and o.value_coded = 1256 and e.location_id=:location and \n"
          + "					e.encounter_datetime between  (:startDate  - INTERVAL 6 MONTH ) and date_add(:startDate, interval -1 DAY) \n"
          + "                    group by patient_id\n"
          + "			union\n"
          + "			\n"
          + "			select 	patient_id,date_enrolled data_inicio_tb\n"
          + "			from 	patient_program\n"
          + "			where	program_id=5 and voided=0 and date_enrolled between  (:startDate  - INTERVAL 6 MONTH ) and date_add(:startDate, interval -1 DAY) and\n"
          + "					location_id=:location\n"
          + "		) previousTb\n"
          + "		on inicio1.patient_id = previousTb.patient_id  where previousTb.patient_id  is null) tb on consulta.patient_id=tb.patient_id\n"
          + " left join \n"
          + "	(	select pid1.*\n"
          + "		from patient_identifier pid1\n"
          + "		inner join \n"
          + "			(\n"
          + "				select patient_id,min(patient_identifier_id) id \n"
          + "				from patient_identifier\n"
          + "				where voided=0\n"
          + "				group by patient_id\n"
          + "			) pid2\n"
          + "		where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
          + "	) pid on pid.patient_id=consulta.patient_id\n"
          + "	left join \n"
          + "	(	select pn1.*\n"
          + "		from person_name pn1\n"
          + "		inner join \n"
          + "			(\n"
          + "				select person_id,min(person_name_id) id \n"
          + "				from person_name\n"
          + "				where voided=0\n"
          + "				group by person_id\n"
          + "			) pn2\n"
          + "		where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
          + "	) pn on pn.person_id=consulta.patient_id\n"
          + "    group by consulta.patient_id";
}
