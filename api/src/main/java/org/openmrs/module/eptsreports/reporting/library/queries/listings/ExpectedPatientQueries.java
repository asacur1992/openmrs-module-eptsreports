/** */
package org.openmrs.module.eptsreports.reporting.library.queries.listings;

/** @author St√©lio Moiane */
public interface ExpectedPatientQueries {

  class QUERY {
    public static final String findExpectedPatientsList =
        "  SELECT p.patient_id, pi.identifier, CONCAT(pn.given_name, ' ', COALESCE(pn.middle_name, ''))name, pn.family_name, pe.gender, (YEAR( :endDate) - YEAR(pe.birthdate)) age, \n"
            + "             	start_art.art_start_date, expected.expected_date, scheduled_follow_up.scheduled_followup_date, scheduled_pick_up.scheduled_pick_up_date, follow_up_before.followup_date, \n"
            + "             	pick_up.pick_up_date,  carga_viral.data_carga, ultima_cv.Valor_carga,\n"
            + "             	gaac_model.mds_gaac, af_model.mds_af, ca_model.mds_ca, pu_model.mds_pu, fr_model.mds_fr, dt_model.mds_dt, dc_model.mds_dc, ds_model.mds_ds, patient_contact.patient_contact, \n"
            + "             	confident.confident_contact, patient_sector.sector_clinic, start_tpi.start_tpi_date, end_tpi.end_tpi_date, pickup_tpi.pickup_tpi_date FROM patient p\n"
            + "             	INNER JOIN patient_identifier pi ON p.patient_id = pi.patient_id\n"
            + "             	INNER JOIN person_name pn ON pn.person_id = p.patient_id\n"
            + "             	INNER JOIN person pe ON pe.person_id = p.patient_id\n"
            + "             	INNER JOIN (\n"
            + "                     SELECT patient_id, MIN(art_start_date) art_start_date FROM\n"
            + "                         (	\n"
            + "             				SELECT p.patient_id,MIN(e.encounter_datetime) art_start_date FROM patient p \n"
            + "             					INNER JOIN encounter e ON p.patient_id=e.patient_id	\n"
            + "             					INNER JOIN obs o on o.encounter_id=e.encounter_id \n"
            + "             						WHERE e.voided=0 AND o.voided=0 AND p.voided=0 \n"
            + "             						AND e.encounter_type IN (18,6,9) AND o.concept_id=1255 AND o.value_coded=1256 \n"
            + "             						AND e.encounter_datetime<= :endDate AND e.location_id = :location\n"
            + "             							GROUP BY p.patient_id\n"
            + "             				UNION\n"
            + "             		\n"
            + "             				SELECT p.patient_id,MIN(value_datetime) art_start_date FROM patient p\n"
            + "             					INNER JOIN encounter e ON p.patient_id=e.patient_id\n"
            + "             					INNER JOIN obs o ON e.encounter_id=o.encounter_id\n"
            + "             						WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND e.encounter_type in (18,6,9,53) \n"
            + "             						AND o.concept_id=1190 AND o.value_datetime is NOT NULL \n"
            + "             						AND o.value_datetime<= :endDate AND e.location_id = :location\n"
            + "             							GROUP BY p.patient_id\n"
            + "             				\n"
            + "             				UNION\n"
            + "             \n"
            + "             				SELECT pg.patient_id,MIN(date_enrolled) art_start_date FROM patient p \n"
            + "             					INNER JOIN patient_program pg ON p.patient_id=pg.patient_id\n"
            + "             						WHERE pg.voided=0 AND p.voided=0 AND program_id=2 AND date_enrolled<= :endDate AND pg.location_id = :location\n"
            + "             							GROUP BY pg.patient_id\n"
            + "             				\n"
            + "             				UNION\n"
            + "             				\n"
            + "             				SELECT e.patient_id, MIN(e.encounter_datetime) AS art_start_date FROM patient p\n"
            + "             					INNER JOIN encounter e ON p.patient_id=e.patient_id\n"
            + "             				  		WHERE p.voided=0 and e.encounter_type=18 AND e.voided=0 AND e.encounter_datetime<= :endDate AND e.location_id = :location\n"
            + "             				  			GROUP BY p.patient_id\n"
            + "             			  \n"
            + "             				UNION\n"
            + "             				\n"
            + "             				SELECT p.patient_id,MIN(value_datetime) art_start_date FROM patient p\n"
            + "             					INNER JOIN encounter e ON p.patient_id=e.patient_id\n"
            + "             					INNER JOIN obs o ON e.encounter_id=o.encounter_id\n"
            + "             						WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND e.encounter_type=52 \n"
            + "             						AND o.concept_id=23866 and o.value_datetime is NOT NULL \n"
            + "             						AND o.value_datetime<= :endDate AND e.location_id = :location\n"
            + "             							GROUP BY p.patient_id	\n"
            + "             	\n"
            + "             		)min_art_start_date GROUP BY min_art_start_date.patient_id\n"
            + "             	\n"
            + "             	)start_art ON start_art.patient_id = p.patient_id\n"
            + "             	INNER JOIN (\n"
            + "                     SELECT max_expected.patient_id, MAX(expected_date) expected_date FROM (\n"
            + "             \n"
            + "                         SELECT o.person_id patient_id, MAX(o.value_datetime) expected_date FROM obs o\n"
            + "                             INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "                                 WHERE o.concept_id = 1410 AND e.encounter_type IN(6,9) \n"
            + "                                 AND o.voided = 0 AND e.voided = 0 AND e.location_id = :location\n"
            + "                                     GROUP BY o.person_id\n"
            + "                         UNION\n"
            + "             \n"
            + "                         SELECT o.person_id patient_id, MAX(o.value_datetime) expected_date FROM obs o\n"
            + "                             INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "                                 WHERE o.concept_id = 5096 AND e.encounter_type = 18 \n"
            + "                                 AND o.voided = 0 AND e.voided = 0 AND e.location_id = :location\n"
            + "                                     GROUP BY o.person_id\n"
            + "                         UNION\n"
            + "             \n"
            + "                         SELECT o.person_id patient_id, MAX((o.value_datetime + INTERVAL 28 DAY)) expected_date FROM obs o\n"
            + "                             INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "                                 WHERE o.concept_id = 23866 AND e.encounter_type = 52 \n"
            + "                                 AND o.voided = 0 AND e.voided = 0 AND e.location_id = :location\n"
            + "                                     GROUP BY o.person_id\n"
            + "             \n"
            + "                         )max_expected GROUP BY max_expected.patient_id\n"
            + "             				HAVING expected_date BETWEEN :startDate  AND :endDate \n"
            + "             	)expected ON expected.patient_id = p.patient_id\n"
            + "             \n"
            + "             	LEFT JOIN (\n"
            + "             		SELECT o.person_id patient_id, o.value_datetime scheduled_followup_date, e.encounter_datetime FROM obs o\n"
            + "             		 INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "             		     WHERE o.concept_id = 1410 AND e.encounter_type IN(6,9) \n"
            + "             		     AND o.voided = 0 AND e.voided = 0 AND e.location_id = :location\n"
            + "             		     AND o.value_datetime BETWEEN :startDate  AND :endDate\n"
            + "             		         GROUP BY o.person_id\n"
            + "             	)scheduled_follow_up ON scheduled_follow_up.patient_id = p.patient_id AND scheduled_follow_up.scheduled_followup_date = expected.expected_date\n"
            + "             \n"
            + "             	LEFT JOIN (\n"
            + "             	\n"
            + "             		 SELECT o.person_id patient_id, o.value_datetime scheduled_pick_up_date, e.encounter_datetime FROM obs o\n"
            + "                             INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "                                 WHERE o.concept_id = 5096 AND e.encounter_type = 18 \n"
            + "                                 AND o.voided = 0 AND e.voided = 0 AND e.location_id = :location\n"
            + "                                 AND o.value_datetime BETWEEN :startDate  AND :endDate\n"
            + "                                     GROUP BY o.person_id\n"
            + "                         UNION\n"
            + "             \n"
            + "                         SELECT o.person_id patient_id, (o.value_datetime  + INTERVAL 28 DAY) scheduled_pick_up_date, e.encounter_datetime FROM obs o\n"
            + "                             INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "                                 WHERE o.concept_id = 23866 AND e.encounter_type = 52 \n"
            + "                                 AND o.voided = 0 AND e.voided = 0 AND e.location_id = :location\n"
            + "                                 AND (o.value_datetime + INTERVAL 28 DAY) BETWEEN :startDate  AND :endDate\n"
            + "                                     GROUP BY o.person_id\n"
            + "             	)scheduled_pick_up ON scheduled_pick_up.patient_id = p.patient_id AND scheduled_pick_up.scheduled_pick_up_date = expected.expected_date\n"
            + "             \n"
            + "             	LEFT JOIN(\n"
            + "             		SELECT e.patient_id, MAX(e.encounter_datetime) followup_date FROM encounter e\n"
            + "             		     WHERE e.encounter_type IN(6,9) AND e.voided = 0 AND e.location_id = :location\n"
            + "             		         GROUP BY e.patient_id\n"
            + "             	)follow_up_before ON follow_up_before.patient_id = p.patient_id AND follow_up_before.followup_date > scheduled_follow_up.encounter_datetime AND follow_up_before.followup_date <= scheduled_follow_up.scheduled_followup_date\n"
            + "             \n"
            + "             	LEFT JOIN (\n"
            + "             		SELECT max_pick_up.patient_id, MAX(pick_up_date) pick_up_date  FROM (\n"
            + "             			SELECT e.patient_id, MAX(e.encounter_datetime) pick_up_date FROM encounter e\n"
            + "             			     WHERE e.encounter_type = 18 AND e.voided = 0 AND e.location_id = :location\n"
            + "             			         GROUP BY e.patient_id\n"
            + "             			 UNION\n"
            + "             	\n"
            + "             			  SELECT o.person_id patient_id, MAX(o.value_datetime) pick_up_date FROM obs o\n"
            + "             	                INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "             	                    WHERE o.concept_id = 23866 AND e.encounter_type = 52 \n"
            + "             	                    AND o.voided = 0 AND e.voided = 0 AND e.location_id = :location\n"
            + "             	                        GROUP BY o.person_id\n"
            + "             		)max_pick_up GROUP BY max_pick_up.patient_id\n"
            + "             		 \n"
            + "             	)pick_up ON pick_up.patient_id = p.patient_id AND pick_up.pick_up_date > scheduled_pick_up.encounter_datetime AND pick_up.pick_up_date <= scheduled_pick_up.scheduled_pick_up_date\n"
            + "             \n"
            + "                left join\n"
            + "                \n"
            + "										(\n"
            + "						Select p.patient_id,max(o.obs_datetime) data_carga\n"
            + "						from patient p\n"
            + "									 inner join encounter e on p.patient_id=e.patient_id\n"
            + "									 inner join obs o on e.encounter_id=o.encounter_id\n"
            + "								where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9,53,13,51) and  \n"
            + "						o.concept_id in (856,1305) and  o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and\n"
            + "						e.location_id=:location\n"
            + "						group by p.patient_id\n"
            + "\n"
            + "						) carga_viral on carga_viral.patient_id=p.patient_id\n"
            + "						left join\n"
            + "						(\n"
            + "						select 	\n"
            + "								carga_viral.patient_id, \n"
            + "								carga_viral.Valor_carga,\n"
            + "								carga_viral.data_carga\n"
            + "								\n"
            + "								\n"
            + "\n"
            + "						from 	\n"
            + "						(\n"
            + "							 select ultima_carga.patient_id,ultima_carga.data_carga,\n"
            + "							 if(obs.value_numeric is null or obs.value_numeric<0,'Indetectavel',obs.value_numeric)  Valor_carga, \n"
            + "									ultima_carga.encounter_type,\n"
            + "									obs.creator,\n"
            + "									obs.date_created data_registo\n"
            + "							 from 		\n"
            + "								( \n"
            + "									Select p.patient_id,max(o.obs_datetime) data_carga, e.encounter_type\n"
            + "									from 	patient p \n"
            + "											inner join encounter e on p.patient_id=e.patient_id \n"
            + "											inner join obs o on e.encounter_id=o.encounter_id \n"
            + "									where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,51,6,9) and  o.concept_id in (856,1305) and  \n"
            + "											o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and e.location_id=:location\n"
            + "									group by p.patient_id\n"
            + "								) ultima_carga \n"
            + "									inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga \n"
            + "								where obs.voided=0 and ((obs.concept_id=856) or obs.concept_id=1305)  and obs.location_id=:location\n"
            + "						) carga_viral\n"
            + "						inner join encounter_type et on et.encounter_type_id=carga_viral.encounter_type\n"
            + "						group by carga_viral.patient_id) ultima_cv on ultima_cv.patient_id=p.patient_id and ultima_cv.data_carga =carga_viral.data_carga\n"
            + "             \n"
            + "             	LEFT JOIN (		\n"
            + "             		SELECT o.person_id patient_id, IF(MAX(o.obs_datetime) IS NOT NULL, 'GA', NULL ) mds_gaac FROM obs o\n"
            + "             			INNER JOIN encounter e ON o.encounter_id = e.encounter_id\n"
            + "             				WHERE o.voided = 0 AND e.voided = 0 AND concept_id = 23724 \n"
            + "             				AND value_coded IN (1256, 1257) AND o.obs_datetime <= :endDate AND e.location_id = :location\n"
            + "             					GROUP BY o.person_id\n"
            + "             	)gaac_model ON gaac_model.patient_id = p.patient_id\n"
            + "             \n"
            + "             	LEFT JOIN (		\n"
            + "             		SELECT o.person_id patient_id, IF(MAX(o.obs_datetime) IS NOT NULL, 'AF', NULL ) mds_af FROM obs o\n"
            + "             			INNER JOIN encounter e ON o.encounter_id = e.encounter_id\n"
            + "             				WHERE o.voided = 0 AND e.voided = 0 AND concept_id = 23725\n"
            + "             				AND value_coded IN (1256, 1257) AND o.obs_datetime <= :endDate AND e.location_id = :location\n"
            + "             					GROUP BY o.person_id\n"
            + "             	)af_model ON af_model.patient_id = p.patient_id\n"
            + "             \n"
            + "             	LEFT JOIN (		\n"
            + "             		SELECT o.person_id patient_id, IF(MAX(o.obs_datetime) IS NOT NULL, 'CA', NULL ) mds_ca FROM obs o\n"
            + "             			INNER JOIN encounter e ON o.encounter_id = e.encounter_id\n"
            + "             				WHERE o.voided = 0 AND e.voided = 0 AND concept_id = 23726\n"
            + "             				AND value_coded IN (1256, 1257) AND o.obs_datetime <= :endDate AND e.location_id = :location\n"
            + "             					GROUP BY o.person_id\n"
            + "             	)ca_model ON ca_model.patient_id = p.patient_id\n"
            + "             \n"
            + "             	LEFT JOIN (		\n"
            + "             		SELECT o.person_id patient_id, IF(MAX(o.obs_datetime) IS NOT NULL, 'PU', NULL ) mds_pu FROM obs o\n"
            + "             			INNER JOIN encounter e ON o.encounter_id = e.encounter_id\n"
            + "             				WHERE o.voided = 0 AND e.voided = 0 AND concept_id = 23727\n"
            + "             				AND value_coded IN (1256, 1257) AND o.obs_datetime <= :endDate AND e.location_id = :location\n"
            + "             					GROUP BY o.person_id\n"
            + "             	)pu_model ON pu_model.patient_id = p.patient_id\n"
            + "             \n"
            + "             	LEFT JOIN (		\n"
            + "             		SELECT o.person_id patient_id, IF(MAX(o.obs_datetime) IS NOT NULL, 'FR', NULL ) mds_fr FROM obs o\n"
            + "             			INNER JOIN encounter e ON o.encounter_id = e.encounter_id\n"
            + "             				WHERE o.voided = 0 AND e.voided = 0 AND concept_id = 23729\n"
            + "             				AND value_coded IN (1256, 1257) AND o.obs_datetime <= :endDate AND e.location_id = :location\n"
            + "             					GROUP BY o.person_id\n"
            + "             	)fr_model ON fr_model.patient_id = p.patient_id\n"
            + "             \n"
            + "             	LEFT JOIN (		\n"
            + "             		SELECT o.person_id patient_id, IF(MAX(o.obs_datetime) IS NOT NULL, 'DT', NULL ) mds_dt FROM obs o\n"
            + "             			INNER JOIN encounter e ON o.encounter_id = e.encounter_id\n"
            + "             				WHERE o.voided = 0 AND e.voided = 0 AND concept_id = 23730\n"
            + "             				AND value_coded IN (1256, 1257) AND o.obs_datetime <= :endDate AND e.location_id = :location\n"
            + "             					GROUP BY o.person_id\n"
            + "             	)dt_model ON dt_model.patient_id = p.patient_id\n"
            + "             \n"
            + "             	LEFT JOIN (		\n"
            + "             		SELECT o.person_id patient_id, IF(MAX(o.obs_datetime) IS NOT NULL, 'DC', NULL ) mds_dc FROM obs o\n"
            + "             			INNER JOIN encounter e ON o.encounter_id = e.encounter_id\n"
            + "             				WHERE o.voided = 0 AND e.voided = 0 AND concept_id = 23731\n"
            + "             				AND value_coded IN (1256, 1257) AND o.obs_datetime <= :endDate AND e.location_id = :location\n"
            + "             					GROUP BY o.person_id\n"
            + "             	)dc_model ON dc_model.patient_id = p.patient_id\n"
            + "             \n"
            + "             	LEFT JOIN (		\n"
            + "             		SELECT o.person_id patient_id, IF(MAX(o.obs_datetime) IS NOT NULL, 'DS', NULL ) mds_ds FROM obs o\n"
            + "             			INNER JOIN encounter e ON o.encounter_id = e.encounter_id\n"
            + "             				WHERE o.voided = 0 AND e.voided = 0 AND concept_id = 23888\n"
            + "             				AND value_coded IN (1256, 1257) AND o.obs_datetime <= :endDate AND e.location_id = :location\n"
            + "             					GROUP BY o.person_id\n"
            + "             	)ds_model ON ds_model.patient_id = p.patient_id\n"
            + "             \n"
            + "             	LEFT JOIN (\n"
            + "             		SELECT pa.person_id patient_id, pa.value patient_contact FROM person_attribute pa\n"
            + "             	         WHERE pa.person_attribute_type_id = 9\n"
            + "             	         GROUP BY pa.person_id\n"
            + "             	)patient_contact ON patient_contact.patient_id = p.patient_id\n"
            + "             \n"
            + "             	LEFT JOIN (\n"
            + "             		SELECT max_confident.patient_id, max_confident.max_contat, confident_contact.confident_contact FROM (\n"
            + "             			SELECT o.person_id patient_id, MAX(o.obs_datetime) max_contat FROM obs o\n"
            + "             			INNER JOIN encounter e ON o.encounter_id = e.encounter_id\n"
            + "             				WHERE o.voided = 0 AND e.voided = 0 AND o.concept_id IN(1611,6224) AND e.encounter_type IN (21,34,53)\n"
            + "             				AND o.obs_datetime <= :endDate AND e.location_id = :location\n"
            + "             					GROUP BY o.person_id\n"
            + "             		)max_confident \n"
            + "             		\n"
            + "             		INNER JOIN (\n"
            + "             			SELECT o.person_id patient_id, o.obs_datetime, o.value_text confident_contact FROM obs o\n"
            + "             				INNER JOIN encounter e ON o.encounter_id = e.encounter_id\n"
            + "             					WHERE o.voided = 0 AND e.voided = 0 AND o.concept_id IN(1611,6224) AND e.encounter_type IN (21,34,53)\n"
            + "             					AND o.obs_datetime <= :endDate AND e.location_id = :location\n"
            + "             						GROUP BY o.person_id\n"
            + "             		)confident_contact ON confident_contact.patient_id = max_confident.patient_id AND confident_contact.obs_datetime = max_confident.max_contat\n"
            + "             		GROUP BY max_confident.patient_id\n"
            + "             	\n"
            + "             	)confident ON confident.patient_id = p.patient_id\n"
            + "             \n"
            + "             	LEFT JOIN (\n"
            + "             		SELECT last_sector_clinic.patient_id,last_sector_clinic.encounter_datetime, last_sector_value.obs_datetime, last_sector_value.concept_id, last_sector_value.value_coded,\n"
            + "             		CASE\n"
            + "             			WHEN concept_id = 1982 AND value_coded = 1065 THEN 'CPN/G'\n"
            + "             			WHEN concept_id = 6332 AND value_coded = 1065 THEN 'CCR/L'\n"
            + "             			WHEN concept_id = 1268 AND value_coded IN (1256,1257) THEN 'TB'\n"
            + "             		ELSE null END AS sector_clinic FROM (\n"
            + "             			SELECT e.patient_id, MAX(e.encounter_datetime) encounter_datetime FROM encounter e \n"
            + "             				WHERE e.voided = 0 AND e.encounter_type IN (6,9) \n"
            + "             					AND e.encounter_datetime <= :endDate\n"
            + "             	 					GROUP BY e.patient_id\n"
            + "             			)last_sector_clinic\n"
            + "             			INNER JOIN (\n"
            + "             				SELECT o.person_id patient_id, o.obs_datetime, o.concept_id, o.value_coded, o.encounter_id FROM obs o\n"
            + "             						WHERE o.voided = 0 AND o.concept_id IN(1268, 6332, 1982) \n"
            + "             							AND o.value_coded IN (1065, 1256, 1257)\n"
            + "             							AND o.obs_datetime <= :endDate\n"
            + "             			)last_sector_value ON last_sector_value.patient_id = last_sector_clinic.patient_id \n"
            + "             				AND last_sector_clinic.encounter_datetime = last_sector_value.obs_datetime \n"
            + "             					GROUP BY last_sector_clinic.patient_id\n"
            + "             	)patient_sector ON patient_sector.patient_id = p.patient_id\n"
            + "             	LEFT JOIN (\n"
            + "             		SELECT min_start_tpi_date.patient_id, MIN(start_tpi_date) start_tpi_date FROM (\n"
            + "             			SELECT o.person_id patient_id, MIN(o.obs_datetime) start_tpi_date FROM obs o\n"
            + "             				INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "             					WHERE o.voided = 0 AND e.voided = 0 AND o.concept_id = 6122 AND o.value_coded = 1256\n"
            + "             					AND e.encounter_type IN (6,9) AND o.obs_datetime <= :endDate\n"
            + "             						GROUP BY o.person_id\n"
            + "             \n"
            + "             			UNION\n"
            + "             				\n"
            + "             			SELECT o.person_id patient_id, MIN(o.value_datetime) start_tpi_date FROM obs o\n"
            + "             				INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "             					WHERE o.voided = 0 AND e.voided = 0 AND o.concept_id = 6128\n"
            + "             					AND e.encounter_type IN (6,9,53) AND o.value_datetime <= :endDate\n"
            + "             						GROUP BY o.person_id\n"
            + "             				\n"
            + "             		)min_start_tpi_date GROUP BY min_start_tpi_date.patient_id\n"
            + "             \n"
            + "             	)start_tpi ON start_tpi.patient_id = p.patient_id\n"
            + "             	LEFT JOIN (\n"
            + "             \n"
            + "             		SELECT max_end_tpi_date.patient_id, MAX(end_tpi_date) end_tpi_date FROM (\n"
            + "             			SELECT o.person_id patient_id, MAX(o.obs_datetime) end_tpi_date FROM obs o\n"
            + "             				INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "             					WHERE o.voided = 0 AND e.voided = 0 AND o.concept_id = 6122 AND o.value_coded = 1267\n"
            + "             					AND e.encounter_type IN (6,9) AND o.obs_datetime <= :endDate\n"
            + "             						GROUP BY o.person_id\n"
            + "             \n"
            + "             			UNION\n"
            + "             				\n"
            + "             			SELECT o.person_id patient_id, MAX(o.value_datetime) end_tpi_date FROM obs o\n"
            + "             				INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "             					WHERE o.voided = 0 AND e.voided = 0 AND o.concept_id = 6129\n"
            + "             					AND e.encounter_type IN (6,9,53) AND o.value_datetime <= :endDate\n"
            + "             						GROUP BY o.person_id\n"
            + "             				\n"
            + "             		)max_end_tpi_date GROUP BY max_end_tpi_date.patient_id\n"
            + "             	)end_tpi ON end_tpi.patient_id = p.patient_id\n"
            + "             	LEFT JOIN (\n"
            + "             		\n"
            + "             		SELECT max_pickup_tpi_date.patient_id, MAX(pickup_tpi_date) pickup_tpi_date FROM (\n"
            + "             			SELECT o.person_id patient_id, MAX(o.obs_datetime) pickup_tpi_date FROM obs o\n"
            + "             				INNER JOIN encounter e ON e.encounter_id = o.encounter_id\n"
            + "             					WHERE o.voided = 0 AND e.voided = 0 AND o.concept_id = 6122 AND o.value_coded = 1257\n"
            + "             					AND e.encounter_type = 6 AND o.obs_datetime <= :endDate\n"
            + "             						GROUP BY o.person_id\n"
            + "             \n"
            + "             			UNION\n"
            + "             				\n"
            + "             			SELECT e.patient_id, MAX(e.encounter_datetime) pickup_tpi_date FROM encounter e\n"
            + "             					WHERE e.voided = 0 AND e.encounter_type = 60 AND e.encounter_datetime <= :endDate\n"
            + "             						GROUP BY e.patient_id\n"
            + "             				\n"
            + "             		)max_pickup_tpi_date GROUP BY max_pickup_tpi_date.patient_id\n"
            + "             	)pickup_tpi ON pickup_tpi.patient_id = p.patient_id\n"
            + "             WHERE p.voided = 0 AND pi.voided = 0 AND pi.identifier_type = 2 AND pn.voided = 0 AND pe.voided = 0\n"
            + "             	GROUP BY p.patient_id\n"
            + "             	ORDER BY pi.identifier ";
  }
}
