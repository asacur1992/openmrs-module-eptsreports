package org.openmrs.module.eptsreports.reporting.library.queries;

import org.openmrs.module.eptsreports.reporting.utils.EptsQuerysUtils;

public interface TxPvlsQueriesInterface {

  class QUERY {

    private static final String
        FIND_WOMAN_STATE_WHO_HAVE_MORE_THAN_3MONTHS_ON_ART_WITH_VIRALLOAD_REGISTERED_IN_THELAST12MONTHS =
            "PVLS/FIND_WOMAN_STATE_WHO_HAVE_MORE_THAN_3MONTHS_ON_ART_WITH_VIRALLOAD_REGISTERED_IN_THELAST12MONTHS.sql";

    public enum WomanState {
      PREGNANT,
      BREASTFEEDING;
    }

    public static final String
        findPatientsWhoHaveMoreThan3MonthsOnArtWithViralLoadRegisteredInTheLast12Months =
            "select inicio_real.patient_id from (select inicio_real.patient_id from (select patient_id,min(data_inicio) data_inicio from ( "
                + "select p.patient_id,min(e.encounter_datetime) data_inicio from patient p inner join encounter e on p.patient_id=e.patient_id inner join obs o on o.encounter_id=e.encounter_id "
                + "where e.voided=0 and o.voided=0 and p.voided=0 and e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and e.encounter_datetime > '0000-00-00 00:00' and  e.encounter_datetime<=:endDate and e.location_id=:location group by p.patient_id "
                + "union "
                + "Select p.patient_id,min(value_datetime) data_inicio from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on e.encounter_id=o.encounter_id "
                + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and o.concept_id=1190 and o.value_datetime is not null and o.value_datetime > '0000-00-00 00:00' and  o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id "
                + "union "
                + "select pg.patient_id,min(date_enrolled) data_inicio from patient p "
                + "inner join patient_program pg on p.patient_id=pg.patient_id "
                + "where pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled > '0000-00-00 00:00' and date_enrolled<=:endDate and location_id=:location group by pg.patient_id "
                + "union "
                + "SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio  FROM patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "WHERE p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime > '0000-00-00 00:00' and e.encounter_datetime<=:endDate and e.location_id=:location GROUP BY 	p.patient_id "
                + "union "
                + "Select p.patient_id,min(value_datetime) data_inicio from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on e.encounter_id=o.encounter_id "
                + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and  o.concept_id=23866 and o.value_datetime is not null and o.value_datetime > '0000-00-00 00:00' and o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id) inicio group by patient_id "
                + "union "
                + "select  max_estado.patient_id,data_estado "
                + "from( "
                + "  select pg.patient_id, "
                + "      max(ps.start_date) data_estado "
                + "    from  patient p "
                + "      inner join patient_program pg on p.patient_id = pg.patient_id "
                + "      inner join patient_state ps on pg.patient_program_id = ps.patient_program_id "
                + "    where pg.voided=0 and ps.voided=0 and p.voided=0  and pg.program_id = 2 "
                + "      and ps.start_date>=:startDate and  ps.start_date< :endDate and pg.location_id =:location group by pg.patient_id "
                + "    ) "
                + "max_estado "
                + "  inner join patient_program pp on pp.patient_id = max_estado.patient_id "
                + "  inner join patient_state ps on ps.patient_program_id = pp.patient_program_id and ps.start_date = max_estado.data_estado "
                + "where pp.program_id = 2 and ps.state = 29 and pp.voided = 0 and ps.voided = 0 and pp.location_id = :location "
                + "union "
                + "select transferido_de.patient_id,data_estado "
                + "from( "
                + "  select p.patient_id, max(obsOpenDate.value_datetime) data_estado from patient p "
                + "    inner join encounter e on p.patient_id=e.patient_id "
                + "    inner join obs obsTransIn on e.encounter_id= obsTransIn.encounter_id "
                + "    inner join obs obsOpenDate on e.encounter_id= obsOpenDate.encounter_id "
                + "    inner join obs obsInTarv on e.encounter_id= obsInTarv.encounter_id "
                + "   where e.voided=0 and obsTransIn.voided=0 and p.voided=0  and obsOpenDate.voided =0 and obsInTarv.voided =0 "
                + "    and e.encounter_type=53 and obsTransIn.concept_id=1369 and obsTransIn.value_coded=1065 "
                + "    and obsOpenDate.concept_id=23891 and obsOpenDate.value_datetime is not null "
                + "    and obsInTarv.concept_id=6300 and obsInTarv.value_coded=6276 "
                + "    and obsOpenDate.value_datetime >=:startDate and obsOpenDate.value_datetime < :endDate and e.location_id=:location group by p.patient_id "
                + ") transferido_de "
                + ") inicio_real "
                + "inner join ( "
                + "Select p.patient_id,max(o.obs_datetime) data_carga from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on e.encounter_id=o.encounter_id "
                + "where p.voided=0 and e.voided=0 and o.voided=0 and "
                + "e.encounter_type in (13,6,9,53,51) and  o.concept_id in (856,1305) and o.obs_datetime > '0000-00-00 00:00' and  o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and e.location_id=:location group by p.patient_id) carga_viral on inicio_real.patient_id=carga_viral.patient_id "
                + "where carga_viral.data_carga>=date_add(inicio_real.data_inicio, interval 90 DAY)) inicio_real "
                + "left join ( "
                + "select  max_estado.patient_id "
                + "from( "
                + "  select pg.patient_id, "
                + "      max(ps.start_date) data_estado "
                + "    from  patient p "
                + "      inner join patient_program pg on p.patient_id = pg.patient_id "
                + "      inner join patient_state ps on pg.patient_program_id = ps.patient_program_id "
                + "    where pg.voided=0 and ps.voided=0 and p.voided=0  and pg.program_id = 2 "
                + "      and ps.start_date> :endDate and pg.location_id =:location group by pg.patient_id "
                + "    ) "
                + "max_estado "
                + "  inner join patient_program pp on pp.patient_id = max_estado.patient_id "
                + "  inner join patient_state ps on ps.patient_program_id = pp.patient_program_id and ps.start_date = max_estado.data_estado "
                + "where pp.program_id = 2 and ps.state = 29 and pp.voided = 0 and ps.voided = 0 and pp.location_id = :location "
                + "union "
                + "select transferido_de.patient_id "
                + "from( "
                + "  select p.patient_id, max(obsOpenDate.value_datetime) data_estado from patient p "
                + "    inner join encounter e on p.patient_id=e.patient_id "
                + "    inner join obs obsTransIn on e.encounter_id= obsTransIn.encounter_id "
                + "    inner join obs obsOpenDate on e.encounter_id= obsOpenDate.encounter_id "
                + "    inner join obs obsInTarv on e.encounter_id= obsInTarv.encounter_id "
                + "   where e.voided=0 and obsTransIn.voided=0 and p.voided=0  and obsOpenDate.voided =0 and obsInTarv.voided =0 "
                + "    and e.encounter_type=53 and obsTransIn.concept_id=1369 and obsTransIn.value_coded=1065 "
                + "    and obsOpenDate.concept_id=23891 and obsOpenDate.value_datetime is not null "
                + "    and obsInTarv.concept_id=6300 and obsInTarv.value_coded=6276 "
                + "    and obsOpenDate.value_datetime > :endDate and e.location_id=:location group by p.patient_id "
                + ") transferido_de "
                + ")transferido_de on transferido_de.patient_id = inicio_real.patient_id "
                + "where transferido_de.patient_id is null ";

    public static final String
        findPatientsWhoHaveMoreThan3MonthsOnArtWithViralLoadRegisteredInTheLast12MonthsTarget =
            "select inicio_real.patient_id from (select inicio_real.patient_id from( "
                + "Select patient_id,min(data_inicio) data_inicio from ( "
                + "Select p.patient_id,min(e.encounter_datetime) data_inicio from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on o.encounter_id=e.encounter_id "
                + "where e.voided=0 and o.voided=0 and p.voided=0 and  e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and e.encounter_datetime > '0000-00-00 00:00' and  e.encounter_datetime<=:endDate and e.location_id=:location group by p.patient_id "
                + "union "
                + "Select p.patient_id,min(value_datetime) data_inicio from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on e.encounter_id=o.encounter_id "
                + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and  o.concept_id=1190 and o.value_datetime > '0000-00-00 00:00' and o.value_datetime is not null and  o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id "
                + "union "
                + "select pg.patient_id,min(date_enrolled) data_inicio from patient p inner join patient_program pg on p.patient_id=pg.patient_id "
                + "where pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled > '0000-00-00 00:00' and date_enrolled<=:endDate and location_id=:location group by pg.patient_id "
                + "union "
                + "SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio  FROM 	patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "WHERE p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime > '0000-00-00 00:00' and e.encounter_datetime<=:endDate and e.location_id=:location GROUP BY 	p.patient_id "
                + "union "
                + "Select p.patient_id,min(value_datetime) data_inicio from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on e.encounter_id=o.encounter_id "
                + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and  o.concept_id=23866 and o.value_datetime > '0000-00-00 00:00' and o.value_datetime is not null and  o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id "
                + "union "
                + "select  max_estado.patient_id,data_estado "
                + "from( "
                + "  select pg.patient_id, "
                + "      max(ps.start_date) data_estado "
                + "    from  patient p "
                + "      inner join patient_program pg on p.patient_id = pg.patient_id "
                + "      inner join patient_state ps on pg.patient_program_id = ps.patient_program_id "
                + "    where pg.voided=0 and ps.voided=0 and p.voided=0  and pg.program_id = 2 "
                + "      and ps.start_date>=:startDate and  ps.start_date< :endDate and pg.location_id =:location group by pg.patient_id "
                + "    ) "
                + "max_estado "
                + "  inner join patient_program pp on pp.patient_id = max_estado.patient_id "
                + "  inner join patient_state ps on ps.patient_program_id = pp.patient_program_id and ps.start_date = max_estado.data_estado "
                + "where pp.program_id = 2 and ps.state = 29 and pp.voided = 0 and ps.voided = 0 and pp.location_id = :location "
                + "union "
                + "select transferido_de.patient_id,data_estado "
                + "from( "
                + "  select p.patient_id, max(obsOpenDate.value_datetime) data_estado from patient p "
                + "    inner join encounter e on p.patient_id=e.patient_id "
                + "    inner join obs obsTransIn on e.encounter_id= obsTransIn.encounter_id "
                + "    inner join obs obsOpenDate on e.encounter_id= obsOpenDate.encounter_id "
                + "    inner join obs obsInTarv on e.encounter_id= obsInTarv.encounter_id "
                + "   where e.voided=0 and obsTransIn.voided=0 and p.voided=0  and obsOpenDate.voided =0 and obsInTarv.voided =0 "
                + "    and e.encounter_type=53 and obsTransIn.concept_id=1369 and obsTransIn.value_coded=1065 "
                + "    and obsOpenDate.concept_id=23891 and obsOpenDate.value_datetime is not null "
                + "    and obsInTarv.concept_id=6300 and obsInTarv.value_coded=6276 "
                + "    and obsOpenDate.value_datetime >=:startDate and obsOpenDate.value_datetime < :endDate and e.location_id=:location group by p.patient_id "
                + ") transferido_de "
                + ") inicio group by patient_id)inicio_real "
                + "inner join ( "
                + "Select p.patient_id,max(o.obs_datetime) data_carga from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on e.encounter_id=o.encounter_id "
                + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,6,9,53,51) and  o.concept_id in (856,1305) and o.obs_datetime > '0000-00-00 00:00' and  o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and e.location_id=:location group by p.patient_id) carga_viral on inicio_real.patient_id=carga_viral.patient_id "
                + "inner join obs obsRazao on obsRazao.person_id=carga_viral.patient_id "
                + "where carga_viral.data_carga>=date_add(inicio_real.data_inicio, interval 90 DAY) and  obsRazao.obs_datetime=carga_viral.data_carga and  obsRazao.concept_id=23818 and obsRazao.value_coded in (843,23864,23881,23882) and obsRazao.voided=0 "
                + ") inicio_real "
                + "left join ( "
                + "select  max_estado.patient_id "
                + "from( "
                + "  select pg.patient_id, "
                + "      max(ps.start_date) data_estado "
                + "    from  patient p "
                + "      inner join patient_program pg on p.patient_id = pg.patient_id "
                + "      inner join patient_state ps on pg.patient_program_id = ps.patient_program_id "
                + "    where pg.voided=0 and ps.voided=0 and p.voided=0  and pg.program_id = 2 "
                + "      and ps.start_date> :endDate and pg.location_id =:location group by pg.patient_id "
                + "    ) "
                + "max_estado "
                + "  inner join patient_program pp on pp.patient_id = max_estado.patient_id "
                + "  inner join patient_state ps on ps.patient_program_id = pp.patient_program_id and ps.start_date = max_estado.data_estado "
                + "where pp.program_id = 2 and ps.state = 29 and pp.voided = 0 and ps.voided = 0 and pp.location_id = :location "
                + "union "
                + "select transferido_de.patient_id "
                + "from( "
                + "  select p.patient_id, max(obsOpenDate.value_datetime) data_estado from patient p "
                + "    inner join encounter e on p.patient_id=e.patient_id "
                + "    inner join obs obsTransIn on e.encounter_id= obsTransIn.encounter_id "
                + "    inner join obs obsOpenDate on e.encounter_id= obsOpenDate.encounter_id "
                + "    inner join obs obsInTarv on e.encounter_id= obsInTarv.encounter_id "
                + "   where e.voided=0 and obsTransIn.voided=0 and p.voided=0  and obsOpenDate.voided =0 and obsInTarv.voided =0 "
                + "    and e.encounter_type=53 and obsTransIn.concept_id=1369 and obsTransIn.value_coded=1065 "
                + "    and obsOpenDate.concept_id=23891 and obsOpenDate.value_datetime is not null "
                + "    and obsInTarv.concept_id=6300 and obsInTarv.value_coded=6276 "
                + "    and obsOpenDate.value_datetime > :endDate and e.location_id=:location group by p.patient_id "
                + ") transferido_de "
                + ")transferido_de on transferido_de.patient_id = inicio_real.patient_id "
                + "where transferido_de.patient_id is null ";

    public static final String
        findPatientsWhoHaveMoreThan3MonthsOnArtWithViralLoadResultLessthan1000RegisteredInTheLast12Months =
            "select inicio_real.patient_id from ( select inicio_real.patient_id  from ( "
                + "select patient_id,min(data_inicio) data_inicio from ( "
                + "select p.patient_id,min(e.encounter_datetime) data_inicio from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on o.encounter_id=e.encounter_id "
                + "where e.voided=0 and o.voided=0 and p.voided=0 and  e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and e.encounter_datetime > '0000-00-00 00:00' and e.encounter_datetime<=:endDate and e.location_id=:location group by p.patient_id "
                + "union "
                + "Select p.patient_id,min(value_datetime) data_inicio from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on e.encounter_id=o.encounter_id "
                + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and o.concept_id=1190 and o.value_datetime is not null and o.value_datetime > '0000-00-00 00:00' and  o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id "
                + "union "
                + "select pg.patient_id,min(date_enrolled) data_inicio from patient p "
                + "inner join patient_program pg on p.patient_id=pg.patient_id "
                + "where pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled > '0000-00-00 00:00' and date_enrolled<=:endDate and location_id=:location group by pg.patient_id "
                + "union "
                + "SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio  FROM patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "WHERE p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime > '0000-00-00 00:00' and e.encounter_datetime<=:endDate and e.location_id=:location GROUP BY p.patient_id "
                + "union "
                + "Select p.patient_id,min(value_datetime) data_inicio from 	patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on e.encounter_id=o.encounter_id "
                + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and  o.concept_id=23866 and o.value_datetime > '0000-00-00 00:00' and o.value_datetime is not null and  o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id "
                + "union "
                + "select  max_estado.patient_id,data_estado "
                + "from( "
                + "  select pg.patient_id, "
                + "      max(ps.start_date) data_estado "
                + "    from  patient p "
                + "      inner join patient_program pg on p.patient_id = pg.patient_id "
                + "      inner join patient_state ps on pg.patient_program_id = ps.patient_program_id "
                + "    where pg.voided=0 and ps.voided=0 and p.voided=0  and pg.program_id = 2 "
                + "      and ps.start_date>=:startDate and  ps.start_date< :endDate and pg.location_id =:location group by pg.patient_id "
                + "    ) "
                + "max_estado "
                + "  inner join patient_program pp on pp.patient_id = max_estado.patient_id "
                + "  inner join patient_state ps on ps.patient_program_id = pp.patient_program_id and ps.start_date = max_estado.data_estado "
                + "where pp.program_id = 2 and ps.state = 29 and pp.voided = 0 and ps.voided = 0 and pp.location_id = :location "
                + "union "
                + "select transferido_de.patient_id,data_estado "
                + "from( "
                + "  select p.patient_id, max(obsOpenDate.value_datetime) data_estado from patient p "
                + "    inner join encounter e on p.patient_id=e.patient_id "
                + "    inner join obs obsTransIn on e.encounter_id= obsTransIn.encounter_id "
                + "    inner join obs obsOpenDate on e.encounter_id= obsOpenDate.encounter_id "
                + "    inner join obs obsInTarv on e.encounter_id= obsInTarv.encounter_id "
                + "   where e.voided=0 and obsTransIn.voided=0 and p.voided=0  and obsOpenDate.voided =0 and obsInTarv.voided =0 "
                + "    and e.encounter_type=53 and obsTransIn.concept_id=1369 and obsTransIn.value_coded=1065 "
                + "    and obsOpenDate.concept_id=23891 and obsOpenDate.value_datetime is not null "
                + "    and obsInTarv.concept_id=6300 and obsInTarv.value_coded=6276 "
                + "    and obsOpenDate.value_datetime >=:startDate and obsOpenDate.value_datetime < :endDate and e.location_id=:location group by p.patient_id "
                + ") transferido_de "
                + ") inicio group by patient_id) inicio_real "
                + "inner join ( "
                + "select ultima_carga.patient_id,ultima_carga.data_carga,obs.value_numeric valor_carga,obs.concept_id,obs.value_coded from ( "
                + "Select p.patient_id,max(o.obs_datetime) data_carga from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on e.encounter_id=o.encounter_id "
                + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,6,9,53,51) and  o.concept_id in (856,1305) and o.obs_datetime > '0000-00-00 00:00' and  o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and e.location_id=:location group by p.patient_id) ultima_carga "
                + "inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga "
                + "where obs.voided=0 and ((obs.concept_id=856 and obs.value_numeric<1000) or (obs.concept_id=1305 and obs.value_coded in (1306,23814,23905,23906,23907,23908,23904,165331)))  and obs.location_id=:location) carga_viral on inicio_real.patient_id=carga_viral.patient_id "
                + "where carga_viral.data_carga>=date_add(inicio_real.data_inicio, interval 90 DAY)) inicio_real "
                + "left join ( "
                + "select  max_estado.patient_id "
                + "from( "
                + "  select pg.patient_id, "
                + "      max(ps.start_date) data_estado "
                + "    from  patient p "
                + "      inner join patient_program pg on p.patient_id = pg.patient_id "
                + "      inner join patient_state ps on pg.patient_program_id = ps.patient_program_id "
                + "    where pg.voided=0 and ps.voided=0 and p.voided=0  and pg.program_id = 2 "
                + "      and ps.start_date> :endDate and pg.location_id =:location group by pg.patient_id "
                + "    ) "
                + "max_estado "
                + "  inner join patient_program pp on pp.patient_id = max_estado.patient_id "
                + "  inner join patient_state ps on ps.patient_program_id = pp.patient_program_id and ps.start_date = max_estado.data_estado "
                + "where pp.program_id = 2 and ps.state = 29 and pp.voided = 0 and ps.voided = 0 and pp.location_id = :location "
                + "union "
                + "select transferido_de.patient_id "
                + "from( "
                + "  select p.patient_id, max(obsOpenDate.value_datetime) data_estado from patient p "
                + "    inner join encounter e on p.patient_id=e.patient_id "
                + "    inner join obs obsTransIn on e.encounter_id= obsTransIn.encounter_id "
                + "    inner join obs obsOpenDate on e.encounter_id= obsOpenDate.encounter_id "
                + "    inner join obs obsInTarv on e.encounter_id= obsInTarv.encounter_id "
                + "   where e.voided=0 and obsTransIn.voided=0 and p.voided=0  and obsOpenDate.voided =0 and obsInTarv.voided =0 "
                + "    and e.encounter_type=53 and obsTransIn.concept_id=1369 and obsTransIn.value_coded=1065 "
                + "    and obsOpenDate.concept_id=23891 and obsOpenDate.value_datetime is not null "
                + "    and obsInTarv.concept_id=6300 and obsInTarv.value_coded=6276 "
                + "    and obsOpenDate.value_datetime > :endDate and e.location_id=:location group by p.patient_id "
                + ") transferido_de "
                + ")transferido_de on transferido_de.patient_id = inicio_real.patient_id "
                + "where transferido_de.patient_id is null ";

    public static final String
        findPatientsWhoHaveMoreThan3MonthsOnArtWithViralLoadResultLessthan1000RegisteredInTheLast12MonthsTarget =
            "select inicio_real.patient_id from ( select  inicio_real.patient_id from ( "
                + "Select patient_id,min(data_inicio) data_inicio from ( "
                + "Select p.patient_id,min(e.encounter_datetime) data_inicio from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on o.encounter_id=e.encounter_id "
                + "where e.voided=0 and o.voided=0 and p.voided=0 and  e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and e.encounter_datetime > '0000-00-00 00:00' and  e.encounter_datetime<=:endDate and e.location_id=:location group by p.patient_id "
                + "union "
                + "Select p.patient_id,min(value_datetime) data_inicio from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on e.encounter_id=o.encounter_id where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and o.value_datetime > '0000-00-00 00:00' and  o.concept_id=1190 and o.value_datetime is not null and  o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id "
                + "union "
                + "select pg.patient_id,min(date_enrolled) data_inicio from patient p inner join patient_program pg on p.patient_id=pg.patient_id where pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled > '0000-00-00 00:00' and date_enrolled<=:endDate and location_id=:location group by pg.patient_id "
                + "union "
                + "SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio  FROM patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "WHERE	p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime > '0000-00-00 00:00' and e.encounter_datetime<=:endDate and e.location_id=:location GROUP BY p.patient_id "
                + "union "
                + "Select p.patient_id,min(value_datetime) data_inicio from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on e.encounter_id=o.encounter_id "
                + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and  o.concept_id=23866 and o.value_datetime > '0000-00-00 00:00' and o.value_datetime is not null and  o.value_datetime<=:endDate and e.location_id=:location group by p.patient_id "
                + "union "
                + "select  max_estado.patient_id,data_estado "
                + "from( "
                + "  select pg.patient_id, "
                + "      max(ps.start_date) data_estado "
                + "    from  patient p "
                + "      inner join patient_program pg on p.patient_id = pg.patient_id "
                + "      inner join patient_state ps on pg.patient_program_id = ps.patient_program_id "
                + "    where pg.voided=0 and ps.voided=0 and p.voided=0  and pg.program_id = 2 "
                + "      and ps.start_date>=:startDate and  ps.start_date< :endDate and pg.location_id =:location group by pg.patient_id "
                + "    ) "
                + "max_estado "
                + "  inner join patient_program pp on pp.patient_id = max_estado.patient_id "
                + "  inner join patient_state ps on ps.patient_program_id = pp.patient_program_id and ps.start_date = max_estado.data_estado "
                + "where pp.program_id = 2 and ps.state = 29 and pp.voided = 0 and ps.voided = 0 and pp.location_id = :location "
                + "union "
                + "select transferido_de.patient_id,data_estado "
                + "from( "
                + "  select p.patient_id, max(obsOpenDate.value_datetime) data_estado from patient p "
                + "    inner join encounter e on p.patient_id=e.patient_id "
                + "    inner join obs obsTransIn on e.encounter_id= obsTransIn.encounter_id "
                + "    inner join obs obsOpenDate on e.encounter_id= obsOpenDate.encounter_id "
                + "    inner join obs obsInTarv on e.encounter_id= obsInTarv.encounter_id "
                + "   where e.voided=0 and obsTransIn.voided=0 and p.voided=0  and obsOpenDate.voided =0 and obsInTarv.voided =0 "
                + "    and e.encounter_type=53 and obsTransIn.concept_id=1369 and obsTransIn.value_coded=1065 "
                + "    and obsOpenDate.concept_id=23891 and obsOpenDate.value_datetime is not null "
                + "    and obsInTarv.concept_id=6300 and obsInTarv.value_coded=6276 "
                + "    and obsOpenDate.value_datetime >=:startDate and obsOpenDate.value_datetime < :endDate and e.location_id=:location group by p.patient_id "
                + ") transferido_de "
                + ") inicio group by patient_id)inicio_real "
                + "inner join( "
                + "Select p.patient_id,max(o.obs_datetime) data_carga from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on e.encounter_id=o.encounter_id "
                + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,6,9,53,51) and  o.concept_id in (856,1305) and o.obs_datetime > '0000-00-00 00:00' and  o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and e.location_id=:location group by p.patient_id) carga_viral on inicio_real.patient_id=carga_viral.patient_id "
                + "inner join obs obsRazao on obsRazao.person_id=carga_viral.patient_id and obsRazao.obs_datetime=carga_viral.data_carga "
                + "inner join obs obscv on obscv.person_id=carga_viral.patient_id and obscv.obs_datetime=carga_viral.data_carga "
                + "where carga_viral.data_carga>=date_add(inicio_real.data_inicio, interval 90 DAY)  and  obsRazao.concept_id=23818 and obsRazao.value_coded in (843,23864,23881,23882) and obsRazao.voided=0 and ((obscv.concept_id=856 and obscv.value_numeric<1000) or (obscv.concept_id=1305 and obscv.value_coded in (1306,23814,23905,23906,23907,23908,23904,165331))) and obscv.voided=0 "
                + ") inicio_real "
                + "left join ( "
                + "select  max_estado.patient_id "
                + "from( "
                + "  select pg.patient_id, "
                + "      max(ps.start_date) data_estado "
                + "    from  patient p "
                + "      inner join patient_program pg on p.patient_id = pg.patient_id "
                + "      inner join patient_state ps on pg.patient_program_id = ps.patient_program_id "
                + "    where pg.voided=0 and ps.voided=0 and p.voided=0  and pg.program_id = 2 "
                + "      and ps.start_date> :endDate and pg.location_id =:location group by pg.patient_id "
                + "    ) "
                + "max_estado "
                + "  inner join patient_program pp on pp.patient_id = max_estado.patient_id "
                + "  inner join patient_state ps on ps.patient_program_id = pp.patient_program_id and ps.start_date = max_estado.data_estado "
                + "where pp.program_id = 2 and ps.state = 29 and pp.voided = 0 and ps.voided = 0 and pp.location_id = :location "
                + "union "
                + "select transferido_de.patient_id "
                + "from( "
                + "  select p.patient_id, max(obsOpenDate.value_datetime) data_estado from patient p "
                + "    inner join encounter e on p.patient_id=e.patient_id "
                + "    inner join obs obsTransIn on e.encounter_id= obsTransIn.encounter_id "
                + "    inner join obs obsOpenDate on e.encounter_id= obsOpenDate.encounter_id "
                + "    inner join obs obsInTarv on e.encounter_id= obsInTarv.encounter_id "
                + "   where e.voided=0 and obsTransIn.voided=0 and p.voided=0  and obsOpenDate.voided =0 and obsInTarv.voided =0 "
                + "    and e.encounter_type=53 and obsTransIn.concept_id=1369 and obsTransIn.value_coded=1065 "
                + "    and obsOpenDate.concept_id=23891 and obsOpenDate.value_datetime is not null "
                + "    and obsInTarv.concept_id=6300 and obsInTarv.value_coded=6276 "
                + "    and obsOpenDate.value_datetime > :endDate and e.location_id=:location group by p.patient_id "
                + ") transferido_de "
                + ")transferido_de on transferido_de.patient_id = inicio_real.patient_id "
                + "where transferido_de.patient_id is null ";

    public static final String
        findWomanStateWhoHaveMoreThan3MonthsOnArtWithViralLoadRegisteredInTheLast12Months(
            WomanState womanState) {

      String query =
          EptsQuerysUtils.loadQuery(
              FIND_WOMAN_STATE_WHO_HAVE_MORE_THAN_3MONTHS_ON_ART_WITH_VIRALLOAD_REGISTERED_IN_THELAST12MONTHS);
      switch (womanState) {
        case PREGNANT:
          query = String.format(query, 2);
          break;

        case BREASTFEEDING:
          query = String.format(query, 1);
          break;
      }
      return query;
    }
  }
}
