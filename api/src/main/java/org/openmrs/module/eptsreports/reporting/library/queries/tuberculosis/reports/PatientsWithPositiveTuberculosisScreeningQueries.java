package org.openmrs.module.eptsreports.reporting.library.queries.tuberculosis.reports;

public class PatientsWithPositiveTuberculosisScreeningQueries {

  public static String findPatientsWithPositiveTuberculosisScreening() {
    String query =
        "select "
            + "               patient_id, "
            + "			data_rastreio, "
            + "			data_investigacao, "
            + "			resultado, "
            + "			data_inicio_tb, "
            + "			data_fim_tb, "
            + "			data_ultimo_seguimento, "
            + "			proximo_seguimento, "
            + "			NID, "
            + "			NomeCompleto "
            + "from "
            + "( "
            + "	select 	rastreio.patient_id, "
            + "			data_rastreio, "
            + "			data_investigacao, "
            + "			resultado, "
            + "			data_inicio_tb, "
            + "			data_fim_tb, "
            + "			data_ultimo_seguimento, "
            + "			proximo_seguimento, "
            + "			pid.identifier NID, "
            + "			concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) NomeCompleto "
            + "	from "
            + "		(	select 	p.patient_id,max(obs_datetime) data_rastreio "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on o.encounter_id=e.encounter_id "
            + "			where 	e.encounter_type in (6,9) and e.voided=0 and o.voided=0 and p.voided=0 and "
            + "					o.concept_id=6257 and o.value_coded=1065 and "
            + "					e.encounter_datetime between :startDate and :endDate and e.location_id=:location "
            + "			group by p.patient_id "
            + "		) rastreio "
            + "		left join "
            + "		(	select patient_id,data_investigacao,if(value_coded=703,'POSITIVO','NEGATIVO') resultado "
            + "			from "
            + "			(	select 	p.patient_id,max(obs_datetime) data_investigacao "
            + "					from 	patient p "
            + "							inner join encounter e on p.patient_id=e.patient_id "
            + "							inner join obs o on o.encounter_id=e.encounter_id "
            + "					where 	e.encounter_type in (6,9) and e.voided=0 and o.voided=0 and p.voided=0 and "
            + "							o.concept_id=6277 and "
            + "							e.encounter_datetime<=curdate() and e.location_id=:location "
            + "					group by p.patient_id "
            + "			) max_investigacao "
            + "			inner join obs on obs.person_id=max_investigacao.patient_id "
            + "			where max_investigacao.data_investigacao=obs.obs_datetime and obs.concept_id=6277 and voided=0 and location_id=:location "
            + "		) investigacao on rastreio.patient_id=investigacao.patient_id "
            + "		left join "
            + "		( "
            + "			select patient_id,max(data_inicio_tb) data_inicio_tb "
            + "			from "
            + "			(	select 	p.patient_id,max(o.value_datetime) data_inicio_tb "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on o.encounter_id=e.encounter_id "
            + "				where 	e.encounter_type in (6,9) and e.voided=0 and o.voided=0 and p.voided=0 and "
            + "						o.concept_id=1113 and e.location_id=:location and e.encounter_datetime<=curdate() "
            + "				group by p.patient_id "
            + " "
            + "				union "
            + " "
            + "				select 	pg.patient_id,max(date_enrolled) data_inicio_tb "
            + "				from 	patient p "
            + "						inner join patient_program pg on p.patient_id=pg.patient_id "
            + "				where 	pg.voided=0 and program_id=5 and date_enrolled<=curdate() and pg.location_id=:location "
            + "				group by p.patient_id "
            + "			) tbstart "
            + "			group by patient_id "
            + "		) inicio on rastreio.patient_id=inicio.patient_id "
            + "		left join "
            + "		(	select 	p.patient_id,max(o.value_datetime) data_fim_tb "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on o.encounter_id=e.encounter_id "
            + "			where 	e.encounter_type in (6,9) and e.voided=0 and o.voided=0 and p.voided=0 and "
            + "					o.concept_id=6120 and e.location_id=:location and e.encounter_datetime<=curdate() "
            + "			group by p.patient_id "
            + "		) fim on rastreio.patient_id=fim.patient_id "
            + "		left join "
            + "		(	select patient_id,data_ultimo_seguimento,value_datetime proximo_seguimento "
            + "			from "
            + "			(	select 	p.patient_id,max(encounter_datetime) data_ultimo_seguimento "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "				where 	e.encounter_type in (6,9) and e.voided=0 and p.voided=0 and "
            + "						e.encounter_datetime<=curdate() and e.location_id=:location "
            + "				group by p.patient_id "
            + "			) max_seguimento "
            + "			left join obs on obs.person_id=max_seguimento.patient_id and "
            + "							max_seguimento.data_ultimo_seguimento=obs.obs_datetime and "
            + "							obs.concept_id=1410 and obs.voided=0 and obs.location_id=:location "
            + "		) seguimento on rastreio.patient_id=seguimento.patient_id "
            + "		left join "
            + "		(	select pid1.* "
            + "			from patient_identifier pid1 "
            + "			inner join "
            + "				( "
            + "					select patient_id,min(patient_identifier_id) id "
            + "					from patient_identifier "
            + "					where voided=0 "
            + "					group by patient_id "
            + "				) pid2 "
            + "			where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id "
            + "		) pid on pid.patient_id=rastreio.patient_id "
            + "		left join "
            + "		(	select pn1.* "
            + "			from person_name pn1 "
            + "			inner join "
            + "				( "
            + "					select person_id,min(person_name_id) id "
            + "					from person_name "
            + "					where voided=0 "
            + "					group by person_id "
            + "				) pn2 "
            + "			where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id "
            + "		) pn on pn.person_id=rastreio.patient_id "
            + ") rastreio_final "
            + "group by patient_id ";
    return query;
  }
}
