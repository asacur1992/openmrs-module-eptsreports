/** */
package org.openmrs.module.eptsreports.reporting.library.queries.listings;

/** @author StÃ©lio Moiane */
public interface PatientsWhoStartedARTQueries {
  class QUERY {
    public static final String findPatientsWhoStartedART =
        "select *\n"
            + "from\n"
            + "(	select 	inicio_real.patient_id,\n"
            + "				inicio_real.data_inicio,\n"
            + "				pad3.county_district as 'Distrito',\n"
            + "				pad3.address2 as 'PAdministrativo',\n"
            + "				pad3.address6 as 'Localidade',\n"
            + "				pad3.address5 as 'Bairro',\n"
            + "				pad3.address1 as 'PontoReferencia',\n"
            + "				concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as 'NomeCompleto',					\n"
            + "				pid.identifier as NID,\n"
            + "				p.gender,\n"
            + "				round(datediff(:endDate,p.birthdate)/365) idade_actual,\n"
            + "				saida.encounter_datetime as data_saida,\n"
            + "				if(saida.estado is not null,saida.estado,if(datediff(:endDate,visita.value_datetime)>28,'ABANDONO NAO NOTIFICADO',if(datediff(:endDate,visita.value_datetime)>3,'FALTOSO',''))) as tipo_saida,\n"
            + "				visita.encounter_datetime as ultimo_levantamento,\n"
            + "				visita.value_datetime as proximo_marcado,\n"
            + "				regime.ultimo_regime,\n"
            + "				regime.data_regime,\n"
            + "				if(programa.patient_id is null,'NAO','SIM') inscrito_programa,\n"
            + "				inicio_tpi.data_inicio_tpi\n"
            + "		from	\n"
            + "			(select patient_id,data_inicio\n"
            + "from\n"
            + "(	Select patient_id,min(data_inicio) data_inicio\n"
            + "		from\n"
            + "			(	\n"
            + "			\n"
            + "				/*Patients on ART who initiated the ARV DRUGS: ART Regimen Start Date*/\n"
            + "				\n"
            + "						Select 	p.patient_id,min(e.encounter_datetime) data_inicio\n"
            + "						from 	patient p \n"
            + "								inner join encounter e on p.patient_id=e.patient_id	\n"
            + "								inner join obs o on o.encounter_id=e.encounter_id\n"
            + "						where 	e.voided=0 and o.voided=0 and p.voided=0 and \n"
            + "								e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and \n"
            + "								e.encounter_datetime<=:endDate and e.location_id=:location\n"
            + "						group by p.patient_id\n"
            + "				\n"
            + "						union\n"
            + "				\n"
            + "						/*Patients on ART who have art start date: ART Start date*/\n"
            + "						Select 	p.patient_id,min(value_datetime) data_inicio\n"
            + "						from 	patient p\n"
            + "								inner join encounter e on p.patient_id=e.patient_id\n"
            + "								inner join obs o on e.encounter_id=o.encounter_id\n"
            + "						where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and \n"
            + "								o.concept_id=1190 and o.value_datetime is not null and \n"
            + "								o.value_datetime<=:endDate and e.location_id=:location\n"
            + "						group by p.patient_id\n"
            + "\n"
            + "						union\n"
            + "\n"
            + "						/*Patients enrolled in ART Program: OpenMRS Program*/\n"
            + "						select 	pg.patient_id,min(date_enrolled) data_inicio\n"
            + "						from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
            + "						where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate and location_id=:location\n"
            + "						group by pg.patient_id\n"
            + "						\n"
            + "						union\n"
            + "						\n"
            + "						\n"
            + "						/*Patients with first drugs pick up date set in Pharmacy: First ART Start Date*/\n"
            + "						  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio \n"
            + "						  FROM 		patient p\n"
            + "									inner join encounter e on p.patient_id=e.patient_id\n"
            + "						  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location\n"
            + "						  GROUP BY 	p.patient_id\n"
            + "					  \n"
            + "						union\n"
            + "						\n"
            + "						/*Patients with first drugs pick up date set: Recepcao Levantou ARV*/\n"
            + "						Select 	p.patient_id,min(value_datetime) data_inicio\n"
            + "						from 	patient p\n"
            + "								inner join encounter e on p.patient_id=e.patient_id\n"
            + "								inner join obs o on e.encounter_id=o.encounter_id\n"
            + "						where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and \n"
            + "								o.concept_id=23866 and o.value_datetime is not null and \n"
            + "								o.value_datetime<=:endDate and e.location_id=:location\n"
            + "						group by p.patient_id		\n"
            + "					\n"
            + "				\n"
            + "				\n"
            + "			) inicio\n"
            + "		group by patient_id	\n"
            + "	)inicio1\n"
            + "where data_inicio between :startDate and :endDate\n"
            + ")inicio_real\n"
            + "			inner join person p on p.person_id=inicio_real.patient_id\n"
            + "			inner join\n"
            + "			(\n"
            + "				select 	p.patient_id \n"
            + "				from 	patient p inner join encounter e on e.patient_id=p.patient_id \n"
            + "				where 	e.voided=0 and p.voided=0 and e.encounter_type in (5,7) and e.encounter_datetime<=:endDate and e.location_id = :location\n"
            + "\n"
            + "				union\n"
            + "\n"
            + "				select 	pg.patient_id\n"
            + "				from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
            + "				where 	pg.voided=0 and p.voided=0 and program_id in (1,2) and date_enrolled<=:endDate and location_id=:location\n"
            + "				\n"
            + "				union\n"
            + "				\n"
            + "				Select 	p.patient_id\n"
            + "				from 	patient p\n"
            + "						inner join encounter e on p.patient_id=e.patient_id\n"
            + "						inner join obs o on e.encounter_id=o.encounter_id\n"
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=53 and \n"
            + "						o.concept_id=23891 and o.value_datetime is not null and \n"
            + "						o.value_datetime<=:endDate and e.location_id=:location\n"
            + "				\n"
            + "				\n"
            + "			)inscricao on inicio_real.patient_id=inscricao.patient_id			\n"
            + "			left join \n"
            + "			(	select pad1.*\n"
            + "				from person_address pad1\n"
            + "				inner join \n"
            + "				(\n"
            + "					select person_id,min(person_address_id) id \n"
            + "					from person_address\n"
            + "					where voided=0\n"
            + "					group by person_id\n"
            + "				) pad2\n"
            + "				where pad1.person_id=pad2.person_id and pad1.person_address_id=pad2.id\n"
            + "			) pad3 on pad3.person_id=inicio_real.patient_id				\n"
            + "			left join 			\n"
            + "			(	select pn1.*\n"
            + "				from person_name pn1\n"
            + "				inner join \n"
            + "				(\n"
            + "					select person_id,min(person_name_id) id \n"
            + "					from person_name\n"
            + "					where voided=0\n"
            + "					group by person_id\n"
            + "				) pn2\n"
            + "				where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
            + "			) pn on pn.person_id=inicio_real.patient_id			\n"
            + "			left join\n"
            + "			(       select pid1.*\n"
            + "					from patient_identifier pid1\n"
            + "					inner join\n"
            + "									(\n"
            + "													select patient_id,min(patient_identifier_id) id\n"
            + "													from patient_identifier\n"
            + "													where voided=0\n"
            + "													group by patient_id\n"
            + "									) pid2\n"
            + "					where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
            + "			) pid on pid.patient_id=inicio_real.patient_id			\n"
            + "			left join\n"
            + "			(		\n"
            + "				select 	pg.patient_id,ps.start_date encounter_datetime,location_id,\n"
            + "						case ps.state\n"
            + "							when 7 then 'TRANSFERIDO PARA'\n"
            + "							when 8 then 'SUSPENSO'\n"
            + "							when 9 then 'ABANDONO'\n"
            + "							when 10 then 'OBITO'\n"
            + "						else 'OUTRO' end as estado\n"
            + "				from 	patient p \n"
            + "						inner join patient_program pg on p.patient_id=pg.patient_id\n"
            + "						inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
            + "				where 	pg.voided=0 and ps.voided=0 and p.voided=0 and \n"
            + "						pg.program_id=2 and ps.state in (7,8,9,10) and ps.end_date is null and location_id=:location	\n"
            + "			\n"
            + "			) saida on saida.patient_id=inicio_real.patient_id\n"
            + "			left join \n"
            + "			(	\n"
            + "			\n"
            + "				select patient_id,max(encounter_datetime) encounter_datetime,max(value_datetime) value_datetime\n"
            + "				from\n"
            + "				(\n"
            + "					Select ultimavisita.patient_id,ultimavisita.encounter_datetime,o.value_datetime\n"
            + "					from\n"
            + "\n"
            + "					(	select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
            + "						from 	encounter e \n"
            + "								inner join patient p on p.patient_id=e.patient_id 		\n"
            + "						where 	e.voided=0 and p.voided=0 and e.encounter_type=18 and e.location_id=:location and \n"
            + "								e.encounter_datetime<=:endDate\n"
            + "						group by p.patient_id\n"
            + "					) ultimavisita\n"
            + "					inner join encounter e on e.patient_id=ultimavisita.patient_id\n"
            + "					inner join obs o on o.encounter_id=e.encounter_id			\n"
            + "					where o.concept_id=5096 and o.voided=0 and e.encounter_datetime=ultimavisita.encounter_datetime and \n"
            + "					e.encounter_type=18 and e.location_id=:location\n"
            + "					\n"
            + "					union\n"
            + "					\n"
            + "					Select 	p.patient_id,max(value_datetime) encounter_datetime,date_add(max(value_datetime), interval 30 day) as value_datetime\n"
            + "					from 	patient p\n"
            + "							inner join encounter e on p.patient_id=e.patient_id\n"
            + "							inner join obs o on e.encounter_id=o.encounter_id\n"
            + "					where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and \n"
            + "							o.concept_id=23866 and o.value_datetime is not null and \n"
            + "							o.value_datetime<=:endDate and e.location_id=:location\n"
            + "					group by p.patient_id\n"
            + "				) lev\n"
            + "				group by patient_id			\n"
            + "			) visita on visita.patient_id=inicio_real.patient_id\n"
            + "			left join \n"
            + "			(\n"
            + "				select 	ultimo_lev.patient_id,\n"
            + "						case o.value_coded\n"
            + "						when 1703 then 'AZT+3TC+EFV'\n"
            + "						when 6100 then 'AZT+3TC+LPV/r'\n"
            + "						when 1651 then 'AZT+3TC+NVP'\n"
            + "						when 6324 then 'TDF+3TC+EFV'\n"
            + "						when 6104 then 'ABC+3TC+EFV'\n"
            + "						when 23784 then 'TDF+3TC+DTG'\n"
            + "						when 23786 then 'ABC+3TC+DTG'\n"
            + "						when 6116 then 'AZT+3TC+ABC'\n"
            + "						when 6106 then 'ABC+3TC+LPV/r'\n"
            + "						when 6105 then 'ABC+3TC+NVP'\n"
            + "						when 6108 then 'TDF+3TC+LPV/r'\n"
            + "						when 23790 then 'TDF+3TC+LPV/r+RTV'\n"
            + "						when 23791 then 'TDF+3TC+ATV/r'\n"
            + "						when 23792 then 'ABC+3TC+ATV/r'\n"
            + "						when 23793 then 'AZT+3TC+ATV/r'\n"
            + "						when 23795 then 'ABC+3TC+ATV/r+RAL'\n"
            + "						when 23796 then 'TDF+3TC+ATV/r+RAL'\n"
            + "						when 23801 then 'AZT+3TC+RAL'\n"
            + "						when 23802 then 'AZT+3TC+DRV/r'\n"
            + "						when 23815 then 'AZT+3TC+DTG'\n"
            + "						when 6329 then 'TDF+3TC+RAL+DRV/r'\n"
            + "						when 23797 then 'ABC+3TC+DRV/r+RAL'\n"
            + "						when 23798 then '3TC+RAL+DRV/r'\n"
            + "						when 23803 then 'AZT+3TC+RAL+DRV/r'						\n"
            + "						when 6243 then 'TDF+3TC+NVP'\n"
            + "						when 6103 then 'D4T+3TC+LPV/r'\n"
            + "						when 792 then 'D4T+3TC+NVP'\n"
            + "						when 1827 then 'D4T+3TC+EFV'\n"
            + "						when 6102 then 'D4T+3TC+ABC'						\n"
            + "						when 1311 then 'ABC+3TC+LPV/r'\n"
            + "						when 1312 then 'ABC+3TC+NVP'\n"
            + "						when 1313 then 'ABC+3TC+EFV'\n"
            + "						when 1314 then 'AZT+3TC+LPV/r'\n"
            + "						when 1315 then 'TDF+3TC+EFV'						\n"
            + "						when 6330 then 'AZT+3TC+RAL+DRV/r'						\n"
            + "						when 6102 then 'D4T+3TC+ABC'\n"
            + "						when 6325 then 'D4T+3TC+ABC+LPV/r'\n"
            + "						when 6326 then 'AZT+3TC+ABC+LPV/r'\n"
            + "						when 6327 then 'D4T+3TC+ABC+EFV'\n"
            + "						when 6328 then 'AZT+3TC+ABC+EFV'\n"
            + "						when 6109 then 'AZT+DDI+LPV/r'\n"
            + "						when 6329 then 'TDF+3TC+RAL+DRV/r'\n"
            + "						when 21163 then 'AZT+3TC+LPV/r'						\n"
            + "						when 23799 then 'TDF+3TC+DTG'\n"
            + "						when 23800 then 'ABC+3TC+DTG'\n"
            + "						else 'OUTRO' end as ultimo_regime,\n"
            + "						ultimo_lev.encounter_datetime data_regime\n"
            + "				from 	obs o,				\n"
            + "						(	select p.patient_id,max(encounter_datetime) as encounter_datetime\n"
            + "							from 	patient p\n"
            + "									inner join encounter e on p.patient_id=e.patient_id								\n"
            + "							where 	encounter_type in (6,9) and e.voided=0 and\n"
            + "									encounter_datetime <=:endDate and e.location_id=:location and p.voided=0\n"
            + "							group by patient_id\n"
            + "						) ultimo_lev\n"
            + "				where 	o.person_id=ultimo_lev.patient_id and o.obs_datetime=ultimo_lev.encounter_datetime and o.voided=0 and \n"
            + "						o.concept_id=1087 and o.location_id=:location\n"
            + "			) regime on regime.patient_id=inicio_real.patient_id\n"
            + "			left join\n"
            + "			(\n"
            + "				select 	pg.patient_id\n"
            + "				from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
            + "				where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate and location_id=:location\n"
            + "			) programa on programa.patient_id=inicio_real.patient_id\n"
            + "			left join\n"
            + "			(	select p.patient_id,max(value_datetime) data_inicio_tpi\n"
            + "				from	patient p\n"
            + "						inner join encounter e on p.patient_id=e.patient_id\n"
            + "						inner join obs o on o.encounter_id=e.encounter_id\n"
            + "				where 	e.voided=0 and p.voided=0 and o.value_datetime<=:endDate and\n"
            + "						o.voided=0 and o.concept_id=6128 and e.encounter_type in (6,9,53) and e.location_id=:location\n"
            + "				group by p.patient_id\n"
            + "				\n"
            + "				union\n"
            + "				\n"
            + "				select p.patient_id,max(e.encounter_datetime) data_inicio_tpi\n"
            + "				from	patient p\n"
            + "						inner join encounter e on p.patient_id=e.patient_id\n"
            + "						inner join obs o on o.encounter_id=e.encounter_id\n"
            + "				where 	e.voided=0 and p.voided=0 and o.obs_datetime<=:endDate and\n"
            + "						o.voided=0 and o.concept_id=6122 and o.value_coded=1256 and e.encounter_type in (6,9) and e.location_id=:location\n"
            + "				group by p.patient_id\n"
            + "				\n"
            + "			) inicio_tpi on inicio_tpi.patient_id=inicio_real.patient_id\n"
            + "	)inicios\n"
            + "where patient_id not in \n"
            + "			(			\n"
            + "				select 	pg.patient_id\n"
            + "				from 	patient p \n"
            + "						inner join patient_program pg on p.patient_id=pg.patient_id\n"
            + "						inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
            + "				where 	pg.voided=0 and ps.voided=0 and p.voided=0 and \n"
            + "						pg.program_id=2 and ps.state=29 and ps.start_date=pg.date_enrolled and \n"
            + "						ps.start_date between :startDate and :endDate and location_id=:location\n"
            + "				union\n"
            + "				\n"
            + "				-- TRANSFERED IN PATIENTS FICHA RESUMO\n"
            + "				Select 	p.patient_id\n"
            + "				from 	patient p\n"
            + "						inner join encounter e on p.patient_id=e.patient_id\n"
            + "						inner join obs obsTrans on e.encounter_id=obsTrans.encounter_id and obsTrans.voided=0 and obsTrans.concept_id=1369 and obsTrans.value_coded=1065\n"
            + "						inner join obs obsTarv on e.encounter_id=obsTarv.encounter_id and obsTarv.voided=0 and obsTarv.concept_id=6300 and obsTarv.value_coded=6276 \n"
            + "						inner join obs obsRegisto on e.encounter_id=obsRegisto.encounter_id and obsRegisto.voided=0 and obsRegisto.concept_id=23891\n"
            + "				where 	p.voided=0 and e.voided=0 and e.encounter_type=53 and  \n"
            + "						obsRegisto.value_datetime between :startDate and :endDate and e.location_id=:location\n"
            + "\n"
            + "			)\n"
            + "group by patient_id";
  }
}
