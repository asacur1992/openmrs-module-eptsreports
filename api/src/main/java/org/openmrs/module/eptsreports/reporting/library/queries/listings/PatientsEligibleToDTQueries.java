/** */
package org.openmrs.module.eptsreports.reporting.library.queries.listings;

/** @author Abdul Sacur */
public interface PatientsEligibleToDTQueries {

  class QUERY {

    public static String findPatientsEligibleToDTPickUP() {

      String query =
          " \n"
              + "\n"
              + "		select coorte12meses_final.patient_id,\n"
              + "		coorte12meses_final.data_inicio,\n"
              + "        concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ') nome,\n"
              + "        concat(ifnull(pn.family_name,'')) apelido,\n"
              + "		pid.identifier as NID,\n"
              + "		p.gender sexo,\n"
              + "		peso.peso,\n"
              + "		timestampdiff(year,p.birthdate,:endDate)idade_actual,\n"
              + "		coorte12meses_final.data_usar_c as ultm_levnt_data,\n"
              + "		regimeFila.ultimo_regime ultimo_regime,\n"
              + "        med.medicamento,\n"
              + "		coorte12meses_final.data_seguimento ultm_cons_data,\n"
              + "		coorte12meses_final.data_proximo_lev levantamento_data_agendada,\n"
              + "		coorte12meses_final.data_proximo_seguimento consulta_data_agendada ,\n"
              + "		ultima_cv.data_carga,\n"
              + "		ultima_cv.Valor_carga,\n"
              + "        concat(ifnull(concat(' ',pad3.address5), ' '),ifnull(concat('  ',pad3.address1), '  '),ifnull(concat(', ',pad3.address3), '  ')) endereco,\n"
              + "         IF(sector.sector is not null,sector.sector,'') sector,\n"
              + "         gaac_model.mds_gaac, af_model.mds_af, ca_model.mds_ca, pu_model.mds_pu, fr_model.mds_fr, \n"
              + "        dt_model.mds_dt, dc_model.mds_dc, ds_model.mds_ds, tb_model.mds_tb, saaj_model.mds_saaj,smi_model.mds_smi,\n"
              + "        dd_model.mds_dd, dcp_model.mds_dcp, dca_model.mds_dca,bm_model.mds_bm,cm_model.mds_cm,eh_model.mds_eh,\n"
              + "        dah_model.mds_dah, da_model.mds_da,\n"
              + "		IF(patient_contact.patient_contact  is not null, patient_contact.patient_contact,\n"
              + "        IF(patient_contact2.patient_contact  is not null, patient_contact2.patient_contact, '')) contacto\n"
              + "\n"
              + "\n"
              + "\n"
              + "\n"
              + "		from\n"
              + "		(select   inicio_fila_seg_prox.*,\n"
              + "		GREATEST(COALESCE(data_fila,data_seguimento,data_recepcao_levantou),COALESCE(data_seguimento,data_fila,data_recepcao_levantou),COALESCE(data_recepcao_levantou,data_seguimento,data_fila))  data_usar_c,\n"
              + "		GREATEST(COALESCE(data_proximo_lev,data_proximo_seguimento,data_recepcao_levantou30),COALESCE(data_proximo_seguimento,data_proximo_lev,data_recepcao_levantou30),COALESCE(data_recepcao_levantou30,data_proximo_seguimento,data_proximo_lev)) data_usar\n"
              + "\n"
              + "		from\n"
              + "		(select inicio_fila_seg.*,\n"
              + "		max(obs_fila.value_datetime) data_proximo_lev,\n"
              + "		max(obs_seguimento.value_datetime) data_proximo_seguimento,\n"
              + "		date_add(data_recepcao_levantou, interval 30 day) data_recepcao_levantou30\n"
              + "        \n"
              + "		from\n"
              + "        \n"
              + "		(select inicio.*,\n"
              + "		saida.data_estado,\n"
              + "		max_fila.data_fila,\n"
              + "		max_consulta.data_seguimento,\n"
              + "		max_recepcao.data_recepcao_levantou\n"
              + "\n"
              + "		from\n"
              + "		/* A real data de inicio de TARV do paciente Ã© a minima das primeiras ocorrencias dos conceitos de Gestao de TARV, data de inicio de TARV, inscricao no programa de tratamento e fila inicial */\n"
              + "		( Select patient_id,min(data_inicio) data_inicio\n"
              + "		from\n"
              + "		(\n"
              + "		/*Patients on ART who initiated the ARV DRUGS: ART Regimen Start Date*/\n"
              + "\n"
              + "		Select p.patient_id,min(e.encounter_datetime) data_inicio\n"
              + "		from patient p\n"
              + "		inner join encounter e on p.patient_id=e.patient_id\n"
              + "		inner join obs o on o.encounter_id=e.encounter_id\n"
              + "		where e.voided=0 and o.voided=0 and p.voided=0 and\n"
              + "		e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and\n"
              + "		e.encounter_datetime<=(:startDate  - INTERVAL 3 MONTH ) and e.location_id=:location\n"
              + "		group by p.patient_id\n"
              + "\n"
              + "		union\n"
              + "\n"
              + "		/*Patients on ART who have art start date: ART Start date*/\n"
              + "		Select p.patient_id,min(value_datetime) data_inicio\n"
              + "		from patient p\n"
              + "		inner join encounter e on p.patient_id=e.patient_id\n"
              + "		inner join obs o on e.encounter_id=o.encounter_id\n"
              + "		where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and\n"
              + "		o.concept_id=1190 and o.value_datetime is not null and\n"
              + "		o.value_datetime<=(:startDate  - INTERVAL 3 MONTH ) and e.location_id=:location\n"
              + "		group by p.patient_id\n"
              + "\n"
              + "		union\n"
              + "\n"
              + "		/*Patients enrolled in ART Program: OpenMRS Program*/\n"
              + "		select pg.patient_id,min(date_enrolled) data_inicio\n"
              + "		from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
              + "		where pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=(:startDate  - INTERVAL 3 MONTH ) and location_id=:location\n"
              + "		group by pg.patient_id\n"
              + "\n"
              + "		union\n"
              + "\n"
              + "\n"
              + "		/*Patients with first drugs pick up date set in Pharmacy: First ART Start Date*/\n"
              + "		 SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio\n"
              + "		 FROM patient p\n"
              + "		inner join encounter e on p.patient_id=e.patient_id\n"
              + "		 WHERE p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=(:startDate  - INTERVAL 3 MONTH ) and e.location_id=:location\n"
              + "		 GROUP BY p.patient_id\n"
              + "		 \n"
              + "		union\n"
              + "\n"
              + "		/*Patients with first drugs pick up date set: Recepcao Levantou ARV*/\n"
              + "		Select p.patient_id,min(value_datetime) data_inicio\n"
              + "		from patient p\n"
              + "		inner join encounter e on p.patient_id=e.patient_id\n"
              + "		inner join obs o on e.encounter_id=o.encounter_id\n"
              + "		where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and\n"
              + "		o.concept_id=23866 and o.value_datetime is not null and\n"
              + "		o.value_datetime<=(:startDate  - INTERVAL 3 MONTH ) and e.location_id=:location\n"
              + "		group by p.patient_id\n"
              + "\n"
              + "\n"
              + "\n"
              + "		) inicio_real\n"
              + "		group by patient_id\n"
              + "		)inicio\n"
              + "		\n"
              + "		left join\n"
              + "		(\n"
              + "		select patient_id,max(data_estado) data_estado\n"
              + "		from\n"
              + "		(\n"
              + "		/*Estado no programa*/\n"
              + "		select maxEstado.patient_id,\n"
              + "		maxEstado.data_estado\n"
              + "		from\n"
              + "		(\n"
              + "		select pg.patient_id,max(ps.start_date) data_estado\n"
              + "		from   patient p\n"
              + "		inner join patient_program pg on p.patient_id=pg.patient_id\n"
              + "		inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
              + "		where pg.voided=0 and ps.voided=0 and p.voided=0 and\n"
              + "		pg.program_id=2 and ps.start_date<=:endDate and pg.location_id=:location\n"
              + "		group by p.patient_id\n"
              + "		) maxEstado\n"
              + "		inner join patient_program pg2 on pg2.patient_id=maxEstado.patient_id\n"
              + "		inner join patient_state ps2 on pg2.patient_program_id=ps2.patient_program_id\n"
              + "		where pg2.voided=0 and ps2.voided=0 and pg2.program_id=2 and\n"
              + "		ps2.start_date=maxEstado.data_estado and pg2.location_id=:location and ps2.state in (7,8,10)\n"
              + "\n"
              + "\n"
              + "\n"
              + "		union\n"
              + "\n"
              + "		/*Estado no estado de permanencia da Ficha Resumo, Ficha Clinica*/\n"
              + "		select p.patient_id,\n"
              + "		max(o.obs_datetime) data_estado\n"
              + "		from patient p\n"
              + "		inner join encounter e on p.patient_id=e.patient_id\n"
              + "		inner join obs  o on e.encounter_id=o.encounter_id\n"
              + "		where e.voided=0 and o.voided=0 and p.voided=0 and\n"
              + "		e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and  \n"
              + "		o.obs_datetime<=:endDate and e.location_id=:location\n"
              + "		group by p.patient_id\n"
              + "\n"
              + "		union\n"
              + "\n"
              + "		/*Obito demografico*/\n"
              + "\n"
              + "		select person_id as patient_id,death_date as data_estado\n"
              + "		from person\n"
              + "		where dead=1 and death_date is not null and death_date<=:endDate\n"
              + "\n"
              + "		union\n"
              + "\n"
              + "		/*Obito na ficha de busca*/\n"
              + "		select p.patient_id,\n"
              + "		max(obsObito.obs_datetime) data_estado\n"
              + "		from patient p\n"
              + "		inner join encounter e on p.patient_id=e.patient_id\n"
              + "		inner join obs obsObito on e.encounter_id=obsObito.encounter_id\n"
              + "		where e.voided=0 and p.voided=0 and obsObito.voided=0 and\n"
              + "		e.encounter_type in (21,36,37) and  e.encounter_datetime<=:endDate and  e.location_id=:location and\n"
              + "		obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366\n"
              + "		group by p.patient_id\n"
              + "        \n"
              + "		) allSaida\n"
              + "		group by patient_id\n"
              + "		) saida on inicio.patient_id=saida.patient_id\n"
              + "		\n"
              + "		left join\n"
              + "		( Select p.patient_id,max(encounter_datetime) data_fila\n"
              + "		from patient p\n"
              + "		inner join encounter e on e.patient_id=p.patient_id\n"
              + "		where p.voided=0 and e.voided=0 and e.encounter_type=18 and\n"
              + "		e.location_id=:location and e.encounter_datetime<=:endDate\n"
              + "		group by p.patient_id\n"
              + "		) max_fila on inicio.patient_id=max_fila.patient_id\n"
              + "	\n"
              + "		left join\n"
              + "		( Select p.patient_id,max(encounter_datetime) data_seguimento\n"
              + "		from patient p\n"
              + "		inner join encounter e on e.patient_id=p.patient_id\n"
              + "		where p.voided=0 and e.voided=0 and e.encounter_type in (6,9) and\n"
              + "		e.location_id=:location and e.encounter_datetime<=:endDate\n"
              + "		group by p.patient_id\n"
              + "		) max_consulta on inicio.patient_id=max_consulta.patient_id\n"
              + "		left join\n"
              + "		(\n"
              + "		Select p.patient_id,max(value_datetime) data_recepcao_levantou\n"
              + "		from patient p\n"
              + "		inner join encounter e on p.patient_id=e.patient_id\n"
              + "		inner join obs o on e.encounter_id=o.encounter_id\n"
              + "		where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and\n"
              + "		o.concept_id=23866 and o.value_datetime is not null and\n"
              + "		o.value_datetime<=:endDate and e.location_id=:location\n"
              + "		group by p.patient_id\n"
              + "		) max_recepcao on inicio.patient_id=max_recepcao.patient_id\n"
              + "		group by inicio.patient_id\n"
              + "		) inicio_fila_seg\n"
              + "		\n"
              + "		left join\n"
              + "		obs obs_fila on obs_fila.person_id=inicio_fila_seg.patient_id\n"
              + "		and obs_fila.voided=0\n"
              + "		and obs_fila.obs_datetime=inicio_fila_seg.data_fila\n"
              + "		and obs_fila.concept_id=5096\n"
              + "		and obs_fila.location_id=:location\n"
              + "		\n"
              + "		left join\n"
              + "		obs obs_seguimento on obs_seguimento.person_id=inicio_fila_seg.patient_id\n"
              + "		and obs_seguimento.voided=0\n"
              + "		and obs_seguimento.obs_datetime=inicio_fila_seg.data_seguimento\n"
              + "		and obs_seguimento.concept_id=1410\n"
              + "		and obs_seguimento.location_id=:location\n"
              + "		group by inicio_fila_seg.patient_id\n"
              + "		) inicio_fila_seg_prox\n"
              + "		group by patient_id\n"
              + "		) coorte12meses_final\n"
              + "		inner join person p on p.person_id=coorte12meses_final.patient_id and  (p.birthdate is not null and timestampdiff(year,p.birthdate,:endDate) >= 2	)   \n"
              + "		left join\n"
              + "		( select pad1.*\n"
              + "		from person_address pad1\n"
              + "		inner join\n"
              + "		(\n"
              + "		select person_id,min(person_address_id) id\n"
              + "		from person_address\n"
              + "		where voided=0\n"
              + "		group by person_id\n"
              + "		) pad2\n"
              + "		where pad1.person_id=pad2.person_id and pad1.person_address_id=pad2.id\n"
              + "		) pad3 on pad3.person_id=coorte12meses_final.patient_id\n"
              + "		left join\n"
              + "		( select pn1.*\n"
              + "		from person_name pn1\n"
              + "		inner join\n"
              + "		(\n"
              + "		select person_id,min(person_name_id) id\n"
              + "		from person_name\n"
              + "		where voided=0\n"
              + "		group by person_id\n"
              + "		) pn2\n"
              + "		where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
              + "		) pn on pn.person_id=coorte12meses_final.patient_id\n"
              + "		left join\n"
              + "		(   select pid1.*\n"
              + "		from patient_identifier pid1\n"
              + "		inner join\n"
              + "		(\n"
              + "		select patient_id,min(patient_identifier_id) id\n"
              + "		from patient_identifier\n"
              + "		where voided=0\n"
              + "		group by patient_id\n"
              + "		) pid2\n"
              + "		where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
              + "		) pid on pid.patient_id=coorte12meses_final.patient_id\n"
              + "		left join\n"
              + "		(\n"
              + "		select ultimo_lev.patient_id,\n"
              + "        ultimo_lev.encounter_datetime as max_date,\n"
              + "		case o.value_coded\n"
              + "		when 1703 then 'AZT+3TC+EFV'\n"
              + "		when 6100 then 'AZT+3TC+LPV/r'\n"
              + "		when 1651 then 'AZT+3TC+NVP'\n"
              + "		when 6324 then 'TDF+3TC+EFV'\n"
              + "		when 6104 then 'ABC+3TC+EFV'\n"
              + "		when 23784 then 'TDF+3TC+DTG'\n"
              + "		when 23785 then 'TDF+3TC+DTG'\n"
              + "		when 23786 then 'ABC+3TC+DTG'\n"
              + "		when 6116 then 'AZT+3TC+ABC'\n"
              + "		when 6106 then 'ABC+3TC+LPV/r'\n"
              + "		when 6105 then 'ABC+3TC+NVP'\n"
              + "		when 6108 then 'TDF+3TC+LPV/r'\n"
              + "		when 23790 then 'TDF+3TC+LPV/r+RTV'\n"
              + "		when 23791 then 'TDF+3TC+ATV/r'\n"
              + "		when 23792 then 'ABC+3TC+ATV/r'\n"
              + "		when 23793 then 'AZT+3TC+ATV/r'\n"
              + "		when 23795 then 'ABC+3TC+ATV/r+RAL'\n"
              + "		when 23796 then 'TDF+3TC+ATV/r+RAL'\n"
              + "		when 23801 then 'AZT+3TC+RAL'\n"
              + "		when 23802 then 'AZT+3TC+DRV/r'\n"
              + "		when 23815 then 'AZT+3TC+DTG'\n"
              + "		when 6329 then 'TDF+3TC+RAL+DRV/r'\n"
              + "		when 23797 then 'ABC+3TC+DRV/r+RAL'\n"
              + "		when 23798 then '3TC+RAL+DRV/r'\n"
              + "		when 23803 then 'AZT+3TC+RAL+DRV/r'\n"
              + "		when 6243 then 'TDF+3TC+NVP'\n"
              + "		when 6103 then 'D4T+3TC+LPV/r'\n"
              + "		when 792 then 'D4T+3TC+NVP'\n"
              + "		when 1827 then 'D4T+3TC+EFV'\n"
              + "		when 6102 then 'D4T+3TC+ABC'\n"
              + "		when 1311 then 'ABC+3TC+LPV/r'\n"
              + "		when 1312 then 'ABC+3TC+NVP'\n"
              + "		when 1313 then 'ABC+3TC+EFV'\n"
              + "		when 1314 then 'AZT+3TC+LPV/r'\n"
              + "		when 1315 then 'TDF+3TC+EFV'\n"
              + "		when 6330 then 'AZT+3TC+RAL+DRV/r'\n"
              + "		when 6325 then 'D4T+3TC+ABC+LPV/r'\n"
              + "		when 6326 then 'AZT+3TC+ABC+LPV/r'\n"
              + "		when 6327 then 'D4T+3TC+ABC+EFV'\n"
              + "		when 6328 then 'AZT+3TC+ABC+EFV'\n"
              + "		when 6109 then 'AZT+DDI+LPV/r'\n"
              + "		when 21163 then 'AZT+3TC+LPV/r'\n"
              + "		when 23799 then 'TDF+3TC+DTG'\n"
              + "		when 23800 then 'ABC+3TC+DTG'\n"
              + "		when 6110 then 'D4T20+3TC+NVP'\n"
              + "		when 1702 then 'AZT+3TC+NFV'\n"
              + "		when 817  then 'AZT+3TC+ABC'\n"
              + "		when 6244 then 'AZT+3TC+RTV'\n"
              + "		when 1700 then 'AZT+DDl+NFV'\n"
              + "		when 633  then 'EFV'\n"
              + "		when 625  then 'D4T'\n"
              + "		when 631  then 'NVP'\n"
              + "		when 628  then '3TC'\n"
              + "		when 635  then 'NFV'\n"
              + "		when 797  then 'AZT'\n"
              + "		when 814  then 'ABC'\n"
              + "		when 6107 then 'TDF+AZT+3TC+LPV/r'\n"
              + "		when 6236 then 'D4T+DDI+RTV-IP'\n"
              + "		when 1701 then 'ABC+DDI+NFV'\n"
              + "		when 6114 then '3DFC'\n"
              + "		when 6115 then '2DFC+EFV'\n"
              + "		when 6233 then 'AZT+3TC+DDI+LPV'\n"
              + "		when 6234 then 'ABC+TDF+LPV'\n"
              + "		when 6242 then 'D4T+DDI+NVP'\n"
              + "        when 165262 then 'ABC+3TC+RAL'\n"
              + "        when 165261 then 'TDF+3TC+RAL'\n"
              + "        when 165330 then 'ATV/r+TDF+3TC+DTG'\n"
              + "		when 6118 then 'DDI50+ABC+LPV'\n"
              + "		else 'OUTRO' end as ultimo_regime,\n"
              + "		ultimo_lev.encounter_datetime data_regime\n"
              + "		from obs o,\n"
              + "		( select p.patient_id,max(encounter_datetime) as encounter_datetime\n"
              + "		from patient p\n"
              + "		inner join encounter e on p.patient_id=e.patient_id\n"
              + "		where encounter_type=18 and e.voided=0 and\n"
              + "		encounter_datetime <=:endDate and e.location_id=:location and p.voided=0\n"
              + "		group by patient_id\n"
              + "		) ultimo_lev\n"
              + "		where o.person_id=ultimo_lev.patient_id and o.obs_datetime=ultimo_lev.encounter_datetime and o.voided=0 and\n"
              + "		o.concept_id=1088 and o.location_id=:location\n"
              + "		) regimeFila on regimeFila.patient_id=coorte12meses_final.patient_id\n"
              + "                left join (\n"
              + "                    SELECT\n"
              + "                        e.patient_id,\n"
              + "                        MAX(e.encounter_datetime) AS max_date,\n"
              + "                        d.name as medicamento\n"
              + "                    FROM\n"
              + "                        patient p\n"
              + "                        inner join encounter e on p.patient_id = e.patient_id\n"
              + "                        inner join obs o on o.encounter_id = e.encounter_id\n"
              + "                        inner join drug d on d.drug_id = o.value_drug\n"
              + "                    WHERE\n"
              + "                        p.voided = 0\n"
              + "                        and e.encounter_type = 18\n"
              + "                        AND e.voided = 0\n"
              + "                        and o.concept_id = 165256\n"
              + "                        AND o.value_drug in (51, 52)\n"
              + "                        and o.voided = 0\n"
              + "                        and e.encounter_datetime <= :endDate\n"
              + "                        and e.location_id = :location\n"
              + "                    GROUP BY\n"
              + "                        p.patient_id\n"
              + "                ) med on med.patient_id = coorte12meses_final.patient_id\n"
              + "                and med.max_date = regimeFila.max_date      \n"
              + "        \n"
              + "left join (\n"
              + "    select\n"
              + "        sector_inicial.patient_id,\n"
              + "        case\n"
              + "            o.value_coded\n"
              + "            when 1414 then 'TB'\n"
              + "            when 1987 then 'SAAJ'\n"
              + "            when 1985 then 'CPN/G'\n"
              + "            when 1872 then 'CCR/L'\n"
              + "            when 21275 then 'Clinica'\n"
              + "            else ''\n"
              + "        end as sector\n"
              + "    from\n"
              + "        obs o,\n"
              + "        (\n"
              + "            select\n"
              + "                p.patient_id,\n"
              + "                max(encounter_datetime) as encounter_datetime\n"
              + "            from\n"
              + "                patient p\n"
              + "                inner join encounter e on p.patient_id = e.patient_id\n"
              + "            where\n"
              + "                encounter_type = 53\n"
              + "                and e.voided = 0\n"
              + "                and encounter_datetime <= :endDate\n"
              + "                and e.location_id = :location\n"
              + "                and p.voided = 0\n"
              + "            group by\n"
              + "                patient_id\n"
              + "        ) sector_inicial\n"
              + "    where\n"
              + "        o.person_id = sector_inicial.patient_id\n"
              + "        and o.obs_datetime = sector_inicial.encounter_datetime\n"
              + "        and o.voided = 0\n"
              + "        and o.concept_id = 23783\n"
              + "        and o.location_id = :location\n"
              + "    group by\n"
              + "        patient_id\n"
              + ") sector on sector.patient_id = coorte12meses_final.patient_id\n"
              + "\n"
              + "		left join\n"
              + "		(\n"
              + "		Select p.patient_id,max(o.obs_datetime) data_carga\n"
              + "		from patient p\n"
              + "					 inner join encounter e on p.patient_id=e.patient_id\n"
              + "					 inner join obs o on e.encounter_id=o.encounter_id\n"
              + "				where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,51,6,9) and  \n"
              + "		o.concept_id in (856,1305) and  o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and\n"
              + "		e.location_id=:location\n"
              + "		group by p.patient_id\n"
              + "\n"
              + "		) carga_viral on carga_viral.patient_id=coorte12meses_final.patient_id\n"
              + "		left join\n"
              + "		(\n"
              + "select 	\n"
              + "		carga_viral.patient_id, \n"
              + "		carga_viral.Valor_carga,\n"
              + "        carga_viral.data_carga\n"
              + "        \n"
              + "		\n"
              + "\n"
              + "from 	\n"
              + "(\n"
              + "	 select ultima_carga.patient_id,ultima_carga.data_carga,\n"
              + "     if(obs.value_numeric is null or obs.value_numeric<0,'Indetectavel',obs.value_numeric)  Valor_carga, \n"
              + "			ultima_carga.encounter_type,\n"
              + "			obs.creator,\n"
              + "			obs.date_created data_registo\n"
              + "	 from 		\n"
              + "		( \n"
              + "			Select p.patient_id,max(o.obs_datetime) data_carga, e.encounter_type\n"
              + "			from 	patient p \n"
              + "					inner join encounter e on p.patient_id=e.patient_id \n"
              + "					inner join obs o on e.encounter_id=o.encounter_id \n"
              + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,51,6,9) and  o.concept_id in (856,1305) and  \n"
              + "					o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and e.location_id=:location\n"
              + "			group by p.patient_id\n"
              + "		) ultima_carga \n"
              + "			inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga \n"
              + "		where obs.voided=0 and ((obs.concept_id=856) or obs.concept_id=1305)  and obs.location_id=:location\n"
              + ") carga_viral\n"
              + "inner join encounter_type et on et.encounter_type_id=carga_viral.encounter_type\n"
              + "group by carga_viral.patient_id) ultima_cv on ultima_cv.patient_id=coorte12meses_final.patient_id and ultima_cv.data_carga =carga_viral.data_carga\n"
              + "\n"
              + "    left join\n"
              + "    (\n"
              + "    Select\n"
              + "        peso_crianca.patient_id,\n"
              + "        peso_crianca.peso\n"
              + "    FROM\n"
              + "        (\n"
              + "            Select\n"
              + "                p.patient_id,\n"
              + "                o.obs_datetime,\n"
              + "                o.value_numeric peso\n"
              + "            from\n"
              + "                patient p\n"
              + "                inner join encounter e on p.patient_id = e.patient_id\n"
              + "                inner join obs o on e.encounter_id = o.encounter_id\n"
              + "            where\n"
              + "                p.voided = 0\n"
              + "                and e.voided = 0\n"
              + "                and o.voided = 0\n"
              + "                and e.encounter_type in (6, 9, 53, 51)\n"
              + "                and o.concept_id = 5089\n"
              + "                and o.obs_datetime <= :endDate\n"
              + "                and e.location_id = :location\n"
              + "        ) peso_crianca\n"
              + "        inner join (\n"
              + "            Select\n"
              + "                p.patient_id,\n"
              + "                max(o.obs_datetime) data_mx\n"
              + "            from\n"
              + "                patient p\n"
              + "                inner join encounter e on p.patient_id = e.patient_id\n"
              + "                inner join obs o on e.encounter_id = o.encounter_id\n"
              + "            where\n"
              + "                p.voided = 0\n"
              + "                and e.voided = 0\n"
              + "                and o.voided = 0\n"
              + "                and e.encounter_type in (6, 9, 53, 51)\n"
              + "                and o.concept_id = 5089\n"
              + "                and o.obs_datetime <= :endDate\n"
              + "                and e.location_id = :location\n"
              + "            group by\n"
              + "                p.patient_id\n"
              + "        ) peso_crianca_max on peso_crianca.obs_datetime = peso_crianca_max.data_mx\n"
              + "        and peso_crianca.patient_id = peso_crianca_max.patient_id\n"
              + ") peso on peso.patient_id = coorte12meses_final.patient_id\n"
              + "\n"
              + "	left join\n"
              + "               (select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'GA', NULL ) mds_gaac\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=23724 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=23724 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "       group by maxobs.patient_id)   gaac_model ON gaac_model.patient_id =coorte12meses_final.patient_id\n"
              + "       \n"
              + "\n"
              + "              LEFT JOIN (\n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'EH', NULL ) mds_eh\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165316 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165316 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "       group by maxobs.patient_id\n"
              + "\n"
              + "             	)eh_model ON eh_model.patient_id =coorte12meses_final.patient_id\n"
              + "              \n"
              + "              	LEFT JOIN (\n"
              + "\n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'CM', NULL ) mds_cm\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165265 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165265 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id                \n"
              + "                \n"
              + "             	)cm_model ON cm_model.patient_id =coorte12meses_final.patient_id\n"
              + "                \n"
              + "              \n"
              + "              \n"
              + "                \n"
              + "                \n"
              + "                LEFT JOIN (	\n"
              + "                \n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'DD', NULL ) mds_dd\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165315 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165315 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id     \n"
              + "             	)dd_model ON dd_model.patient_id =coorte12meses_final.patient_id\n"
              + "                \n"
              + "                 LEFT JOIN (\n"
              + "                 \n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'DCP', NULL ) mds_dcp\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165178 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165178 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id  \n"
              + "             	)dcp_model ON dcp_model.patient_id =coorte12meses_final.patient_id\n"
              + "                \n"
              + "                 LEFT JOIN (\n"
              + "			\n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'DCA', NULL ) mds_dca\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165179 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165179 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id \n"
              + "             	)dca_model ON dca_model.patient_id =coorte12meses_final.patient_id\n"
              + "                \n"
              + "                \n"
              + "                 LEFT JOIN (\n"
              + "                 \n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'BM', NULL ) mds_bm\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165264 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165264 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id \n"
              + "             	)bm_model ON bm_model.patient_id =coorte12meses_final.patient_id\n"
              + "            \n"
              + "				LEFT JOIN (\n"
              + "                \n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'SMI', NULL ) mds_smi\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165320 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165320 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id 			\n"
              + "             	)smi_model ON smi_model.patient_id =coorte12meses_final.patient_id\n"
              + "           \n"
              + "                LEFT JOIN (\n"
              + "                \n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'SAAJ', NULL ) mds_saaj\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165319 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165319 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id 			\n"
              + "\n"
              + "             	)saaj_model ON saaj_model.patient_id =coorte12meses_final.patient_id\n"
              + "         \n"
              + "             	LEFT JOIN (\n"
              + "                \n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'AF', NULL ) mds_af\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=23725 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=23725 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id \n"
              + "\n"
              + "             	)af_model ON af_model.patient_id =coorte12meses_final.patient_id\n"
              + "             \n"
              + "             	LEFT JOIN (\n"
              + "                \n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'CA', NULL ) mds_ca\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=23726 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=23726 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id                 \n"
              + "\n"
              + "             	)ca_model ON ca_model.patient_id =coorte12meses_final.patient_id\n"
              + "             \n"
              + "             	LEFT JOIN (\n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'CT', NULL ) mds_pu\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165318 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165318 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id \n"
              + "                        \n"
              + "                         )pu_model ON pu_model.patient_id =coorte12meses_final.patient_id\n"
              + "                         \n"
              + "                         LEFT JOIN (\n"
              + "                         \n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'TB', NULL ) mds_tb\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165317 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165317 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id \n"
              + "                         )tb_model ON tb_model.patient_id =coorte12meses_final.patient_id\n"
              + "           \n"
              + "           \n"
              + "             	LEFT JOIN (\n"
              + "\n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'FR', NULL ) mds_fr\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=23729 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=23729 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id \n"
              + "                \n"
              + "             	)fr_model ON fr_model.patient_id =coorte12meses_final.patient_id\n"
              + "              \n"
              + "             	LEFT JOIN (\n"
              + "                \n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'DT', NULL ) mds_dt\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=23730 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=23730 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id                 \n"
              + "\n"
              + "             	)dt_model ON dt_model.patient_id =coorte12meses_final.patient_id\n"
              + "             \n"
              + "             	LEFT JOIN (\n"
              + "                \n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'DC', NULL ) mds_dc\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=23731 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=23731  and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id \n"
              + "                        \n"
              + "             	)dc_model ON dc_model.patient_id =coorte12meses_final.patient_id\n"
              + "             \n"
              + "             	LEFT JOIN (\n"
              + "                \n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'DS', NULL ) mds_ds\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=23888 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=23888 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id )ds_model ON ds_model.patient_id =coorte12meses_final.patient_id\n"
              + "\n"
              + "			LEFT JOIN (\n"
              + "            \n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL,'DAH', NULL ) mds_dah\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165321 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165321 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id )dah_model ON dah_model.patient_id =coorte12meses_final.patient_id\n"
              + "          \n"
              + "			LEFT JOIN (\n"
              + "            \n"
              + "              select maxobs.patient_id, IF(maxobsdate IS NOT NULL, 'DA', NULL ) mds_da\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165314 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165314 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "						group by maxobs.patient_id )da_model ON da_model.patient_id =coorte12meses_final.patient_id\n"
              + "\n"
              + "/*Excluso: Gestante, Lactante, MDC, Infeccao Oportunista Program*/\n"
              + "left join (\n"
              + "					SELECT cv_above_1000.patient_id\n"
              + "				FROM \n"
              + "\n"
              + "				(\n"
              + "				Select p.patient_id,max(o.obs_datetime) data_carga\n"
              + "			from 	patient p \n"
              + "					inner join encounter e on p.patient_id=e.patient_id \n"
              + "					inner join obs o on e.encounter_id=o.encounter_id\n"
              + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,53,9,13,51) and  o.concept_id in (856,1305)  and  \n"
              + "					o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and e.location_id=:location\n"
              + "			group by p.patient_id) max_date_carga\n"
              + "            inner join \n"
              + "            \n"
              + "            (Select p.patient_id,max(o.obs_datetime) data_carga\n"
              + "			from 	patient p \n"
              + "					inner join encounter e on p.patient_id=e.patient_id \n"
              + "					inner join obs o on e.encounter_id=o.encounter_id\n"
              + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,53,9,13,51) and  o.concept_id = 856 and o.value_numeric>=1000 and  \n"
              + "					o.obs_datetime between date_add(date_add(:endDate, interval -12 MONTH), interval 1 day) and :endDate and e.location_id=:location\n"
              + "			group by p.patient_id) cv_above_1000 on max_date_carga.data_carga = cv_above_1000.data_carga and \n"
              + "            max_date_carga.patient_id = cv_above_1000.patient_id\n"
              + "            \n"
              + "            union\n"
              + "\n"
              + "               /*GA */\n"
              + "               select maxobs.patient_id\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=23724 and\n"
              + "						e.encounter_type in (6,9,35)and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=23724 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "       group by maxobs.patient_id                                \n"
              + "               union\n"
              + "               \n"
              + "               /*DT */\n"
              + "               select maxobs.patient_id\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=23730 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=23730 and o.voided=0 and e.encounter_type in (6,9,35)and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "       group by maxobs.patient_id\n"
              + "               union         \n"
              + "               /*DS */\n"
              + "               select maxobs.patient_id\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=23888 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=23888 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "       group by maxobs.patient_id                    \n"
              + "				union\n"
              + "                \n"
              + "                 /*DA */\n"
              + "                select maxobs.patient_id\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165314 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165314 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "       group by maxobs.patient_id                                 \n"
              + "				union\n"
              + "                 /*TB */\n"
              + "                select maxobs.patient_id\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165317 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165317 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "       group by maxobs.patient_id                  \n"
              + "\n"
              + "                 union\n"
              + "				/*SMI */    \n"
              + "                select maxobs.patient_id\n"
              + "					from\n"
              + "					( Select p.patient_id,max(e.encounter_datetime) maxobsdate\n"
              + "						from patient p\n"
              + "						inner join encounter e on p.patient_id=e.patient_id\n"
              + "						inner join obs o on e.encounter_id=o.encounter_id\n"
              + "						where p.voided=0 and e.voided=0 and o.voided=0 and concept_id=165174 and value_coded=165320 and\n"
              + "						e.encounter_type in (6,9,35) and e.encounter_datetime<=:endDate and\n"
              + "						e.location_id=:location\n"
              + "						group by p.patient_id\n"
              + "					) maxobs\n"
              + "						inner join encounter e on e.patient_id=maxobs.patient_id and maxobs.maxobsdate=e.encounter_datetime\n"
              + "						inner join obs o on o.encounter_id=e.encounter_id and maxobs.maxobsdate=o.obs_datetime\n"
              + "						where o.concept_id=165174 and o.value_coded=165320 and o.voided=0 and e.encounter_type in (6,9,35) and e.voided=0 and e.location_id=:location\n"
              + "						and  o.obs_group_id in (select obs_group_id from obs obsGrupo where obsGrupo.value_coded in (1256, 1257)\n"
              + "						and obsGrupo.voided =0 and obsGrupo.location_id=:location  and obsGrupo.obs_group_id is not null and obsGrupo.obs_datetime <= :endDate\n"
              + "						and o.encounter_id = obsGrupo.encounter_id and obsGrupo.person_id = o.person_id and  obsGrupo.obs_group_id =o.obs_group_id and obsGrupo.obs_datetime= o.obs_datetime)\n"
              + "       group by maxobs.patient_id\n"
              + "       \n"
              + "       union\n"
              + "               	\n"
              + "       \n"
              + "	Select  infeccoes.patient_id from \n"
              + "		( Select p.patient_id,max(encounter_datetime) data_seguimento\n"
              + "		from patient p\n"
              + "		inner join encounter e on e.patient_id=p.patient_id\n"
              + "		where p.voided=0 and e.voided=0 and e.encounter_type in (6) and\n"
              + "		e.location_id=:location and e.encounter_datetime<=:endDate\n"
              + "		group by p.patient_id\n"
              + "		) max_consulta inner join\n"
              + "        \n"
              + "		(select p.patient_id,\n"
              + "		max(o.obs_datetime) data_estado\n"
              + "		from patient p\n"
              + "		inner join encounter e on p.patient_id=e.patient_id\n"
              + "		inner join obs  o on e.encounter_id=o.encounter_id\n"
              + "		where e.voided=0 and o.voided=0 and p.voided=0 and\n"
              + "		e.encounter_type in (6) and o.concept_id = 1406 and\n"
              + "        o.value_coded in (3,193,5340,5334,5018,6838,6990,6783,5945,126,60,43,507,14656,7180,1570) and  \n"
              + "		o.obs_datetime<=:endDate and e.location_id=:location\n"
              + "		group by p.patient_id) infeccoes  on max_consulta.patient_id=infeccoes.patient_id and max_consulta.data_seguimento=infeccoes.data_estado\n"
              + "        group by infeccoes.patient_id\n"
              + "        \n"
              + "        union\n"
              + "	select 	pg.patient_id																						\n"
              + "		from 	patient p																													\n"
              + "				inner join patient_program pg on p.patient_id=pg.patient_id																	\n"
              + "				inner join patient_state ps on pg.patient_program_id=ps.patient_program_id													\n"
              + "		where 	pg.voided=0 and ps.voided=0 and p.voided=0 and 																				\n"
              + "				pg.program_id=5 and ps.state in (16,30) and ps.end_date is null and 														\n"
              + "				ps.start_date <=:endDate and location_id=:location																			\n"
              + "		group by pg.patient_id        \n"
              + "  \n"
              + "   union\n"
              + "        \n"
              + "	select ultimConsulta.patient_id from \n"
              + "			( Select p.patient_id,max(encounter_datetime) data_seguimento\n"
              + "			from patient p\n"
              + "			inner join encounter e on e.patient_id=p.patient_id\n"
              + "			where p.voided=0 and e.voided=0 and e.encounter_type in (6) and\n"
              + "			e.location_id=:location and e.encounter_datetime<=:endDate\n"
              + "			group by p.patient_id\n"
              + "			) max_consulta inner join (\n"
              + "            \n"
              + "			\n"
              + "					select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
              + "					from 	patient p				 \n"
              + "							inner join encounter e on p.patient_id=e.patient_id \n"
              + "							inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=23758 and obsScreen.value_coded=1065 and obsScreen.voided=0  \n"
              + "					where 	e.voided=0 and p.voided=0 and e.encounter_type=6 and e.location_id=:location and \n"
              + "							e.encounter_datetime <=:endDate\n"
              + "					group by p.patient_id\n"
              + "					\n"
              + "					union\n"
              + "		\n"
              + "					select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
              + "					from 	patient p				 \n"
              + "							inner join encounter e on p.patient_id=e.patient_id \n"
              + "							inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=1766 and obsScreen.voided=0  \n"
              + "					where 	e.voided=0 and p.voided=0 and e.encounter_type=6 and e.location_id=:location and \n"
              + "							e.encounter_datetime <=:endDate\n"
              + "					group by p.patient_id\n"
              + "					\n"
              + "					union\n"
              + "					select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
              + "					from 	patient p				 \n"
              + "							inner join encounter e on p.patient_id=e.patient_id \n"
              + "							inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=23761 and obsScreen.value_coded=1065 and obsScreen.voided=0  \n"
              + "					where 	e.voided=0 and p.voided=0 and e.encounter_type=6 and e.location_id=:location and \n"
              + "							e.encounter_datetime <=:endDate\n"
              + "					group by p.patient_id\n"
              + "                    \n"
              + "                    union\n"
              + "                    \n"
              + "					select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
              + "					from 	patient p				 \n"
              + "							inner join encounter e on p.patient_id=e.patient_id \n"
              + "							inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=1268 and obsScreen.value_coded in (1256, 1257) and obsScreen.voided=0  \n"
              + "					where 	e.voided=0 and p.voided=0 and e.encounter_type=6 and e.location_id=:location and \n"
              + "							e.encounter_datetime <=:endDate\n"
              + "					group by p.patient_id\n"
              + "                    union\n"
              + "				select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
              + "				from 	patient p				 \n"
              + "						inner join encounter e on p.patient_id=e.patient_id \n"
              + "						inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=1982 and obsScreen.value_coded=1065 and obsScreen.voided=0  \n"
              + "				where 	e.voided=0 and p.voided=0 and e.encounter_type in (6) and e.location_id=:location and \n"
              + "						e.encounter_datetime <=:endDate\n"
              + "						group by p.patient_id\n"
              + "					union\n"
              + "			\n"
              + "                    	select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
              + "					from 	patient p				 \n"
              + "							inner join encounter e on p.patient_id=e.patient_id \n"
              + "							inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=6332 and obsScreen.value_coded=1065 and obsScreen.voided=0  \n"
              + "					where 	e.voided=0 and p.voided=0 and e.encounter_type in (6) and e.location_id=:location and \n"
              + "							e.encounter_datetime <=:endDate\n"
              + "                            group by p.patient_id\n"
              + "                            \n"
              + "					union\n"
              + "                    \n"
              + "                     	select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
              + "					from 	patient p				 \n"
              + "							inner join encounter e on p.patient_id=e.patient_id \n"
              + "							inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=23739 and obsScreen.value_coded=23720 and obsScreen.voided=0  \n"
              + "					where 	e.voided=0 and p.voided=0 and e.encounter_type in (6) and e.location_id=:location and \n"
              + "							e.encounter_datetime <=:endDate\n"
              + "                            group by p.patient_id\n"
              + "                    union        \n"
              + "                     	select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
              + "					from 	patient p				 \n"
              + "							inner join encounter e on p.patient_id=e.patient_id \n"
              + "							inner join obs obsScreen on obsScreen.encounter_id=e.encounter_id and obsScreen.concept_id=23739 and obsScreen.value_coded=23888 and obsScreen.voided=0  \n"
              + "					where 	e.voided=0 and p.voided=0 and e.encounter_type in (6) and e.location_id=:location and \n"
              + "							e.encounter_datetime <=:endDate\n"
              + "                            group by p.patient_id\n"
              + "				\n"
              + "		) ultimConsulta  on max_consulta.patient_id=ultimConsulta.patient_id and max_consulta.data_seguimento=ultimConsulta.encounter_datetime\n"
              + "        group by ultimConsulta.patient_id    \n"
              + "        \n"
              + "\n"
              + ") exclusao on exclusao.patient_id=coorte12meses_final.patient_id\n"
              + "\n"
              + "left join \n"
              + "	(	SELECT pa.person_id patient_id, pa.value patient_contact FROM person_attribute pa\n"
              + "                     WHERE pa.person_attribute_type_id = 9\n"
              + "                   GROUP BY pa.person_id\n"
              + "           	)patient_contact ON patient_contact.patient_id = coorte12meses_final.patient_id\n"
              + "            \n"
              + "left join \n"
              + "	(	SELECT pa.person_id patient_id, pa.value patient_contact FROM person_attribute pa\n"
              + "                     WHERE pa.person_attribute_type_id = 30\n"
              + "                   GROUP BY pa.person_id\n"
              + "           	)patient_contact2 ON patient_contact2.patient_id = coorte12meses_final.patient_id\n"
              + "            \n"
              + "		where (data_estado is null or (data_estado is not null and  data_usar_c>data_estado)) and date_add(data_usar, interval 28 day) >=:endDate and    exclusao.patient_id is null \n"
              + "		group by patient_id";
      return query;
    }
  }
}
