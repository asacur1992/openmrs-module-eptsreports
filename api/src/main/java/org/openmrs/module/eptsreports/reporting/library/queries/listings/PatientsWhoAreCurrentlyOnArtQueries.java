/** */
package org.openmrs.module.eptsreports.reporting.library.queries.listings;

/** @author Stélio Moiane */
public interface PatientsWhoAreCurrentlyOnArtQueries {

  class QUERY {
    public static final String patientsWhoAreCurrentlyOnArtList =
        "select 	coorte12meses_final.patient_id,\n"
            + "		coorte12meses_final.data_inicio,\n"
            + "		pad3.county_district as 'Distrito',\n"
            + "		pad3.address2 as 'PAdministrativo',\n"
            + "		pad3.address6 as 'Localidade',\n"
            + "		pad3.address5 as 'Bairro',\n"
            + "		pad3.address1 as 'PontoReferencia',\n"
            + "		concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as 'NomeCompleto',\n"
            + "		pid.identifier as NID,\n"
            + "		p.gender,\n"
            + "		round(datediff(:endDate,p.birthdate)/365) idade_actual,\n"
            + "		coorte12meses_final.data_usar_c as ultimo_levantamento,\n"
            + "		coorte12meses_final.data_usar as proximo_marcado,\n"
            + "		regime.ultimo_regime,\n"
            + "		regime.data_regime,\n"
            + "		if(programa.patient_id is null,'NAO','SIM') inscrito_programa,\n"
            + "		if(gaaac.member_id is null,'NÃO','SIM') emgaac,\n"
            + "		coorte12meses_final.data_fila,\n"
            + "		coorte12meses_final.data_seguimento,\n"
            + "		coorte12meses_final.data_recepcao_levantou,\n"
            + "		coorte12meses_final.data_proximo_lev,\n"
            + "		coorte12meses_final.data_proximo_seguimento,\n"
            + "		coorte12meses_final.data_recepcao_levantou30,\n"
            + "		finalkptable.keypop,\n"
            + "		finalkptable.data_keypop,\n"
            + "		finalkptable.fonte\n"
            + "from \n"
            + "(select   	inicio_fila_seg_prox.*,\n"
            + "			GREATEST(COALESCE(data_fila,data_seguimento,data_recepcao_levantou),COALESCE(data_seguimento,data_fila,data_recepcao_levantou),COALESCE(data_recepcao_levantou,data_seguimento,data_fila))  data_usar_c,\n"
            + "GREATEST(COALESCE(data_proximo_lev,data_proximo_seguimento,data_recepcao_levantou30),COALESCE(data_proximo_seguimento,data_proximo_lev,data_recepcao_levantou30),COALESCE(data_recepcao_levantou30,data_proximo_seguimento,data_proximo_lev)) data_usar\n"
            + "\n"
            + "from\n"
            + "(select 	inicio_fila_seg.*,\n"
            + "		max(obs_fila.value_datetime) data_proximo_lev,\n"
            + "		max(obs_seguimento.value_datetime) data_proximo_seguimento,\n"
            + "		date_add(data_recepcao_levantou, interval 30 day) data_recepcao_levantou30\n"
            + "from\n"
            + "(select inicio.*,		\n"
            + "		saida.data_estado,		\n"
            + "		max_fila.data_fila,\n"
            + "		max_consulta.data_seguimento,\n"
            + "		max_recepcao.data_recepcao_levantou\n"
            + "		\n"
            + "from\n"
            + "(	Select patient_id,min(data_inicio) data_inicio\n"
            + "		from\n"
            + "			(	\n"
            + "				Select 	p.patient_id,min(e.encounter_datetime) data_inicio\n"
            + "				from 	patient p \n"
            + "						inner join encounter e on p.patient_id=e.patient_id	\n"
            + "						inner join obs o on o.encounter_id=e.encounter_id\n"
            + "				where 	e.voided=0 and o.voided=0 and p.voided=0 and \n"
            + "						e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and \n"
            + "						e.encounter_datetime<=:endDate and e.location_id=:location\n"
            + "				group by p.patient_id\n"
            + "		\n"
            + "				union\n"
            + "		\n"
            + "				Select 	p.patient_id,min(value_datetime) data_inicio\n"
            + "				from 	patient p\n"
            + "						inner join encounter e on p.patient_id=e.patient_id\n"
            + "						inner join obs o on e.encounter_id=o.encounter_id\n"
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and \n"
            + "						o.concept_id=1190 and o.value_datetime is not null and \n"
            + "						o.value_datetime<=:endDate and e.location_id=:location\n"
            + "				group by p.patient_id\n"
            + "\n"
            + "				union\n"
            + "\n"
            + "				select 	pg.patient_id,min(date_enrolled) data_inicio\n"
            + "				from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
            + "				where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate and location_id=:location\n"
            + "				group by pg.patient_id\n"
            + "				\n"
            + "				union\n"
            + "				\n"
            + "				  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio \n"
            + "				  FROM 		patient p\n"
            + "							inner join encounter e on p.patient_id=e.patient_id\n"
            + "				  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=:endDate and e.location_id=:location\n"
            + "				  GROUP BY 	p.patient_id\n"
            + "			  \n"
            + "				union\n"
            + "				\n"
            + "				Select 	p.patient_id,min(value_datetime) data_inicio\n"
            + "				from 	patient p\n"
            + "						inner join encounter e on p.patient_id=e.patient_id\n"
            + "						inner join obs o on e.encounter_id=o.encounter_id\n"
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and \n"
            + "						o.concept_id=23866 and o.value_datetime is not null and \n"
            + "						o.value_datetime<=:endDate and e.location_id=:location\n"
            + "				group by p.patient_id	\n"
            + "\n"
            + "\n"
            + "\n"
            + "			) inicio_real\n"
            + "		group by patient_id\n"
            + ")inicio\n"
            + "left join\n"
            + "(\n"
            + "	select patient_id,max(data_estado) data_estado\n"
            + "	from \n"
            + "		(\n"
            + "			select 	pg.patient_id,\n"
            + "					max(ps.start_date) data_estado\n"
            + "			from 	patient p \n"
            + "					inner join patient_program pg on p.patient_id=pg.patient_id\n"
            + "					inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
            + "			where 	pg.voided=0 and ps.voided=0 and p.voided=0 and \n"
            + "					pg.program_id=2 and ps.state in (7,8,10) and ps.end_date is null and \n"
            + "					ps.start_date<=:endDate and location_id=:location\n"
            + "			group by pg.patient_id\n"
            + "			\n"
            + "			union\n"
            + "\n"
            + "			select 	p.patient_id,\n"
            + "					max(o.obs_datetime) data_estado\n"
            + "			from 	patient p \n"
            + "					inner join encounter e on p.patient_id=e.patient_id\n"
            + "					inner join obs  o on e.encounter_id=o.encounter_id\n"
            + "			where 	e.voided=0 and o.voided=0 and p.voided=0 and \n"
            + "					e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and  \n"
            + "					o.obs_datetime<=:endDate and e.location_id=:location\n"
            + "			group by p.patient_id\n"
            + "			\n"
            + "			union\n"
            + "			\n"
            + "			select person_id as patient_id,death_date as data_estado\n"
            + "			from person \n"
            + "			where dead=1 and death_date is not null and death_date<=:endDate\n"
            + "					\n"
            + "			union\n"
            + "			\n"
            + "			select 	p.patient_id,\n"
            + "					max(obsObito.obs_datetime) data_estado\n"
            + "			from 	patient p \n"
            + "					inner join encounter e on p.patient_id=e.patient_id\n"
            + "					inner join obs obsObito on e.encounter_id=obsObito.encounter_id\n"
            + "			where 	e.voided=0 and p.voided=0 and obsObito.voided=0 and \n"
            + "					e.encounter_type in (21,36,37) and  e.encounter_datetime<=:endDate and  e.location_id=:location and \n"
            + "					obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366	\n"
            + "			group by p.patient_id\n"
            + "		) allSaida\n"
            + "	group by patient_id			\n"
            + ") saida on inicio.patient_id=saida.patient_id\n"
            + "left join\n"
            + "(	Select 	p.patient_id,max(encounter_datetime) data_fila\n"
            + "	from 	patient p \n"
            + "			inner join encounter e on e.patient_id=p.patient_id\n"
            + "	where 	p.voided=0 and e.voided=0 and e.encounter_type=18 and \n"
            + "			e.location_id=:location and e.encounter_datetime<=:endDate\n"
            + "	group by p.patient_id\n"
            + ") max_fila on inicio.patient_id=max_fila.patient_id	\n"
            + "left join\n"
            + "(	Select 	p.patient_id,max(encounter_datetime) data_seguimento\n"
            + "	from 	patient p \n"
            + "			inner join encounter e on e.patient_id=p.patient_id\n"
            + "	where 	p.voided=0 and e.voided=0 and e.encounter_type in (6,9) and \n"
            + "			e.location_id=:location and e.encounter_datetime<=:endDate\n"
            + "	group by p.patient_id\n"
            + ") max_consulta on inicio.patient_id=max_consulta.patient_id\n"
            + "left join\n"
            + "(\n"
            + "	Select 	p.patient_id,max(value_datetime) data_recepcao_levantou\n"
            + "	from 	patient p\n"
            + "			inner join encounter e on p.patient_id=e.patient_id\n"
            + "			inner join obs o on e.encounter_id=o.encounter_id\n"
            + "	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and \n"
            + "			o.concept_id=23866 and o.value_datetime is not null and \n"
            + "			o.value_datetime<=:endDate and e.location_id=:location\n"
            + "	group by p.patient_id\n"
            + ") max_recepcao on inicio.patient_id=max_recepcao.patient_id\n"
            + "group by inicio.patient_id\n"
            + ") inicio_fila_seg\n"
            + "left join\n"
            + "	obs obs_fila on obs_fila.person_id=inicio_fila_seg.patient_id\n"
            + "	and obs_fila.voided=0\n"
            + "	and obs_fila.obs_datetime=inicio_fila_seg.data_fila\n"
            + "	and obs_fila.concept_id=5096\n"
            + "	and obs_fila.location_id=:location\n"
            + "left join\n"
            + "	obs obs_seguimento on obs_seguimento.person_id=inicio_fila_seg.patient_id\n"
            + "	and obs_seguimento.voided=0\n"
            + "	and obs_seguimento.obs_datetime=inicio_fila_seg.data_seguimento\n"
            + "	and obs_seguimento.concept_id=1410\n"
            + "	and obs_seguimento.location_id=:location\n"
            + "group by inicio_fila_seg.patient_id\n"
            + ") inicio_fila_seg_prox\n"
            + "group by patient_id\n"
            + ") coorte12meses_final\n"
            + "inner join person p on p.person_id=coorte12meses_final.patient_id		\n"
            + "left join \n"
            + "(	select pad1.*\n"
            + "	from person_address pad1\n"
            + "	inner join \n"
            + "	(\n"
            + "		select person_id,min(person_address_id) id \n"
            + "		from person_address\n"
            + "		where voided=0\n"
            + "		group by person_id\n"
            + "	) pad2\n"
            + "	where pad1.person_id=pad2.person_id and pad1.person_address_id=pad2.id\n"
            + ") pad3 on pad3.person_id=coorte12meses_final.patient_id				\n"
            + "left join 			\n"
            + "(	select pn1.*\n"
            + "	from person_name pn1\n"
            + "	inner join \n"
            + "	(\n"
            + "		select person_id,min(person_name_id) id \n"
            + "		from person_name\n"
            + "		where voided=0\n"
            + "		group by person_id\n"
            + "	) pn2\n"
            + "	where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
            + ") pn on pn.person_id=coorte12meses_final.patient_id			\n"
            + "left join\n"
            + "(   select pid1.*\n"
            + "	from patient_identifier pid1\n"
            + "	inner join\n"
            + "	(\n"
            + "		select patient_id,min(patient_identifier_id) id\n"
            + "		from patient_identifier\n"
            + "		where voided=0\n"
            + "		group by patient_id\n"
            + "	) pid2\n"
            + "	where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
            + ") pid on pid.patient_id=coorte12meses_final.patient_id\n"
            + "left join\n"
            + "(\n"
            + "	select 	pg.patient_id\n"
            + "	from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
            + "	where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:endDate and location_id=:location\n"
            + ") programa on programa.patient_id=coorte12meses_final.patient_id\n"
            + "left join\n"
            + "(\n"
            + "	select distinct member_id from gaac_member where voided=0\n"
            + ") gaaac on gaaac.member_id=coorte12meses_final.patient_id\n"
            + "left join \n"
            + "(\n"
            + "	select 	ultimo_lev.patient_id,\n"
            + "			case o.value_coded				\n"
            + "			when 1703 then 'AZT+3TC+EFV'\n"
            + "			when 6100 then 'AZT+3TC+LPV/r'\n"
            + "			when 1651 then 'AZT+3TC+NVP'\n"
            + "			when 6324 then 'TDF+3TC+EFV'\n"
            + "			when 6104 then 'ABC+3TC+EFV'\n"
            + "			when 23784 then 'TDF+3TC+DTG'\n"
            + "			when 23786 then 'ABC+3TC+DTG'\n"
            + "			when 6116 then 'AZT+3TC+ABC'\n"
            + "			when 6106 then 'ABC+3TC+LPV/r'\n"
            + "			when 6105 then 'ABC+3TC+NVP'\n"
            + "			when 6108 then 'TDF+3TC+LPV/r'\n"
            + "			when 23790 then 'TDF+3TC+LPV/r+RTV'\n"
            + "			when 23791 then 'TDF+3TC+ATV/r'\n"
            + "			when 23792 then 'ABC+3TC+ATV/r'\n"
            + "			when 23793 then 'AZT+3TC+ATV/r'\n"
            + "			when 23795 then 'ABC+3TC+ATV/r+RAL'\n"
            + "			when 23796 then 'TDF+3TC+ATV/r+RAL'\n"
            + "			when 23801 then 'AZT+3TC+RAL'\n"
            + "			when 23802 then 'AZT+3TC+DRV/r'\n"
            + "			when 23815 then 'AZT+3TC+DTG'\n"
            + "			when 6329 then 'TDF+3TC+RAL+DRV/r'\n"
            + "			when 23797 then 'ABC+3TC+DRV/r+RAL'\n"
            + "			when 23798 then '3TC+RAL+DRV/r'\n"
            + "			when 23803 then 'AZT+3TC+RAL+DRV/r'						\n"
            + "			when 6243 then 'TDF+3TC+NVP'\n"
            + "			when 6103 then 'D4T+3TC+LPV/r'\n"
            + "			when 792 then 'D4T+3TC+NVP'\n"
            + "			when 1827 then 'D4T+3TC+EFV'\n"
            + "			when 6102 then 'D4T+3TC+ABC'						\n"
            + "			when 1311 then 'ABC+3TC+LPV/r'\n"
            + "			when 1312 then 'ABC+3TC+NVP'\n"
            + "			when 1313 then 'ABC+3TC+EFV'\n"
            + "			when 1314 then 'AZT+3TC+LPV/r'\n"
            + "			when 1315 then 'TDF+3TC+EFV'						\n"
            + "			when 6330 then 'AZT+3TC+RAL+DRV/r'			\n"
            + "			when 6325 then 'D4T+3TC+ABC+LPV/r'\n"
            + "			when 6326 then 'AZT+3TC+ABC+LPV/r'\n"
            + "			when 6327 then 'D4T+3TC+ABC+EFV'\n"
            + "			when 6328 then 'AZT+3TC+ABC+EFV'\n"
            + "			when 6109 then 'AZT+DDI+LPV/r'\n"
            + "			when 21163 then 'AZT+3TC+LPV/r'						\n"
            + "			when 23799 then 'TDF+3TC+DTG'\n"
            + "			when 23800 then 'ABC+3TC+DTG'				\n"
            + "			when 6110 then 'D4T20+3TC+NVP'\n"
            + "			when 1702 then 'AZT+3TC+NFV'\n"
            + "			when 817  then 'AZT+3TC+ABC'				\n"
            + "			when 6244 then 'AZT+3TC+RTV'\n"
            + "			when 1700 then 'AZT+DDl+NFV'\n"
            + "			when 633  then 'EFV'\n"
            + "			when 625  then 'D4T'\n"
            + "			when 631  then 'NVP'\n"
            + "			when 628  then '3TC'\n"
            + "			when 635  then 'NFV'\n"
            + "			when 797  then 'AZT'\n"
            + "			when 814  then 'ABC'\n"
            + "			when 6107 then 'TDF+AZT+3TC+LPV/r'\n"
            + "			when 6236 then 'D4T+DDI+RTV-IP'\n"
            + "			when 1701 then 'ABC+DDI+NFV'				\n"
            + "			when 6114 then '3DFC'\n"
            + "			when 6115 then '2DFC+EFV'\n"
            + "			when 6233 then 'AZT+3TC+DDI+LPV'\n"
            + "			when 6234 then 'ABC+TDF+LPV'\n"
            + "			when 6242 then 'D4T+DDI+NVP'\n"
            + "			when 6118 then 'DDI50+ABC+LPV'				\n"
            + "			else 'OUTRO' end as ultimo_regime,\n"
            + "			ultimo_lev.encounter_datetime data_regime\n"
            + "	from 	obs o,				\n"
            + "			(	select p.patient_id,max(encounter_datetime) as encounter_datetime\n"
            + "				from 	patient p\n"
            + "						inner join encounter e on p.patient_id=e.patient_id								\n"
            + "				where 	encounter_type in (6,9) and e.voided=0 and\n"
            + "						encounter_datetime <=:endDate and e.location_id=:location and p.voided=0\n"
            + "				group by patient_id\n"
            + "			) ultimo_lev\n"
            + "	where 	o.person_id=ultimo_lev.patient_id and o.obs_datetime=ultimo_lev.encounter_datetime and o.voided=0 and \n"
            + "			o.concept_id=1087 and o.location_id=:location\n"
            + ") regime on regime.patient_id=coorte12meses_final.patient_id\n"
            + "left join \n"
            + "(\n"
            + "		select 	patient_id,\n"
            + "			case value_coded			\n"
            + "				when 1377 then 'HSH'				\n"
            + "				when 1901 then 'MTS'				\n"
            + "				when 20426 then 'REC'				\n"
            + "				when 20454 then 'PID'\n"
            + "				when 5622 then 'OUTRO'\n"
            + "			else null end as keypop,\n"
            + "			case ordem			\n"
            + "				when 1 then 'Ficha Clinica'				\n"
            + "				when 2 then 'Ficha Apss'				\n"
            + "				when 3 then 'Demografico'\n"
            + "			else null end as fonte,\n"
            + "			obs_datetime as data_keypop\n"
            + "				\n"
            + "		from\n"
            + "		(\n"
            + "			select *\n"
            + "			from \n"
            + "			(\n"
            + "				select maxkp.patient_id, o.value_coded,o.obs_datetime,if(e.encounter_type=6,1,2) ordem\n"
            + "				from \n"
            + "				(	Select 	p.patient_id,max(e.encounter_datetime) maxkpdate\n"
            + "					from 	patient p \n"
            + "							inner join encounter e on p.patient_id=e.patient_id\n"
            + "							inner join obs o on e.encounter_id=o.encounter_id\n"
            + "					where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=23703 and \n"
            + "							e.encounter_type in (6,46,35) and e.encounter_datetime<=:endDate and \n"
            + "							e.location_id=:location\n"
            + "					group by p.patient_id\n"
            + "				) maxkp\n"
            + "				inner join encounter e on e.patient_id=maxkp.patient_id and maxkp.maxkpdate=e.encounter_datetime\n"
            + "				inner join obs o on o.encounter_id=e.encounter_id and maxkp.maxkpdate=o.obs_datetime \n"
            + "				where o.concept_id=23703 and o.voided=0 and e.encounter_type in (6,46,35) and e.voided=0 and e.location_id=:location\n"
            + "\n"
            + "				union \n"
            + "\n"
            + "				Select 	person_id,\n"
            + "						case upper(value)\n"
            + "								when 'HSM' then 1377\n"
            + "								when 'HSH' then 1377\n"
            + "								when 'MSM' then 1377\n"
            + "								when 'MTS' then 1901\n"
            + "								when 'CSW' then 1901\n"
            + "								when 'TS' then 1901\n"
            + "								when 'PRISONER' then 20426\n"
            + "								when 'REC' then 20426\n"
            + "								when 'RC' then 20426\n"
            + "								when 'PID' then 20454				\n"
            + "								else null end as estado,\n"
            + "						date(date_created),\n"
            + "						3 as ordem \n"
            + "				from 	person_attribute\n"
            + "				where 	person_attribute_type_id=24 and value is not null and value<>'' and voided=0 and date(date_created)<=:endDate\n"
            + "			) allkpsource\n"
            + "			order by patient_id,obs_datetime,ordem\n"
            + "		) allkpsorcetakefirst\n"
            + "		group by patient_id\n"
            + "	) finalkptable on finalkptable.patient_id=coorte12meses_final.patient_id\n"
            + "where (data_estado is null or (data_estado is not null and  data_usar_c>data_estado)) and date_add(data_usar, interval 28 day) >=:endDate\n"
            + "group by patient_id";
  }
}
